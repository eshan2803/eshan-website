<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commodity Transport Model | Eshan Singh</title>
  <link rel="icon" type="image/png" href="assets/fevicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: url('assets/clean-energy-background.jpg') no-repeat center center fixed;
      background-size: cover;
      background-color: #e9f5f0;
      color: #333;
    }
    .header-left h1 {
      margin: 0;
      font-size: 2rem;
    }
    .header-left p {
      margin: 0.25rem 0 0;
      color: #4b5563;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
    }
    header p { margin: 0.25rem 0 0; color: #4b5563; }
    nav {
      display: flex;
      justify-content: center;
      gap: 2rem;
      background-color: rgba(56, 142, 60, 0.9);
      padding: 1rem 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      position: relative;
    }
    nav a::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 2px;
      bottom: -2px;
      left: 0;
      background-color: white;
      transform: scaleX(0);
      transform-origin: bottom right;
      transition: transform 0.25s ease-out;
    }
    nav a:hover::after {
      transform: scaleX(1);
      transform-origin: bottom left;
    }
    nav a:hover {
      text-decoration: none;
    }
    main.container {
      max-width: 960px;
      margin: auto;
      padding: 2rem;
      background: white;
      border-radius: 0.5rem;
    }
    .input-group { margin-bottom: 1.5rem; }
    .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .input-group input, .input-group select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .input-inline { display: flex; align-items: center; gap: 0.5rem; }
    .button { background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; font-weight: 600; }
    .button:hover { background: #0056b3; }
    .hidden { display: none; }
    footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; color: #6b7280; }
    .social-links a { margin: 0 0.5rem; }
    .social-icon { width: 20px; height: 20px; }
  </style>
</head>
<body class="fade-in">
  <header style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
    <div>
      <h1 style="font-size: 3rem; font-weight: 600; margin: 0;">Dr. Eshan Singh</h1>
    </div>
    <div class="header-animation">
      <lottie-player 
        src="assets/wind-turbine.json"
        background="transparent"
        speed="1"
        style="width: 150px; height: 150px;"
        loop autoplay>
      </lottie-player>
    </div>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="energy.html">Energy Decarbonization</a>
    <a href="personal.html">Personal Musings</a>
    <a href="contact.html">Contact</a>
  </nav>

  <main class="container" style="background: rgba(255,255,255,0.92); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem; margin-top: 2rem;">
    <section>
      <h2>Commodity Transport Model</h2>
      <p>This tool allows you to calculate the energy usage, carbon footprint, and cost of transporting commodities across different global trade routes.</p>
      <p>Because the server sleeps after 30 mins of inactivity, a "Failed to Fetch" error can show up the first time you run a calculation. Simply try again and it should work.</p>
      <p>For any queries and questions email me at hello@eshansingh.xyz.</p>
      <div style="margin-bottom: 1.5rem; text-align: right;">
        <a href="transport-model-documentation.html" class="button secondary-button" target="_blank">View Documentation</a>
      </div>
      <form id="lcaForm">
        <div class="input-group">
          <label for="commodity-type">Select Commodity Category:</label>
          <select id="commodity-type" name="commodity-type" class="form-control">
            <option value="fuel" selected>Fuel</option>
            <option value="food">Food</option>
          </select>
        </div>

        <div class="input-group">
          <label for="startLocation">Start Location</label>
          <input type="text" id="startLocation" value="Los Angeles, CA">
        </div>
        <div class="input-group">
          <label for="endLocation">End Location</label>
          <input type="text" id="endLocation" value="Rotterdam, Netherlands">
        </div>


        <div id="fuel-options">
          <div class="input-group">
            <label for="fuel_type">Select Fuel:</label>
            <select id="fuel_type" name="fuel_type" class="form-control">
              <option value="0">Liquid Hydrogen</option>
              <option value="1">Ammonia</option>
              <option value="2">Methanol</option>
            </select>
          </div>
          <div class="input-group">
            <label>Boil-off Gas (BOG) Treatment</label>
            <div class="input-inline">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" id="bogExpel" name="bogTreatment" value="1" checked> Expel
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" id="bogRecirculation" name="bogTreatment" value="2"> Recirculation
              </label>
            </div>
          </div>
          <div id="bogRecirculationDetails" class="hidden input-group" style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">BOG Recirculation Details:</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div>
                <label for="bogRecirculationTruck">In-land Transport Recirculation (%)</label>
                <input type="number" id="bogRecirculationTruck" value="80">
                <label for="bogRecirculationTruckApply">Use of BOG (In-land)</label>
                <select id="bogRecirculationTruckApply">
                  <option value="1">Re-liquified</option>
                  <option value="2">Used as another energy source</option>
                </select>
              </div>
              <div>
                <label for="bogRecirculationStorage">Storage Recirculation (%)</label>
                <input type="number" id="bogRecirculationStorage" value="80">
                <label for="bogRecirculationStorageApply">Use of BOG (Storage)</label>
                <select id="bogRecirculationStorageApply">
                  <option value="1">Re-liquified</option>
                  <option value="2">Used as another energy source</option>
                </select>
              </div>
              <div>
                <label for="bogRecirculationMaritime">Maritime Transport Recirculation (%)</label>
                <input type="number" id="bogRecirculationMaritime" value="80">
                <label for="bogRecirculationMaritimeApply">Use of BOG (Maritime)</label>
                <select id="bogRecirculationMaritimeApply">
                  <option value="1">Re-liquified</option>
                  <option value="2">Used as another energy source</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="food-options" class="hidden">
                    <div class="input-group">
                        <label for="food_type">Select Food Item:</label>
                        <select id="food_type" name="food_type" class="form-control">
                            <option value="strawberry">üçì Strawberry</option>
                            <option value="hass_avocado">ü•ë Hass Avocado</option>
                            <option value="banana">üçå Banana</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="shipmentSizeContainers">Shipment Size (Number of 40ft Containers)</label>
                        <input type="number" id="shipmentSizeContainers" value="10">
                    </div>
                </div>

        <div class="input-group">
        <label for="marineFuelChoice">Marine Propulsion Fuel</label>
        <select id="marineFuelChoice">
            <option value="VLSFO">VLSFO (Conventional)</option>
            <option value="LNG">LNG (Liquefied Natural Gas)</option>
            <option value="Methanol">Methanol</option>
            <option value="Ammonia">Ammonia</option>
        </select>
        </div>
        <div class="input-group">
            <label class="input-inline" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="includeOverheads" name="includeOverheads" style="width: auto;">
                <span style="font-weight: normal;">
                    Include All Non-Energy Costs (Infrastructure CAPEX & Voyage Overheads)?
                    <a href="transport-model-documentation.html#overhead-assumptions" target="_blank" style="color: #007BFF; text-decoration: underline;">
                        Refer to Documentation.
                    </a>
                </span>
            </label>
        </div>        
        <div class="input-group" id="capacity-input-group">
          <label id="capacity-label" for="lh2PlantCapacity">LH2 Plant Capacity (TPD):</label>
          <input type="number" id="lh2PlantCapacity" value="24">
        </div>
        <div class="input-group">
          <label for="storageTimeA">Storage Time at Port Closest to Starting Point (days)</label>
          <input type="number" id="storageTimeA" value="3">
        </div>
        <div class="input-group">
          <label for="storageTimeB">Storage Time at Port Closest to Destination (days)</label>
          <input type="number" id="storageTimeB" value="3">
        </div>
        <div class="input-group">
          <label for="storageTimeC">Storage Time at the Destination (days)</label>
          <input type="number" id="storageTimeC" value="3">
        </div>
        
        <div id="ship-details-wrapper">
          <div class="input-group">
            <label for="shipArchetypeSelect">Select Ship Archetype</label>
            <select id="shipArchetypeSelect">
              <option value="custom">Build my own ship...</option>
              <option value="small">Small-Scale Carrier (20,000 m¬≥)</option>
              <option value="midsized">Midsized Carrier (90,000 m¬≥)</option>
              <option value="standard" selected>Standard Modern Carrier (174,000 m¬≥)</option>
              <option value="q-flex">Q-Flex Carrier (210,000 m¬≥)</option>
              <option value="q-max">Q-Max Carrier (266,000 m¬≥)</option>
            </select>
          </div>

          <div id="customShipDetails" class="hidden input-group" style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px; background-color: #f8f9fa;">
            <h3 style="font-size: 1.1rem; margin-top:0; margin-bottom: 1rem;">Custom Ship Details:</h3>
            <div class="input-group">
              <label for="totalShipVolume">Total Ship Cargo Volume (m¬≥)</label>
              <input type="number" id="totalShipVolume" value="174000">
            </div>
            <div class="input-group">
              <label for="shipNumberOfTanks">Number of Ship Tanks</label>
              <select id="shipNumberOfTanks">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="input-group">
              <label for="shipTankShape">Ship Tank Shape</label>
              <select id="shipTankShape">
                <option value="1">Capsule (Membrane)</option>
                <option value="2" selected>Spherical (Moss)</option>
              </select>
            </div>
          </div>
        </div>
                
        <div class="input-group">
          <button type="submit" class="button">Calculate</button>
        </div>
      </form>
      <div id="results" class="hidden" style="margin-top: 2rem;">
        <h3>Results</h3>
        <div id="outputTables"></div>
      </div>
      <div id="statusMessages" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-md text-sm text-gray-700 min-h-[50px]">Waiting for input...</div>
        <div id="outputs" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Results</h2>
            
            <div id="map" class="mb-6 shadow-md" style="height: 400px;"></div>
            
            <h3 class="text-lg font-semibold mb-3 text-gray-600">Summary Metrics (per kg fuel/food):</h3>
            <div id="summaryTableContainer" class="table-container mb-6 shadow-md"></div>
            
            <h3 class="text-lg font-semibold mb-3 text-gray-600">Summary Metrics (per GJ):</h3>
            <div id="summaryTableContainer2" class="table-container mb-6 shadow-md"></div>

            <div id="comparisonSection" class="hidden">
                <h3 class="text-lg font-semibold mb-3 text-gray-600">Shipment vs. Local Sourcing Comparison:</h3>
                <div id="comparisonTableContainer" class="table-container mb-6 shadow-md"></div>
            </div>

            <h3 class="text-lg font-semibold mb-3 text-gray-600">Assumed Prices:</h3>
            <div id="assumptionTableContainer" class="table-container mb-6 shadow-md"></div>

            <div id="greenPremiumSection" class="hidden">
                <h3 class="text-lg font-semibold mb-3 text-gray-600">Green Premium Analysis (Local vs. International)</h3>
                <div id="greenPremiumTableContainer" class="table-container mb-6 shadow-md"></div>
            </div>
            <h3 class="text-lg font-semibold mb-3 text-gray-600">Detailed Process Breakdown:</h3>
            <div id="detailedTableContainer" class="table-container mb-6 shadow-md"></div>

            <div class="charts-container" style="margin-top: 2rem;">
            <h3 class="text-lg font-semibold mb-3 text-gray-600">Cost Breakdown Chart:</h3>
            <div style="border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                <img id="costChartImg" src="" alt="Cost Breakdown Chart" style="max-width: 100%;"/>
            </div>

            <h3 class="text-lg font-semibold mb-3 text-gray-600">Emissions Breakdown Chart:</h3>
            <div style="border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px;">
                <img id="emissionChartImg" src="" alt="Emissions Breakdown Chart" style="max-width: 100%;"/>
            </div>
            </div>
            
            <div class="text-center mt-6">
            <button id="downloadCsvButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">Download Results (CSV)</button>
            </div>
        </div>      
      <div id="messageModal" class="modal">
        <div class="modal-content" style="text-align: center;">
          <p id="modalMessageText" style="margin-bottom: 1rem;"></p>
          <button id="modalCloseButton" class="modal-close-button" style="margin-bottom: 0.75rem;">OK</button>
          <p style="font-size: 0.85rem; color: #555;">
            Built by
            <a href="https://www.linkedin.com/in/jui-yang-wang0131/" target="_blank" style="color: #0073b1; text-decoration: none;">Jui-Yang Wang</a>
            and
            <a href="https://www.linkedin.com/in/eshan-singh-188b1554/" target="_blank" style="color: #0073b1; text-decoration: none;">Eshan Singh</a>
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Eshan & Associates LLC. All rights reserved.</p>
    <div class="social-links">
      <a href="https://www.linkedin.com/in/eshan-singh-188b1554/" target="_blank">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn">
      </a>
      <a href="mailto:hello@eshansingh.xyz">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/732/732200.png" alt="Email">
      </a>
      <a href="https://scholar.google.com/citations?user=VhYa_v4AAAAJ&hl=en" target="_blank">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Google Scholar">
      </a>
    </div>
  </footer>
  <script>
    const BACKEND_URL = "https://transport-model.onrender.com";
    let map;
    let completeResultsForCsv = [];

    // --- UI Element References ---
    const commoditySelector = document.getElementById('commodity-type');
    const capacityInputGroup = document.getElementById('capacity-input-group'); 
    const fuelOptionsDiv = document.getElementById('fuel-options');
    const foodOptionsDiv = document.getElementById('food-options');
    const capacityLabel = document.getElementById('capacity-label');
    const bogRecirculationDetailsPanel = document.getElementById('bogRecirculationDetails');
    const bogRecirculationRadio = document.getElementById('bogRecirculation');
    const shipDetailsWrapper = document.getElementById('ship-details-wrapper');
    const customShipDetailsPanel = document.getElementById('customShipDetails');
    const shipArchetypeSelect = document.getElementById('shipArchetypeSelect');
    
    // --- Main Function to Control UI Visibility ---
    function updateFormVisibility() {
      const selectedCommodity = commoditySelector.value;
    
      // Get all the option elements from the ship archetype dropdown
      const shipOptions = shipArchetypeSelect.options;
    
      if (selectedCommodity === 'fuel') {
        // --- SHOW FUEL SECTIONS ---
        fuelOptionsDiv.classList.remove('hidden');
        foodOptionsDiv.classList.add('hidden');
        shipDetailsWrapper.classList.remove('hidden');
        capacityInputGroup.classList.remove('hidden'); 
    
        capacityLabel.textContent = 'LH2 Plant Capacity (TPD):';
        shipOptions[1].textContent = 'Small-Scale Carrier (20,000 m¬≥)';
        shipOptions[2].textContent = 'Midsized Carrier (90,000 m¬≥)';
        shipOptions[3].textContent = 'Standard Modern Carrier (174,000 m¬≥)';
        shipOptions[4].textContent = 'Q-Flex Carrier (210,000 m¬≥)';
        shipOptions[5].textContent = 'Q-Max Carrier (266,000 m¬≥)';        
        // Handle BOG panel visibility
        if (bogRecirculationRadio.checked) {
          bogRecirculationDetailsPanel.classList.remove('hidden');
        } else {
          bogRecirculationDetailsPanel.classList.add('hidden');
        }
    
      } else if (selectedCommodity === 'food') {
        // --- SHOW FOOD SECTIONS ---
        fuelOptionsDiv.classList.add('hidden');
        foodOptionsDiv.classList.remove('hidden');
        shipDetailsWrapper.classList.remove('hidden');
    
        capacityLabel.textContent = 'Processing & Freezing Facility Capacity (Tons/Day):';
        shipOptions[1].textContent = 'Feeder Vessel (~2,000 Containers)';
        shipOptions[2].textContent = 'Midsized Vessel (~6,000 Containers)';
        shipOptions[3].textContent = 'Post-Panamax Vessel (~10,000 Containers)';
        shipOptions[4].textContent = 'New-Panamax Vessel (~14,000 Containers)';
        shipOptions[5].textContent = 'Ultra-Large Vessel (20,000+ Containers)';
      }
    
      // Handle custom ship panel visibility (this works for both fuel and food)
      if (shipArchetypeSelect.value === 'custom') {
        customShipDetailsPanel.classList.remove('hidden');
      } else {
        customShipDetailsPanel.classList.add('hidden');
      }
    }

    // --- Attach Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
      commoditySelector.addEventListener('change', updateFormVisibility);
      document.querySelectorAll('input[name="bogTreatment"]').forEach(radio => {
        radio.addEventListener('change', updateFormVisibility);
      });
      shipArchetypeSelect.addEventListener('change', updateFormVisibility);
      // Set the initial state of the form when the page loads
      updateFormVisibility();
    });

    document.getElementById('lcaForm').addEventListener('submit', handleCalculation);
    document.getElementById('downloadCsvButton').addEventListener('click', downloadCSV);

    async function handleCalculation(e) {
      e.preventDefault();
      const calculateButton = this.querySelector('button[type="submit"]');
      const statusMessagesDiv = document.getElementById('statusMessages');
      const outputsDiv = document.getElementById('outputs');

      // Helper functions for UI updates
      function logStatus(message) { statusMessagesDiv.innerHTML += `<p>> ${message}</p>`; statusMessagesDiv.scrollTop = statusMessagesDiv.scrollHeight; }
      function clearStatus() { statusMessagesDiv.innerHTML = ''; }
      function showModal(message) {
        document.getElementById('modalMessageText').textContent = message;
        document.getElementById('messageModal').style.display = "block";
      }
      document.getElementById('modalCloseButton').onclick = () => { document.getElementById('messageModal').style.display = "none"; };

      // Reset UI for new calculation
      clearStatus();
      logStatus("Collecting user inputs...");
      calculateButton.disabled = true;
      calculateButton.textContent = 'Calculating...';
      outputsDiv.classList.add('hidden');

      // Conditionally build the userInputs object
      const commodity = document.getElementById('commodity-type').value;
      const shipArchetype = document.getElementById('shipArchetypeSelect').value;
      const includeOverheads = document.getElementById('includeOverheads').checked;
      let userInputs = {
        commodity_type: commodity,
        start: document.getElementById('startLocation').value,
        end: document.getElementById('endLocation').value,
        storage_time_A: parseFloat(document.getElementById('storageTimeA').value),
        storage_time_B: parseFloat(document.getElementById('storageTimeB').value),
        storage_time_C: parseFloat(document.getElementById('storageTimeC').value),
        LH2_plant_capacity: parseFloat(document.getElementById('lh2PlantCapacity').value), // We can repurpose this input
        ship_archetype: shipArchetype,
        include_overheads: includeOverheads,
      };

      if (commodity === 'fuel') {
        // Add fuel-specific keys
        Object.assign(userInputs, {
          fuel_type: parseInt(document.getElementById('fuel_type').value),
          marine_fuel_choice: document.getElementById('marineFuelChoice').value,
          recirculation_BOG: document.querySelector('input[name="bogTreatment"]:checked').value,
          BOG_recirculation_truck: parseFloat(document.getElementById('bogRecirculationTruck').value),
          BOG_recirculation_truck_apply: document.getElementById('bogRecirculationTruckApply').value,
          BOG_recirculation_storage: parseFloat(document.getElementById('bogRecirculationStorage').value),
          BOG_recirculation_storage_apply: document.getElementById('bogRecirculationStorageApply').value,
          BOG_recirculation_mati_trans: parseFloat(document.getElementById('bogRecirculationMaritime').value),
          BOG_recirculation_mati_trans_apply: document.getElementById('bogRecirculationMaritimeApply').value,
        });
      } else if (commodity === 'food') {
        // Add food-specific keys
        Object.assign(userInputs, {
          food_type: document.getElementById('food_type').value,
          marine_fuel_choice: document.getElementById('marineFuelChoice').value,
          shipment_size_containers: parseInt(document.getElementById('shipmentSizeContainers').value)
        });
      }        

      if (shipArchetype === 'custom') {
        Object.assign(userInputs, {
          total_ship_volume: parseFloat(document.getElementById('totalShipVolume').value),
          ship_number_of_tanks: parseInt(document.getElementById('shipNumberOfTanks').value),
          ship_tank_shape: parseInt(document.getElementById('shipTankShape').value),
        });
      }

      try {
        logStatus("Sending data to the Python server... (This may take a minute)");
        const response = await fetch(`${BACKEND_URL}/calculate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userInputs)
        });
        logStatus("Waiting for response...");
        const results = await response.json();
        if (results.status === 'error') throw new Error(results.message);
        logStatus("Calculation complete. Rendering results...");
        
        const routeBounds = displayMap(results.map_data, results.food_type); 
        displayTables(results.table_data, commodity);
        completeResultsForCsv = results.csv_data; 
        if (results.charts) {
          document.getElementById('costChartImg').src = "data:image/png;base64," + results.charts.cost_chart_base64;
          document.getElementById('emissionChartImg').src = "data:image/png;base64," + results.charts.emission_chart_base64;
        }
        const comparisonSection = document.getElementById('comparisonSection');
        const comparisonContainer = document.getElementById('comparisonTableContainer');
        if (results.local_sourcing_comparison) {
            const localData = results.local_sourcing_comparison;
            const shipmentCostPerKg = results.table_data.summary1_data[0][1]; // Get shipment cost from existing summary
            const shipmentEmissionsPerKg = results.table_data.summary1_data[2][1]; // Get shipment emissions
    
            const comparisonHeaders = ['', 'International Shipment', `Local Sourcing (from ${localData.source_name})`];
            const comparisonData = [
                ['Transport Cost ($/kg)', parseFloat(shipmentCostPerKg).toFixed(2), localData.cost_per_kg.toFixed(2)],
                ['Transport Emissions (kg CO2e/kg)', parseFloat(shipmentEmissionsPerKg).toFixed(2), localData.emissions_per_kg.toFixed(2)]
            ];
    
            comparisonContainer.innerHTML = createTableHtml(comparisonHeaders, comparisonData);
            comparisonSection.classList.remove('hidden');
        } else {
            comparisonSection.classList.add('hidden');
        }

        const greenPremiumSection = document.getElementById('greenPremiumSection');
        const greenPremiumContainer = document.getElementById('greenPremiumTableContainer');
        if (results.table_data.green_premium_data) {
            greenPremiumContainer.innerHTML = createTableHtml(
                results.table_data.green_premium_headers,
                results.table_data.green_premium_data
            );
            greenPremiumSection.classList.remove('hidden');
        } else {
            greenPremiumSection.classList.add('hidden');
        }        

        outputsDiv.classList.remove('hidden');
        setTimeout(() => {
          map.invalidateSize();
          if (routeBounds && routeBounds.isValid()) {
            map.fitBounds(routeBounds.pad(0.1));
          }
        }, 1);
      } catch (error) {
        logStatus(`Error: ${error.message}`);
        showModal(`An error occurred: ${error.message}.`);
      } finally {
        calculateButton.disabled = false;
        calculateButton.textContent = 'Calculate';
      }
    }

    function displayMap(mapData, foodType) {
        console.log("displayMap called with data:", mapData);
        if (map) { // 'map' is your global Leaflet instance
            map.remove();
            console.log("Previous map instance removed.");
        }

        if (!mapData || !mapData.coor_start || typeof mapData.coor_start.lat !== 'number' || typeof mapData.coor_start.lng !== 'number') {
            console.error("Map data or coor_start is invalid or missing. Cannot render map.", mapData);
            document.getElementById('map').innerHTML = '<p style="padding:20px; text-align:center;">Map data is unavailable or start coordinates are missing.</p>';
            return;
        }

        try {
            let initialLat = mapData.coor_start.lat;
            let initialLng = mapData.coor_start.lng;
            let initialZoom = 6;

            if (mapData.coor_end && typeof mapData.coor_end.lat === 'number' && typeof mapData.coor_end.lng === 'number') {
                initialLat = (mapData.coor_start.lat + mapData.coor_end.lat) / 2;
                initialLng = (mapData.coor_start.lng + mapData.coor_end.lng) / 2;
                initialZoom = 3;
            }
            
            map = L.map('map').setView([initialLat, initialLng], initialZoom);
            console.log("Leaflet map instance created and size invalidated.");

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            console.log("Tile layer added.");

            bounds = L.latLngBounds();

            function addMarkerToMap(coords, name, iconUrl) {
                if (coords && typeof coords.lat === 'number' && typeof coords.lng === 'number') {
                    let markerOptions = {};
                    if (iconUrl) {
                        markerOptions.icon = L.icon({
                            iconUrl: iconUrl,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        });
                    }
                    L.marker([coords.lat, coords.lng], markerOptions).addTo(map).bindPopup(name);
                    bounds.extend([coords.lat, coords.lng]);
                } else {
                    console.warn("Invalid or missing coordinates for marker:", name, coords);
                }
            }

            addMarkerToMap(mapData.coor_start, 'Start Location');
            addMarkerToMap(mapData.coor_end, 'End Location');
            addMarkerToMap(mapData.start_port, `Origin Port: ${mapData.start_port ? mapData.start_port.name : 'N/A'}`, 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png');
            addMarkerToMap(mapData.end_port, `Destination Port: ${mapData.end_port ? mapData.end_port.name : 'N/A'}`, 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png');

            function addPolylineToMap(coordsArray, color, options = {}) {
                if (coordsArray && Array.isArray(coordsArray) && coordsArray.length > 0) {
                    const validCoords = coordsArray.filter(p => Array.isArray(p) && p.length === 2 && typeof p[0] === 'number' && typeof p[1] === 'number');
                    if (validCoords.length > 0) {
                        L.polyline(validCoords, { color: color, weight: 3, ...options }).addTo(map);
                        validCoords.forEach(p => bounds.extend(p));
                    } else {
                        console.warn(`Polyline with color ${color} had no valid coordinates.`);
                    }
                } else {
                    console.warn(`No data or empty array for polyline with color ${color}.`);
                }
            }       
            
            // --- START OF MODIFIED SECTION ---

            // Create a map of food types to their corresponding emoji.
            const foodEmojis = {
                'strawberry': 'üçì',
                'hass_avocado': 'ü•ë',
                'banana': 'üçå'
            };

            // Check if the current foodType has an emoji defined in our map.
            if (foodEmojis[foodType] && mapData.sea_route_coords && Array.isArray(mapData.sea_route_coords)) {
                
                // 1. Get the correct emoji for the selected food.
                const emoji = foodEmojis[foodType];

                // 2. Define the custom icon using the selected emoji.
                const foodIcon = L.divIcon({
                    html: emoji,
                    className: 'emoji-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                // 3. Add markers at intervals along the route to avoid clutter.
                // This will aim for a maximum of 25 markers along the route.
                const markerInterval = Math.max(1, Math.floor(mapData.sea_route_coords.length / 25));
                mapData.sea_route_coords.forEach((point, index) => {
                    if (index > 0 && index % markerInterval === 0) { // Start from the second point
                        L.marker(point, { icon: foodIcon }).addTo(map);
                    }
                });

                // 4. Draw a lighter, dashed line to still show the path for all emoji routes.
                addPolylineToMap(mapData.road_route_start_coords, 'blue');
                addPolylineToMap(mapData.road_route_end_coords, 'blue');
                addPolylineToMap(mapData.sea_route_coords, 'rgba(0, 128, 0, 0.6)', { dashArray: '8, 8' });

            } else {
                // If the food type is not in our emoji map, draw the normal solid lines.
                addPolylineToMap(mapData.road_route_start_coords, 'blue');
                addPolylineToMap(mapData.road_route_end_coords, 'blue');
                addPolylineToMap(mapData.sea_route_coords, 'green');
            }
            
            // --- END OF MODIFIED SECTION ---

            if (bounds.isValid()) {
                console.log("Fitting map to valid bounds. MinLat:", bounds.getSouthWest().lat, "MinLng:", bounds.getSouthWest().lng, "MaxLat:", bounds.getNorthEast().lat, "MaxLng:", bounds.getNorthEast().lng);
                console.log("Map bounds fitted.");
            } else if (mapData.coor_start && typeof mapData.coor_start.lat === 'number') {
                map.setView([mapData.coor_start.lat, mapData.coor_start.lng], 6);
                console.log("Map view set to start coordinate as bounds were invalid.");
            } else {
                console.warn("No valid bounds to fit map.");
            }

        } catch (e) {
            console.error("Error occurred within displayMap function:", e);
            document.getElementById('map').innerHTML = `<p style="padding:20px; text-align:center;">An error occurred while rendering the map.</p>`;
        }
        return bounds;
    }    

    function createTableHtml(headers, dataArray, isDetailed = false) {
      // Start with the table header
      let html = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
      
      // Start the table body
      html += '<tbody>';
      
      // Loop through each ROW in the data array
      dataArray.forEach(row => {
        html += '<tr>'; // Start a new table row for each data row
        
        // Loop through each CELL in the current row
        row.forEach((cell, index) => {
          let cellContent = cell;
          
          // Apply special number formatting only for the detailed table
          if (isDetailed) {
            if (index === 0) { // First column (Process Step) is always text
              cellContent = cell;
            } else if (index >= 6) { // "Per unit" columns get 4 decimal places
              cellContent = isNaN(Number(cell)) ? cell : Number(cell).toFixed(4); 
            } else { // Raw data columns (Cost, Energy, etc.) get scientific notation
              cellContent = isNaN(Number(cell)) ? cell : Number(cell).toExponential(2);
            }
          }
          // Add the individual table cell
          html += `<td>${cellContent}</td>`;
        });
        
        html += '</tr>'; // End the table row
      });
      
      html += '</tbody>'; // End the table body
      return '<table>' + html + '</table>'; // Wrap everything in a <table> tag
    }
    
    function displayTables(tableData, commodity) {
        // --- 1. DETAILED TABLE LOGIC ---
        let detailedHeaders = tableData.detailed_headers || [];
        let detailedData = tableData.detailed_data || [];
    
        if (commodity === 'food') {
            // If the commodity is food, filter out the GJ columns
            const columnsToRemove = [7, 9]; // Indices for 'Cost/GJ' and 'eCO2/GJ'
            detailedHeaders = detailedHeaders.filter((_, index) => !columnsToRemove.includes(index));
            detailedData = detailedData.map(row => row.filter((_, index) => !columnsToRemove.includes(index)));
        }
        // Render the detailed table with the (potentially filtered) data
        document.getElementById('detailedTableContainer').innerHTML = createTableHtml(detailedHeaders, detailedData, true);
    
    
        // --- 2. SUMMARY TABLE 1 LOGIC (No changes here) ---
        const summary1Headers = tableData.summary1_headers || [];
        const summary1Data = tableData.summary1_data || [];
        document.getElementById('summaryTableContainer').innerHTML = createTableHtml(summary1Headers, summary1Data);
    
    
        // --- 3. SUMMARY TABLE 2 (PER GJ) LOGIC ---
        const summary2Container = document.getElementById('summaryTableContainer2');
        const summary2Title = summary2Container.previousElementSibling; // The H3 title
    
        if (commodity === 'fuel' && tableData.summary2_data && tableData.summary2_data.length > 0) {
            // ONLY show this table if the commodity is 'fuel'
            summary2Container.innerHTML = createTableHtml(tableData.summary2_headers, tableData.summary2_data);
            summary2Container.classList.remove('hidden');
            summary2Title.classList.remove('hidden');
        } else {
            // Hide this table for 'food' or if there's no data
            summary2Container.innerHTML = '';
            summary2Container.classList.add('hidden');
            summary2Title.classList.add('hidden');
        }
    
        // --- 4. ASSUMPTION TABLE LOGIC (No changes here) ---
        const assumptionHeaders = tableData.assumed_prices_headers || [];
        const assumptionData = tableData.assumed_prices_data || [];
        const assumptionContainer = document.getElementById('assumptionTableContainer');
        if(assumptionContainer) {
            assumptionContainer.innerHTML = createTableHtml(assumptionHeaders, assumptionData);
        }
    }
    

  </script>

</body>
</html>
