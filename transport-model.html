<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commodity Transport Model | Eshan Singh</title>
  <link rel="icon" type="image/png" href="assets/fevicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: url('assets/clean-energy-background.jpg') no-repeat center center fixed;
      background-size: cover;
      background-color: #e9f5f0;
      color: #333;
    }
    .header-left h1 {
      margin: 0;
      font-size: 2rem;
    }
    .header-left p {
      margin: 0.25rem 0 0;
      color: #4b5563;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
    }
    header p { margin: 0.25rem 0 0; color: #4b5563; }
    nav {
      display: flex;
      justify-content: center;
      gap: 2rem;
      background-color: rgba(56, 142, 60, 0.9);
      padding: 1rem 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      position: relative;
    }
    nav a::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 2px;
      bottom: -2px;
      left: 0;
      background-color: white;
      transform: scaleX(0);
      transform-origin: bottom right;
      transition: transform 0.25s ease-out;
    }
    nav a:hover::after {
      transform: scaleX(1);
      transform-origin: bottom left;
    }
    nav a:hover {
      text-decoration: none;
    }
    main.container {
      max-width: 960px;
      margin: auto;
      padding: 2rem;
      background: white;
      border-radius: 0.5rem;
    }
    .input-group { margin-bottom: 1.5rem; }
    .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .input-group input, .input-group select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .input-inline { display: flex; align-items: center; gap: 0.5rem; }
    .button { background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; font-weight: 600; }
    .button:hover { background: #0056b3; }
    .hidden { display: none; }
    footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; color: #6b7280; }
    .social-links a { margin: 0 0.5rem; }
    .social-icon { width: 20px; height: 20px; }
  </style>
</head>
<body class="fade-in">
  <header style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
    <div>
      <h1 style="font-size: 3rem; font-weight: 600; margin: 0;">Dr. Eshan Singh</h1>
    </div>
    <div class="header-animation">
      <lottie-player 
        src="assets/wind-turbine.json"
        background="transparent"
        speed="1"
        style="width: 150px; height: 150px;"
        loop autoplay>
      </lottie-player>
    </div>
  </header>

  <nav>
    <a href="index.html">Home</a>
    <a href="energy.html">Energy Decarbonization</a>
    <a href="personal.html">Personal Musings</a>
    <a href="contact.html">Contact</a>
  </nav>

  <main class="container" style="background: rgba(255,255,255,0.92); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem; margin-top: 2rem;">
    <section>
      <h2>Commodity Transport Model</h2>
      <p>This tool allows you to calculate the energy usage, carbon footprint, and cost of transporting commodities across different global trade routes.</p>
      <div style="margin-bottom: 1.5rem; text-align: right;">
        <a href="transport-model-documentation.html" class="button secondary-button" target="_blank">View Documentation</a>
      </div>
      <form id="lcaForm">
        <div class="input-group">
          <label for="startLocation">Start Location</label>
          <input type="text" id="startLocation" value="Los Angeles, CA">
        </div>
        <div class="input-group">
          <label for="endLocation">End Location</label>
          <input type="text" id="endLocation" value="Rotterdam, Netherlands">
        </div>

        <div class="input-group">
            <label for="commodity-type">1. Select Commodity Category:</label>
            <select id="commodity-type" name="commodity-type" class="form-control">
                <option value="fuel" selected>Fuel</option>
                <option value="food">Food</option>
            </select>
        </div>

        <div id="fuel-options">
            <div class="input-group">
                <label for="fuel_type">Select Fuel Type:</label>
                <select id="fuel_type" name="fuel_type" class="form-control">
                    <option value="0">Liquid Hydrogen</option>
                    <option value="1">Ammonia</option>
                    <option value="2">Methanol</option>
                </select>
            </div>
            <div class="input-group">
              <label for="marineFuelChoice">Marine Propulsion Fuel</label>
              <select id="marineFuelChoice">
                <option value="VLSFO">VLSFO (Conventional)</option>
                <option value="LNG">LNG (Liquefied Natural Gas)</option>
                <option value="Methanol">Methanol</option>
                <option value="Ammonia">Ammonia</option>
              </select>
            </div>
            <div class="input-group">
              <label>Boil-off Gas (BOG) Treatment</label>
              <div class="input-inline">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" id="bogExpel" name="bogTreatment" value="1" checked> Expel
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" id="bogRecirculation" name="bogTreatment" value="2"> Recirculation
                </label>
              </div>
            </div>
            <div id="bogRecirculationDetails" class="hidden input-group" style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px;">
              <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">BOG Recirculation Details:</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div>
                  <label for="bogRecirculationTruck">In-land Transport Recirculation (%)</label>
                  <input type="number" id="bogRecirculationTruck" value="80">
                  <label for="bogRecirculationTruckApply">Use of BOG (In-land)</label>
                  <select id="bogRecirculationTruckApply">
                    <option value="1">Re-liquified</option>
                    <option value="2">Used as another energy source</option>
                  </select>
                </div>
                <div>
                  <label for="bogRecirculationStorage">Storage Recirculation (%)</label>
                  <input type="number" id="bogRecirculationStorage" value="80">
                  <label for="bogRecirculationStorageApply">Use of BOG (Storage)</label>
                  <select id="bogRecirculationStorageApply">
                    <option value="1">Re-liquified</option>
                    <option value="2">Used as another energy source</option>
                  </select>
                </div>
                <div>
                  <label for="bogRecirculationMaritime">Maritime Transport Recirculation (%)</label>
                  <input type="number" id="bogRecirculationMaritime" value="80">
                  <label for="bogRecirculationMaritimeApply">Use of BOG (Maritime)</label>
                  <select id="bogRecirculationMaritimeApply">
                    <option value="1">Re-liquified</option>
                    <option value="2">Used as another energy source</option>
                  </select>
                </div>
              </div>
            </div>
        </div>

        <div id="food-options" class="hidden">
            <div class="input-group">
                <label for="food_type">Select Food Type:</label>
                <select id="food_type" name="food_type" class="form-control">
                    <option value="strawberry">Strawberry</option>
                    </select>
            </div>
        </div>

        <div class="input-group">
            <label id="capacity-label" for="lh2PlantCapacity">LH2 Plant Capacity (TPD):</label>
            <input type="number" id="lh2PlantCapacity" value="1000">
        </div>
        <div class="input-group">
          <label for="storageTimeA">Storage Time at Port Closest to Starting Point (days)</label>
          <input type="number" id="storageTimeA" value="3">
        </div>
        <div class="input-group">
          <label for="storageTimeB">Storage Time at Port Closest to Destination (days)</label>
          <input type="number" id="storageTimeB" value="3">
        </div>
        <div class="input-group">
          <label for="storageTimeC">Storage Time at the Destination (days)</label>
          <input type="number" id="storageTimeC" value="3">
        </div>
        
        <div id="ship-details-wrapper">
          <div class="input-group">
            <label for="shipArchetypeSelect">Select Ship Archetype</label>
            <select id="shipArchetypeSelect">
              <option value="custom">Build my own ship...</option>
              <option value="small">Small-Scale Carrier (20,000 m³)</option>
              <option value="midsized">Midsized Carrier (90,000 m³)</option>
              <option value="standard" selected>Standard Modern Carrier (174,000 m³)</option>
              <option value="q-flex">Q-Flex Carrier (210,000 m³)</option>
              <option value="q-max">Q-Max Carrier (266,000 m³)</option>
            </select>
          </div>

          <div id="customShipDetails" class="hidden input-group" style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px; background-color: #f8f9fa;">
            <h3 style="font-size: 1.1rem; margin-top:0; margin-bottom: 1rem;">Custom Ship Details:</h3>
            <div class="input-group">
              <label for="totalShipVolume">Total Ship Cargo Volume (m³)</label>
              <input type="number" id="totalShipVolume" value="174000">
            </div>
            <div class="input-group">
              <label for="shipNumberOfTanks">Number of Ship Tanks</label>
              <select id="shipNumberOfTanks">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option>
              </select>
            </div>
            <div class="input-group">
              <label for="shipTankShape">Ship Tank Shape</label>
              <select id="shipTankShape">
                <option value="1">Capsule (Membrane)</option><option value="2" selected>Spherical (Moss)</option>
              </select>
            </div>
          </div>
        </div>
                
        <div class="input-group">
          <button type="submit" class="button">Calculate</button>
        </div>
      </form>
      <div id="results" class="hidden" style="margin-top: 2rem;">
        <h3>Results</h3>
        <div id="outputTables"></div>
      </div>
      <div id="statusMessages" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-md text-sm text-gray-700 min-h-[50px]">Waiting for input...</div>
      <div id="outputs" class="hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Results</h2>
        <div id="map" class="mb-6 shadow-md" style="height: 400px;"></div>
        <h3 class="text-lg font-semibold mb-3 text-gray-600">Summary Metrics (per kg fuel):</h3>
        <div id="summaryTableContainer" class="table-container mb-6 shadow-md"><table id="summaryTable"></table></div>
        <h3 class="text-lg font-semibold mb-3 text-gray-600">Summary Metrics (per GJ):</h3>
        <div id="summaryTableContainer2" class="table-container mb-6 shadow-md"><table id="summaryTable2"></table></div>
        <h3 class="text-lg font-semibold mb-3 text-gray-600">Assumed Prices:</h3>
        <div id="summaryTableContainer" class="table-container mb-6 shadow-md"><table id="assumptionTable"></table></div>
        <h3 class="text-lg font-semibold mb-3 text-gray-600">Detailed Process Breakdown:</h3>
        <div id="detailedTableContainer" class="table-container mb-6 shadow-md"><table id="detailedTable"></table></div>
        <div class="charts-container" style="margin-top: 2rem;">
            <h3 class="text-lg font-semibold mb-3 text-gray-600">Cost Breakdown Chart:</h3>
            <div style="border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                <img id="costChartImg" src="" alt="Cost Breakdown Chart" style="max-width: 100%;"/>
            </div>

            <h3 class="text-lg font-semibold mb-3 text-gray-600">Emissions Breakdown Chart:</h3>
            <div style="border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px;">
                <img id="emissionChartImg" src="" alt="Emissions Breakdown Chart" style="max-width: 100%;"/>
            </div>
        </div>
        <div class="text-center mt-6">
          <button id="downloadCsvButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">Download Results (CSV)</button>
        </div>
      </div>

      <div id="messageModal" class="modal">
        <div class="modal-content" style="text-align: center;">
          <p id="modalMessageText" style="margin-bottom: 1rem;"></p>
          <button id="modalCloseButton" class="modal-close-button" style="margin-bottom: 0.75rem;">OK</button>
          <p style="font-size: 0.85rem; color: #555;">
            Built by
            <a href="https://www.linkedin.com/in/jui-yang-wang0131/" target="_blank" style="color: #0073b1; text-decoration: none;">Jui-Yang Wang</a>
            and
            <a href="https://www.linkedin.com/in/eshan-singh-188b1554/" target="_blank" style="color: #0073b1; text-decoration: none;">Eshan Singh</a>
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Eshan & Associates LLC. All rights reserved.</p>
    <div class="social-links">
      <a href="https://www.linkedin.com/in/eshan-singh-188b1554/" target="_blank">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn">
      </a>
      <a href="mailto:hello@eshansingh.xyz">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/732/732200.png" alt="Email">
      </a>
      <a href="https://scholar.google.com/citations?user=VhYa_v4AAAAJ&hl=en" target="_blank">
        <img class="social-icon" src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Google Scholar">
      </a>
    </div>
  </footer>
<script>
    // --- UI Element References ---
    const commoditySelector = document.getElementById('commodity-type');
    const fuelOptionsDiv = document.getElementById('fuel-options');
    const foodOptionsDiv = document.getElementById('food-options');
    const capacityLabel = document.getElementById('capacity-label');
    const bogRecirculationDetailsPanel = document.getElementById('bogRecirculationDetails');
    const bogRecirculationRadio = document.getElementById('bogRecirculation');
    const shipDetailsWrapper = document.getElementById('ship-details-wrapper');
    const customShipDetailsPanel = document.getElementById('customShipDetails');
    const shipArchetypeSelect = document.getElementById('shipArchetypeSelect');
    
    // --- Main Function to Control UI Visibility ---
    function updateFormVisibility() {
        const selectedCommodity = commoditySelector.value;

        // Get all the option elements from the ship archetype dropdown
        const shipOptions = shipArchetypeSelect.options;

        if (selectedCommodity === 'fuel') {
            // --- SHOW FUEL SECTIONS ---
            fuelOptionsDiv.classList.remove('hidden');
            foodOptionsDiv.classList.add('hidden');
            shipDetailsWrapper.classList.remove('hidden');

            // --- UPDATE LABELS FOR FUEL ---
            capacityLabel.textContent = 'LH2 Plant Capacity (TPD):';
            // Set ship labels for LNG Carriers
            shipOptions[1].textContent = 'Small-Scale Carrier (20,000 m³)';
            shipOptions[2].textContent = 'Midsized Carrier (90,000 m³)';
            shipOptions[3].textContent = 'Standard Modern Carrier (174,000 m³)';
            shipOptions[4].textContent = 'Q-Flex Carrier (210,000 m³)';
            shipOptions[5].textContent = 'Q-Max Carrier (266,000 m³)';
            
            // Handle BOG panel visibility
            if (bogRecirculationRadio.checked) {
                bogRecirculationDetailsPanel.classList.remove('hidden');
            } else {
                bogRecirculationDetailsPanel.classList.add('hidden');
            }

        } else if (selectedCommodity === 'food') {
            // --- SHOW FOOD SECTIONS ---
            fuelOptionsDiv.classList.add('hidden');
            foodOptionsDiv.classList.remove('hidden');
            shipDetailsWrapper.classList.remove('hidden'); // Show ship details for food as well

            // --- UPDATE LABELS FOR FOOD ---
            capacityLabel.textContent = 'Processing & Freezing Facility Capacity (Tons/Day):';
            // Set ship labels for Container Ships
            shipOptions[1].textContent = 'Feeder Vessel (~2,000 Containers)';
            shipOptions[2].textContent = 'Midsized Vessel (~6,000 Containers)';
            shipOptions[3].textContent = 'Post-Panamax Vessel (~10,000 Containers)';
            shipOptions[4].textContent = 'New-Panamax Vessel (~14,000 Containers)';
            shipOptions[5].textContent = 'Ultra-Large Vessel (20,000+ Containers)';
        }

        // Handle custom ship panel visibility (this works for both fuel and food)
        if (shipArchetypeSelect.value === 'custom') {
            customShipDetailsPanel.classList.remove('hidden');
        } else {
            customShipDetailsPanel.classList.add('hidden');
        }
    }

    // --- Attach Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        commoditySelector.addEventListener('change', updateFormVisibility);
        document.querySelectorAll('input[name="bogTreatment"]').forEach(radio => {
            radio.addEventListener('change', updateFormVisibility);
        });
        shipArchetypeSelect.addEventListener('change', updateFormVisibility);
        // Set the initial state of the form when the page loads
        updateFormVisibility();
    });

    // --- Calculation Function (Updated to send the correct data) ---
    document.getElementById('lcaForm').addEventListener('submit', handleCalculation);
    document.getElementById('downloadCsvButton').addEventListener('click', downloadCSV);

    const BACKEND_URL = "https://transport-model.onrender.com";
    let map;
    let completeResultsForCsv = [];

    async function handleCalculation(e) {
      e.preventDefault();
      const calculateButton = this.querySelector('button[type="submit"]');
      const statusMessagesDiv = document.getElementById('statusMessages');
      const outputsDiv = document.getElementById('outputs');

      // Helper functions for UI updates
      function logStatus(message) { statusMessagesDiv.innerHTML += `<p>> ${message}</p>`; statusMessagesDiv.scrollTop = statusMessagesDiv.scrollHeight; }
      function clearStatus() { statusMessagesDiv.innerHTML = ''; }
      function showModal(message) {
        document.getElementById('modalMessageText').textContent = message;
        document.getElementById('messageModal').style.display = "block";
      }
      document.getElementById('modalCloseButton').onclick = () => { document.getElementById('messageModal').style.display = "none"; };

      // Reset UI for new calculation
      clearStatus();
      logStatus("Collecting user inputs...");
      calculateButton.disabled = true;
      calculateButton.textContent = 'Calculating...';
      outputsDiv.classList.add('hidden');

      // Conditionally build the userInputs object
      const commodity = document.getElementById('commodity-type').value;
      const shipArchetype = document.getElementById('shipArchetypeSelect').value;
      
      let userInputs = {
          commodity_type: commodity,
          start: document.getElementById('startLocation').value,
          end: document.getElementById('endLocation').value,
          storage_time_A: parseFloat(document.getElementById('storageTimeA').value),
          storage_time_B: parseFloat(document.getElementById('storageTimeB').value),
          storage_time_C: parseFloat(document.getElementById('storageTimeC').value),
          LH2_plant_capacity: parseFloat(document.getElementById('lh2PlantCapacity').value), // We can repurpose this input
          ship_archetype: shipArchetype,
      };

      if (commodity === 'fuel') {
          // Add fuel-specific keys
          Object.assign(userInputs, {
              fuel_type: parseInt(document.getElementById('fuel_type').value),
              marine_fuel_choice: document.getElementById('marineFuelChoice').value,
              recirculation_BOG: document.querySelector('input[name="bogTreatment"]:checked').value,
              BOG_recirculation_truck: parseFloat(document.getElementById('bogRecirculationTruck').value),
              BOG_recirculation_truck_apply: document.getElementById('bogRecirculationTruckApply').value,
              BOG_recirculation_storage: parseFloat(document.getElementById('bogRecirculationStorage').value),
              BOG_recirculation_storage_apply: document.getElementById('bogRecirculationStorageApply').value,
              BOG_recirculation_mati_trans: parseFloat(document.getElementById('bogRecirculationMaritime').value),
              BOG_recirculation_mati_trans_apply: document.getElementById('bogRecirculationMaritimeApply').value,
          });
      } else if (commodity === 'food') {
          // Add food-specific keys
          Object.assign(userInputs, {
              food_type: document.getElementById('food_type').value,
              marine_fuel_choice: document.getElementById('marineFuelChoice').value, // Also needed for food
          });
      }

      // Add custom ship details if selected (works for both)
      if (shipArchetype === 'custom') {
          Object.assign(userInputs, {
              total_ship_volume: parseFloat(document.getElementById('totalShipVolume').value),
              ship_number_of_tanks: parseInt(document.getElementById('shipNumberOfTanks').value),
              ship_tank_shape: parseInt(document.getElementById('shipTankShape').value),
          });
      }

      // The rest of the function remains the same
      try {
        logStatus("Sending data to the Python server... (This may take a minute)");
        const response = await fetch(`${BACKEND_URL}/calculate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userInputs)
        });
        logStatus("Waiting for response...");
        const results = await response.json();
        if (results.status === 'error') throw new Error(results.message);
        logStatus("Calculation complete. Rendering results...");
        
        const routeBounds = displayMap(results.map_data);
        displayTables(results.table_data);
        completeResultsForCsv = results.csv_data; 
        if (results.charts) {
          document.getElementById('costChartImg').src = "data:image/png;base64," + results.charts.cost_chart_base64;
          document.getElementById('emissionChartImg').src = "data:image/png;base64," + results.charts.emission_chart_base64;
        }
        
        outputsDiv.classList.remove('hidden');
        setTimeout(() => {
            map.invalidateSize();
            if (routeBounds && routeBounds.isValid()) {
                map.fitBounds(routeBounds.pad(0.1));
            }
        }, 1);
      } catch (error) {
        logStatus(`Error: ${error.message}`);
        showModal(`An error occurred: ${error.message}.`);
      } finally {
        calculateButton.disabled = false;
        calculateButton.textContent = 'Calculate';
      }
    }
    
    // --- Other functions (displayMap, displayTables, downloadCSV) can remain the same ---
    function displayMap(mapData) { /* ... no changes needed ... */ }
    function createTableHtml(headers, dataArray, isDetailed = false) { /* ... no changes needed ... */ }
    function displayTables(tableData) { /* ... no changes needed ... */ }
    function downloadCSV() { /* ... no changes needed ... */ }
</script>

</body>
</html>
