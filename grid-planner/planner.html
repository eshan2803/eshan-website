<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Planning Simulator | Dr. Eshan Singh</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.1/dist/chartjs-plugin-dragdata.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc;
            color: #1f2937;
        }

        .font-lora {
            font-family: 'Lora', serif;
        }

        .glass-card {
            background-color: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .mesh-gradient-container {
            position: relative;
            z-index: 1;
        }

        .mesh-gradient-1 {
            background-image: radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 20%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 1) 0px, transparent 50%);
            background-size: 100% 100%;
            filter: blur(25px) saturate(1.2);
            opacity: 0.15;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            animation: pulse-bg 15s infinite alternate;
        }

        .tutorial-active .mesh-gradient-1 {
            animation: none !important;
        }

        .form-input {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 9999px;
            outline: none;
            border: 1px solid #e5e7eb;
            transition: background .2s;
        }

        .form-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-input::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mix-slider-track {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.75rem;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .mix-slider-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.2s ease-in-out;
        }

        .mix-slider-default-outline {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border: 1px solid black;
            border-radius: 9999px;
            box-sizing: border-box;
            background: transparent;
        }

        .value-input {
            width: 6rem;
            /* Adjust width as needed */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            text-align: right;
            background-color: rgba(255, 255, 255, 0.8);
        }

        /* Color-coded slider thumbs */
        .thumb-solar::-webkit-slider-thumb {
            background-color: rgba(251, 191, 36, 1);
        }

        .thumb-solar::-moz-range-thumb {
            background-color: rgba(251, 191, 36, 1);
        }

        .thumb-wind::-webkit-slider-thumb {
            background-color: rgba(52, 211, 153, 1);
        }

        /* Lighter green */
        .thumb-wind::-moz-range-thumb {
            background-color: rgba(52, 211, 153, 1);
        }

        /* Lighter green */
        .thumb-offshoreWind::-webkit-slider-thumb {
            background-color: rgba(12, 148, 103, 1);
        }

        .thumb-offshoreWind::-moz-range-thumb {
            background-color: rgba(12, 148, 103, 1);
        }

        .thumb-geothermal::-webkit-slider-thumb {
            background-color: rgba(120, 40, 40, 1);
        }

        .thumb-geothermal::-moz-range-thumb {
            background-color: rgba(120, 40, 40, 1);
        }

        .thumb-nuclear::-webkit-slider-thumb {
            background-color: rgba(239, 68, 68, 1);
        }

        .thumb-nuclear::-moz-range-thumb {
            background-color: rgba(239, 68, 68, 1);
        }

        .thumb-storage::-webkit-slider-thumb {
            background-color: rgba(168, 85, 247, 1);
        }

        .thumb-storage::-moz-range-thumb {
            background-color: rgba(168, 85, 247, 1);
        }

        .thumb-neutral::-webkit-slider-thumb {
            background-color: rgba(107, 114, 128, 1);
        }

        .thumb-neutral::-moz-range-thumb {
            background-color: rgba(107, 114, 128, 1);
        }

        .thumb-biomass::-webkit-slider-thumb {
            background-color: rgba(101, 67, 33, 1);
        }

        /* Brown color for biomass */
        .thumb-biomass::-moz-range-thumb {
            background-color: rgba(101, 67, 33, 1);
        }

        .thumb-rng::-webkit-slider-thumb {
            background-color: rgba(132, 204, 22, 1);
        }

        /* Lime green for RNG */
        .thumb-rng::-moz-range-thumb {
            background-color: rgba(132, 204, 22, 1);
        }

        .thumb-hydrogen::-webkit-slider-thumb {
            background-color: rgba(219, 39, 119, 1);
        }

        /* Pink/magenta for hydrogen */
        .thumb-hydrogen::-moz-range-thumb {
            background-color: rgba(219, 39, 119, 1);
        }

        /* Rainbow Border Animation */
        @keyframes rainbow-border {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        .rainbow-glow {
            position: relative;
            background: linear-gradient(90deg, #ff0080, #ff8000, #ffff00, #80ff00, #00ff80, #0080ff, #8000ff, #ff0080);
            background-size: 200% 200%;
            animation: rainbow-border 2s linear infinite;
            padding: 2px;
            border-radius: 9999px;
        }

        .rainbow-glow .button-content {
            background: #f3f4f6;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            display: block;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .rainbow-glow:hover .button-content {
            background: #e5e7eb;
        }

        /* Style for active season preset button */
        .preset-active {
            background-color: #4b5563 !important;
            /* A darker gray */
            color: #ffffff !important;
        }

        /* --- TUTORIAL STYLES --- */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            display: none;
            /* Controlled by JS */
        }

        #tutorial-popover {
            position: fixed;
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            width: 320px;
            max-width: 90vw;
            display: none;
            transition: top 0.3s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .tutorial-highlight-active {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7),
                0 0 20px 10px rgba(59, 130, 246, 0.4),
                0 0 0 9999px rgba(0, 0, 0, 0.6);
            transition: box-shadow 0.3s ease-in-out;
        }

        .tutorial-highlight-active.rounded-full {
            border-radius: 9999px;
        }

        .tutorial-highlight-active.rounded-lg {
            border-radius: 1rem;
        }
    </style>
</head>

<body class="antialiased">
    <!-- Tooltip element -->
    <div id="hover-tooltip"
        class="absolute hidden bg-gray-800 text-white text-sm rounded-md px-2 py-1 z-50 pointer-events-none shadow-lg">
    </div>

    <!-- TUTORIAL HTML -->
    <div id="tutorial-overlay"></div>
    <div id="tutorial-popover">
        <h3 id="tutorial-title" class="text-xl font-lora font-bold mb-2 text-gray-800"></h3>
        <p id="tutorial-text" class="text-gray-600 mb-4"></p>
        <div class="flex justify-between items-center">
            <button id="tutorial-skip" class="text-sm text-gray-500 hover:text-gray-800">Skip Tour</button>
            <div>
                <button id="tutorial-prev"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 mr-2">Prev</button>
                <button id="tutorial-next"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Next</button>
            </div>
        </div>
    </div>

    <div class="mesh-gradient-container">
        <div class="mesh-gradient-1"></div>

        <header class="p-8">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex flex-col">
                    <a href="/" class="font-lora text-2xl font-semibold">Dr. Eshan Singh</a>
                    <div class="text-sm text-gray-500 mt-1">
                        <span>Views: </span><span id="visitor-count">Loading...</span>
                    </div>
                </div>
                <nav class="flex items-center space-x-2">
                    <a href="/energy.html"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">Articles</a>
                    <a href="/transport-model/index.html" class="rainbow-glow">
                        <span class="button-content">Transport Model</span>
                    </a>
                    <a href="/grid-planner/index.html" class="rainbow-glow">
                        <span class="button-content">Grid Planner</span>
                    </a>
                    <a href="/grid-operator/index.html" class="rainbow-glow">
                        <span class="button-content">Grid Operator</span>
                    </a>
                    <a href="https://www.eshansingh.xyz/transmission/index.html" class="rainbow-glow">
                        <span class="button-content">CA Grid Map</span>
                    </a>
                    <a href="/musings.html"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">Musings</a>
                </nav>
            </div>
        </header>

        <div class="container mx-auto p-4 md:p-8 pt-0">

            <section id="tutorial-step-1" class="text-center mb-12">
                <h1 class="font-lora text-5xl md:text-6xl font-medium leading-tight text-gray-900">Grid Planning
                    Simulator</h1>
                <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">
                    Your challenge: Use policy levers for clean energy and direct air capture to eliminate CO2 emissions
                    from the electricity grid, while minimizing the impact on customer bill.
                </p>
                <div class="flex justify-center items-center space-x-4 mt-4">
                    <a href="grid-model-documentation.html"
                        class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors text-sm font-medium">
                        ðŸ“– View Documentation
                    </a>
                    <button id="start-tutorial-btn"
                        class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors text-sm font-medium">
                        ðŸš€ Show Tutorial
                    </button>
                </div>
                <p class="mt-4 text-sm text-gray-600">
                    Send your queries at <a href="mailto:hello@eshansingh.xyz"
                        class="text-blue-600 hover:underline">hello@eshansingh.xyz</a>
                </p>
            </section>

            <!-- Full Width Charts Section - LOAD GENERATION, PRICE, CO2 -->
            <div class="space-y-8 mb-8">
                <!-- Load Generation Chart -->
                <div class="glass-card rounded-lg w-full">
                    <div class="mb-4 relative">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-lora font-semibold text-gray-800">All Year - Hourly Electricity
                                Generation (GWh)</h2>
                        </div>
                        <canvas id="generationMixChart" height="100"></canvas>
                    </div>
                </div>

                <!-- Marginal Price Chart -->
                <div class="glass-card rounded-lg w-full">
                    <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">All Year - Hourly Marginal Price
                        ($/MWh)</h2>
                    <canvas id="marginalPriceChart" height="100"></canvas>
                </div>

                <!-- Monthly CO2 Emissions Bar Chart -->
                <div class="glass-card rounded-lg w-full">
                    <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Monthly Total CO2 Emissions (Metric
                        Tons)</h2>
                    <canvas id="co2EmissionsChart" height="100"></canvas>
                </div>
            </div>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Sliders Section Container -->
                <div id="tutorial-step-2" class="lg:col-span-2 glass-card rounded-lg">

                    <div id="tutorial-step-4" class="mt-8">
                        <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Installed Capacity Mix (%)</h2>
                        <div id="grid-mix-sliders" class="space-y-3">
                            <!-- Sliders will be dynamically inserted here -->
                        </div>
                        <!-- NEW: Container for storage capacity display -->
                        <div id="storage-capacity-display" class="mt-6"></div>
                    </div>
                    <div class="mt-8">
                        <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Daily Generation Mix (%)</h2>
                        <div id="generation-mix-sliders" class="space-y-3">
                            <!-- New chart sliders will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-lora font-semibold text-gray-800">Hourly Capacity Factors</h2>
                            <div class="flex items-center space-x-2">
                                <div id="current-cf-profile-text"
                                    class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full mr-1">
                                </div>
                                <div id="cf-edit-controls" class="flex items-center space-x-1">
                                    <button id="edit-cf-btn" class="p-2 rounded-full hover:bg-gray-200"
                                        title="Edit capacity factor profiles or select a seasonal preset">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path
                                                d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                            <path fill-rule="evenodd"
                                                d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <div id="cf-presets" class="hidden">
                                        <button id="preset-cf-spring"
                                            class="px-2 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Spring</button>
                                        <button id="preset-cf-summer"
                                            class="px-2 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Summer</button>
                                        <button id="preset-cf-fall"
                                            class="px-2 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Fall</button>
                                        <button id="preset-cf-winter"
                                            class="px-2 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Winter</button>
                                    </div>
                                    <button id="revert-cf-btn" class="p-2 rounded-full hover:bg-gray-200 hidden"
                                        title="Revert to original capacity factor profiles">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button id="confirm-cf-btn" class="p-2 rounded-full hover:bg-gray-200 hidden"
                                        title="Confirm changes to capacity factors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <canvas id="capacityFactorChart"></canvas>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div id="tutorial-step-5" class="glass-card rounded-lg sticky top-6 z-10">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div
                                title="Based on the average wholesale price of electricity&#10;Assuming natural gas plant on the margin drives the price">
                                <h3 class="text-xl font-lora font-semibold text-gray-800">Marginal Price</h3>
                                <p id="bill-impact" class="text-5xl font-bold text-blue-600 mt-2">0%</p>
                            </div>
                            <div title="Based on the total annualized cost to operate the grid">
                                <h3 class="text-xl font-lora font-semibold text-gray-800">System Cost</h3>
                                <p id="system-cost-impact" class="text-5xl font-bold text-blue-600 mt-2">0%</p>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <p id="co2-avoided-text" class="text-md font-medium text-gray-700"></p>
                        </div>
                    </div>



                    <div id="tutorial-step-3" class="glass-card space-y-6 rounded-lg">
                        <div class="mb-6">
                            <label for="country-select" class="block text-md font-medium text-gray-700 mb-2">Select
                                Default Grid Mix</label>
                            <select id="country-select"
                                class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center justify-around">
                                <button id="undo-button"
                                    class="p-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Undo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button id="redo-button"
                                    class="p-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Redo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <button id="make-default-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Set the current lever positions as your new default">Make Default</button>
                            <button id="reset-to-default-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Reset levers to the default for this grid mix">Reset to Default</button>
                            <button id="reset-to-zero-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Reset all policy and new capacity levers to zero">Reset to Zero</button>
                        </div>
                        <div>
                            <h2
                                class="text-2xl font-lora font-semibold mb-4 border-b border-t pt-4 border-gray-300 pb-4 text-gray-800">
                                Policy Levers</h2>
                            <div class="space-y-6 pt-4">
                                <!-- Levers -->
                                <div>
                                    <label for="solar-slider" class="block text-md font-medium text-gray-700">New Solar
                                        Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="solar-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-solar">
                                        <input type="number" id="solar-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="solar-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="wind-slider" class="block text-md font-medium text-gray-700">New Onshore
                                        Wind Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="wind-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-wind">
                                        <input type="number" id="wind-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="wind-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="offshoreWind-slider" class="block text-md font-medium text-gray-700">New
                                        Offshore Wind Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="offshoreWind-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-offshoreWind">
                                        <input type="number" id="offshoreWind-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="offshoreWind-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="geothermal-slider" class="block text-md font-medium text-gray-700">New
                                        Geothermal Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="geothermal-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-geothermal">
                                        <input type="number" id="geothermal-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="geothermal-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="nuclear-slider" class="block text-md font-medium text-gray-700">New
                                        Nuclear Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="nuclear-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-nuclear">
                                        <input type="number" id="nuclear-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="nuclear-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="biomass-slider" class="block text-md font-medium text-gray-700">New
                                        Biomass Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="biomass-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-biomass">
                                        <input type="number" id="biomass-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="biomass-unit">GW</span>
                                    </div>
                                </div>
                                <!-- NEW: RNG (Biogas) Slider -->
                                <div>
                                    <label for="rng-slider" class="block text-md font-medium text-gray-700">New RNG
                                        (Biogas) Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="rng-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-rng">
                                        <input type="number" id="rng-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left" id="rng-unit">GW</span>
                                    </div>
                                </div>
                                <!-- NEW: Hydrogen Slider -->
                                <div>
                                    <label for="hydrogen-slider" class="block text-md font-medium text-gray-700">New
                                        Hydrogen Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="hydrogen-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-hydrogen">
                                        <input type="number" id="hydrogen-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="hydrogen-unit">GW</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="battery4hr-slider" class="block text-md font-medium text-gray-700">4-hr
                                        Battery Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="battery4hr-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="battery4hr-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="battery4hr-unit">GWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="battery8hr-slider" class="block text-md font-medium text-gray-700">8-hr
                                        Battery Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="battery8hr-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="battery8hr-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="battery8hr-unit">GWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="longduration-slider"
                                        class="block text-md font-medium text-gray-700">24-hr Long Duration
                                        Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="longduration-slider" min="0" max="500" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="longduration-input" min="0" max="500" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="longduration-unit">GWh</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="demandflex-slider"
                                        class="block text-md font-medium text-gray-700">Demand Flexibility</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="demandflex-slider" min="0" max="25" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="demandflex-input" min="0" max="25" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="demandflex-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h2
                                class="text-2xl font-lora font-semibold mb-4 border-b border-t border-gray-300 pt-6 pb-4 text-gray-800">
                                Government Incentives</h2>
                            <div class="space-y-6 pt-4">
                                <!-- Incentive levers -->
                                <div>
                                    <label for="carbon-tax-slider"
                                        class="block text-sm font-medium text-gray-700">Carbon Tax</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="carbon-tax-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="carbon-tax-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="carbon-tax-unit">$/ton</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="export-price-slider"
                                        class="block text-sm font-medium text-gray-700">Export Price</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="export-price-slider" min="-100" max="100" value="-20"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="export-price-input" min="-100" max="100" value="-20"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="export-price-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="solar-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Solar (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="solar-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-solar">
                                        <input type="number" id="solar-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="solar-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="wind-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Onshore Wind (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="wind-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-wind">
                                        <input type="number" id="wind-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="wind-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="offshoreWind-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Offshore Wind (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="offshoreWind-incentive-slider" min="0" max="50"
                                            value="0" class="w-full form-input thumb-offshoreWind">
                                        <input type="number" id="offshoreWind-incentive-input" min="0" max="50"
                                            value="0" class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="offshoreWind-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="geothermal-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Geothermal (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="geothermal-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-geothermal">
                                        <input type="number" id="geothermal-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="geothermal-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="nuclear-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Nuclear (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="nuclear-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-nuclear">
                                        <input type="number" id="nuclear-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="nuclear-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="biomass-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Biomass (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="biomass-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-biomass">
                                        <input type="number" id="biomass-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="biomass-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <!-- NEW: RNG (Biogas) Incentive Slider -->
                                <div>
                                    <label for="rng-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">RNG (Biogas) (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="rng-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-rng">
                                        <input type="number" id="rng-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="rng-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <!-- NEW: Hydrogen Incentive Slider -->
                                <div>
                                    <label for="hydrogen-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Hydrogen (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="hydrogen-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-hydrogen">
                                        <input type="number" id="hydrogen-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="hydrogen-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="storage-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Storage (ITC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="storage-incentive-slider" min="0" max="100" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="storage-incentive-input" min="0" max="100" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="storage-incentive-unit">$/kWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="dac-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Direct Air Capture (45Q)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="dac-incentive-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="dac-incentive-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="dac-incentive-unit">$/ton</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-300 pt-6">
                            <label for="dac-slider" class="block text-md font-medium text-gray-700">Direct Air Capture
                                Deployment</label>
                            <div class="flex items-center space-x-2 mt-2">
                                <input type="range" id="dac-slider" min="0" max="10000" value="0"
                                    class="w-full form-input thumb-neutral">
                                <input type="number" id="dac-input" min="0" max="10000" value="0" class="value-input">
                                <span class="font-semibold text-gray-900 w-12 text-left" id="dac-unit">t/hr</span>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    </main>
    </div>
    </div>
    <!-- Copyright Footer -->
    <footer class="container mx-auto p-4 mt-12 text-center border-t border-gray-200">
        <p class="text-sm text-gray-600">
            Â© 2025 <a href="https://eshansingh.xyz" class="font-medium text-gray-800 hover:text-blue-600">Dr. Eshan
                Singh</a>. All rights reserved.
        </p>
        <p class="text-xs text-gray-500 mt-1">
            For licensing inquiries: <a href="mailto:hello@eshansingh.xyz"
                class="text-blue-600 hover:text-blue-700 underline">hello@eshansingh.xyz</a>
        </p>
    </footer>
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdEeu0VugTfZD-R-62pFvBdb313TeM4xs",
            authDomain: "grid-decarbonization.firebaseapp.com",
            projectId: "grid-decarbonization",
            storageBucket: "grid-decarbonization.appspot.com",
            messagingSenderId: "902419724670",
            appId: "1:902419724670:web:b636a75ea44325946a9b2f",
            measurementId: "G-3Q9HE19CGN"
        };

        // --- INITIALIZE FIREBASE & DEFINE KEY VARIABLES ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId;

        // --- MODEL PARAMETERS & DATA (GLOBAL SCOPE) ---
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const DAYS_IN_MONTH = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        const HOURS = [];
        MONTHS.forEach(m => {
            Array.from({ length: 24 }, (_, i) => HOURS.push(`${m} ${i}:00`));
        });

        const countryGridMixData = {
            "California": {
                totalCapacityMW: 89223,
                peakLoadsMW: { summer: 52061, winter: 47500, fall: 46000, spring: 41000 },
                mix: { coal: 0.1, naturalGas: 43.4, hydro: 15.7, wind: 7.1, offshoreWind: 0, solar: 26.1, nuclear: 2.7, geothermal: 3.0, biomass: 1.0, rng: 0.4 },
                storageGWh: { battery4hr: 53.0 },
                defaultExportPrice: -20
            },
            "China": {
                totalCapacityMW: 3400000,
                peakLoadsMW: { summer: 1340000, winter: 1206000, fall: 1179200, spring: 1072000 },
                mix: { coal: 40.0, naturalGas: 8.0, hydro: 12.5, wind: 14.0, offshoreWind: 1.6, solar: 20.0, nuclear: 2.5, geothermal: 0.1, biomass: 0.9, rng: 0.4 },
                storageGWh: { battery4hr: 222 }
            },
            "United States": {
                totalCapacityMW: 1275000,
                peakLoadsMW: { summer: 800000, winter: 720000, fall: 704000, spring: 640000 },
                mix: { coal: 15.0, naturalGas: 48.0, hydro: 7.8, wind: 11.5, offshoreWind: 0.2, solar: 9.0, nuclear: 8.0, geothermal: 0.3, biomass: 0.8, rng: 0.4 },
                storageGWh: { battery4hr: 95 }
            },
            "India": {
                totalCapacityMW: 476000,
                peakLoadsMW: { summer: 243000, winter: 206550, fall: 213840, spring: 194400 },
                mix: { coal: 50.0, naturalGas: 6.0, hydro: 10.0, wind: 9.5, offshoreWind: 0, solar: 18.0, nuclear: 1.8, geothermal: 0.0, biomass: 1.9, rng: 0.8 },
                storageGWh: { battery4hr: 1 }
            },
            "Japan": {
                totalCapacityMW: 295000,
                peakLoadsMW: { summer: 181000, winter: 162900, fall: 159280, spring: 144800 },
                mix: { coal: 20.0, naturalGas: 35.0, hydro: 17.0, wind: 1.6, offshoreWind: 0.1, solar: 15.5, nuclear: 10.5, geothermal: 0.2, biomass: 1.1, rng: 0.5 },
                storageGWh: { battery4hr: 1.2 }
            },
            "Russia": {
                totalCapacityMW: 248000,
                peakLoadsMW: { winter: 160000, summer: 144000, fall: 140800, spring: 128000 },
                mix: { coal: 15.0, naturalGas: 52.0, hydro: 20.0, wind: 0.9, offshoreWind: 0, solar: 0.8, nuclear: 11.3, geothermal: 0.0, biomass: 0.1, rng: 0.1 }
            },
            "Brazil": {
                totalCapacityMW: 180000,
                peakLoadsMW: { summer: 101860, winter: 91674, fall: 89637, spring: 81488 },
                mix: { coal: 2.0, naturalGas: 18.0, hydro: 59.0, wind: 10.5, offshoreWind: 0, solar: 9.5, nuclear: 1.0, geothermal: 0.0, biomass: 5.6, rng: 2.4 }
            },
            "Germany": {
                totalCapacityMW: 210000,
                peakLoadsMW: { winter: 84000, summer: 75600, fall: 73920, spring: 67200 },
                mix: { coal: 14.0, naturalGas: 38.0, hydro: 4.0, wind: 22.0, offshoreWind: 4.0, solar: 12.0, nuclear: 5.0, geothermal: 0.0, biomass: 4.2, rng: 1.8 },
                storageGWh: { battery4hr: 22.1 }
            },
            "Canada": {
                totalCapacityMW: 165000,
                peakLoadsMW: { winter: 140000, summer: 126000, fall: 123200, spring: 112000 },
                mix: { coal: 4.5, naturalGas: 13.5, hydro: 57.0, wind: 8.5, offshoreWind: 0, solar: 2.5, nuclear: 14.0, geothermal: 0.0, biomass: 1.4, rng: 0.6 },
                storageGWh: { battery4hr: 1 }
            },
            "South Korea": {
                totalCapacityMW: 125000,
                peakLoadsMW: { summer: 93000, winter: 83700, fall: 81840, spring: 74400 },
                mix: { coal: 34.0, naturalGas: 20.0, hydro: 5.0, wind: 1.4, offshoreWind: 0.1, solar: 12.5, nuclear: 27.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 9 }
            },
            "France": {
                totalCapacityMW: 115000,
                peakLoadsMW: { winter: 102000, summer: 91800, fall: 89760, spring: 81600 },
                mix: { coal: 1.0, naturalGas: 10.0, hydro: 10.0, wind: 8.0, offshoreWind: 0.5, solar: 6.0, nuclear: 64.0, geothermal: 0.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 1.0 }
            },
            "United Kingdom": {
                totalCapacityMW: 78000,
                peakLoadsMW: { winter: 60000, summer: 54000, fall: 52800, spring: 48000 },
                mix: { coal: 1.0, naturalGas: 38.0, hydro: 2.0, wind: 15.0, offshoreWind: 14.0, solar: 19.0, nuclear: 9.0, geothermal: 0.0, biomass: 4.2, rng: 1.8 },
                storageGWh: { battery4hr: 16.0 }
            },
            "Australia": {
                totalCapacityMW: 65000,
                peakLoadsMW: { summer: 47000, winter: 42300, fall: 41360, spring: 37600 },
                mix: { coal: 45.0, naturalGas: 18.0, hydro: 13.0, wind: 10.0, offshoreWind: 0, solar: 13.0, nuclear: 0.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 5.6 }
            },
            "Spain": {
                totalCapacityMW: 120000,
                peakLoadsMW: { summer: 45000, winter: 40500, fall: 39600, spring: 36000 },
                mix: { coal: 2.0, naturalGas: 22.0, hydro: 17.0, wind: 27.5, offshoreWind: 0, solar: 21.5, nuclear: 7.0, geothermal: 0.0, biomass: 1.0, rng: 0.4 },
                storageGWh: { battery4hr: 1.7 }
            },
            "Italy": {
                totalCapacityMW: 122000,
                peakLoadsMW: { summer: 60000, winter: 54000, fall: 52800, spring: 48000 },
                mix: { coal: 4.0, naturalGas: 47.0, hydro: 18.0, wind: 10.0, offshoreWind: 0, solar: 19.0, nuclear: 0.0, geothermal: 1.0, biomass: 1.4, rng: 0.6 },
                storageGWh: { battery4hr: 6 }
            },
            "Indonesia": {
                totalCapacityMW: 75000,
                peakLoadsMW: { summer: 50000, winter: 45000, fall: 44000, spring: 40000 },
                mix: { coal: 48.0, naturalGas: 28.0, hydro: 9.0, wind: 0.2, offshoreWind: 0, solar: 2.8, nuclear: 0.0, geothermal: 3.0, biomass: 0.7, rng: 0.3 }
            },
            "South Africa": {
                totalCapacityMW: 60000,
                peakLoadsMW: { winter: 34000, summer: 30600, fall: 29920, spring: 27200 },
                mix: { coal: 78.0, naturalGas: 6.0, hydro: 6.0, wind: 5.5, offshoreWind: 0, solar: 3.5, nuclear: 0.0, geothermal: 0.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 2 }
            },
            "Mexico": {
                totalCapacityMW: 88000,
                peakLoadsMW: { summer: 50000, winter: 45000, fall: 44000, spring: 40000 },
                mix: { coal: 5.0, naturalGas: 58.0, hydro: 15.0, wind: 9.0, offshoreWind: 0, solar: 11.0, nuclear: 1.0, geothermal: 1.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 0.6 }
            },
            "Norway": {
                totalCapacityMW: 39000,
                peakLoadsMW: { winter: 25000, summer: 22500, fall: 22000, spring: 20000 },
                mix: { coal: 0.0, naturalGas: 0.0, hydro: 91.0, wind: 8.5, offshoreWind: 0, solar: 0.5, nuclear: 0.0, geothermal: 0.0, biomass: 0.0, rng: 0.0 },
                storageGWh: { battery4hr: 0.2 }
            },
            "New Zealand": {
                totalCapacityMW: 9800,
                peakLoadsMW: { winter: 7000, summer: 6300, fall: 6160, spring: 5600 },
                mix: { coal: 0.0, naturalGas: 14.0, hydro: 56.0, wind: 7.5, offshoreWind: 0, solar: 1.5, nuclear: 0.0, geothermal: 20.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 0.4 }
            },
            "Vietnam": {
                totalCapacityMW: 80000,
                peakLoadsMW: { summer: 45000, winter: 40500, fall: 39600, spring: 36000 },
                mix: { coal: 32.0, naturalGas: 9.0, hydro: 28.0, wind: 6.0, offshoreWind: 0, solar: 24.0, nuclear: 0.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 0.1 }
            }
        };

        const carbonTaxes = {
            "California": 26, "Canada": 61, "China": 8, "France": 48, "Germany": 43, "Japan": 2,
            "South Korea": 22, "Spain": 16, "United Kingdom": 22, "South Africa": 9,
            "Mexico": 3, "Norway": 85, "New Zealand": 50
        };

        // High-demand seasonal profiles (used for non-California countries)
        const SEASONAL_DEMAND_PROFILES = {
            'spring-high': [28, 26, 25, 24, 24, 25, 28, 32, 33, 32, 30, 28, 27, 28, 30, 34, 39, 45, 48, 46, 42, 38, 34, 30],
            'summer-high': [30, 28, 27, 26, 26, 27, 29, 33, 37, 40, 42, 44, 46, 48, 50, 52, 55, 56, 55, 52, 48, 43, 38, 33],
            'fall-high': [27, 25, 24, 23, 23, 24, 27, 31, 34, 36, 37, 38, 39, 40, 41, 43, 46, 50, 49, 46, 42, 37, 32, 29],
            'winter-high': [32, 30, 29, 29, 30, 34, 40, 45, 44, 42, 40, 39, 39, 40, 41, 43, 45, 46, 45, 42, 39, 36, 34, 32],
            // Typical profiles (scaled from high profiles)
            'spring-typical': [28, 26, 25, 24, 24, 25, 28, 32, 33, 32, 30, 28, 27, 28, 30, 34, 39, 45, 48, 46, 42, 38, 34, 30].map(v => v * 0.79),
            'summer-typical': [30, 28, 27, 26, 26, 27, 29, 33, 37, 40, 42, 44, 46, 48, 50, 52, 55, 56, 55, 52, 48, 43, 38, 33].map(v => v * 0.82),
            'fall-typical': [27, 25, 24, 23, 23, 24, 27, 31, 34, 36, 37, 38, 39, 40, 41, 43, 46, 50, 49, 46, 42, 37, 32, 29].map(v => v * 0.77),
            'winter-typical': [32, 30, 29, 29, 30, 34, 40, 45, 44, 42, 40, 39, 39, 40, 41, 43, 45, 46, 45, 42, 39, 36, 34, 32].map(v => v * 0.73)
        };

        // California profiles loaded from JSON (populated during initialization)
        let CALIFORNIA_PROFILES = {};

        // This object will hold the calculated POTENTIAL generation, not a pre-dispatched baseline.
        let BASELINE_POTENTIAL_GENERATION = {};
        let currentCountryInstalledCapacity = {};
        let currentBaselineStorage = {};
        let dailyGenerationTotalsGWh = {}; // For tooltips

        const SOLAR_CF_PROFILE = [0, 0, 0, 0, 0, 0.05, 0.15, 0.3, 0.5, 0.7, 0.8, 0.85, 0.9, 0.85, 0.8, 0.7, 0.3, 0.05, 0, 0, 0, 0, 0, 0];
        const WIND_CF_PROFILE = [0.4, 0.42, 0.45, 0.46, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.2, 0.2, 0.25, 0.3, 0.35, 0.4, 0.5, 0.6, 0.65, 0.6, 0.55, 0.5, 0.45, 0.4];
        const OFFSHORE_WIND_CF_PROFILE = [0.55, 0.56, 0.57, 0.58, 0.58, 0.57, 0.55, 0.52, 0.5, 0.48, 0.47, 0.46, 0.47, 0.48, 0.5, 0.52, 0.55, 0.6, 0.62, 0.61, 0.6, 0.58, 0.57, 0.56];

        const SEASONAL_HYDRO_CF = {
            spring: 0.50,
            summer: 0.30,
            fall: 0.25,
            winter: 0.35
        };

        const SEASONAL_MULTIPLIERS = {
            spring: { solar: 1.0, wind: 1.0, offshoreWind: 1.0 },
            summer: { solar: 1.1, wind: 0.8, offshoreWind: 0.9 },
            fall: { solar: 0.8, wind: 1.0, offshoreWind: 1.0 },
            winter: { solar: 0.6, wind: 1.1, offshoreWind: 1.1 }
        };
        const countryProfiles = {
            "California": { // Using default CA profile
                solar: SOLAR_CF_PROFILE,
                wind: WIND_CF_PROFILE,
                offshoreWind: OFFSHORE_WIND_CF_PROFILE
            },
            "Germany": {
                solar: [0, 0, 0, 0, 0, 0.02, 0.1, 0.25, 0.45, 0.6, 0.7, 0.75, 0.7, 0.6, 0.4, 0.15, 0.05, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.5, 0.52, 0.55, 0.56, 0.55, 0.5, 0.45, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.45, 0.5, 0.6, 0.7, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5],
                offshoreWind: [0.6, 0.62, 0.65, 0.66, 0.65, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.55, 0.6, 0.7, 0.8, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6]
            },
            "United Kingdom": {
                solar: [0, 0, 0, 0, 0, 0.01, 0.08, 0.2, 0.4, 0.55, 0.65, 0.7, 0.65, 0.55, 0.35, 0.1, 0.02, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.6, 0.62, 0.65, 0.68, 0.66, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.55, 0.6, 0.7, 0.8, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6],
                offshoreWind: [0.7, 0.72, 0.75, 0.78, 0.76, 0.7, 0.65, 0.6, 0.55, 0.5, 0.5, 0.5, 0.55, 0.6, 0.65, 0.7, 0.8, 0.9, 0.95, 0.9, 0.85, 0.8, 0.75, 0.7]
            },
            "Australia": {
                solar: [0, 0, 0, 0, 0, 0.08, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.9, 0.8, 0.6, 0.3, 0.1, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.3, 0.3, 0.3, 0.25, 0.2, 0.2, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.45, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.4, 0.35, 0.3],
                offshoreWind: [0.4, 0.4, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.5, 0.45, 0.4]
            },
            "default": {
                solar: SOLAR_CF_PROFILE,
                wind: WIND_CF_PROFILE,
                offshoreWind: OFFSHORE_WIND_CF_PROFILE
            }
        };
        const EMISSION_FACTORS = { naturalGas: 395, hydro: 0, nuclear: 0, solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, coal: 850, biomass: 0, rng: 0, hydrogen: 0 };

        const COST_DATA = {
            capex: {
                solar: 1200, wind: 1500, offshoreWind: 5000, nuclear: 7242, geothermal: 3329, biomass: 3500, rng: 3000, hydrogen: 3500,
                naturalGas: 1300, hydro: 3336, coal: 4407,
                battery4hr: 350, battery8hr: 300, longduration: 300, // $/kWh
                dac: 1000 // $/ton/year
            },
            fixed_om: {
                solar: 15, wind: 35, offshoreWind: 100, nuclear: 140, geothermal: 120, biomass: 100, rng: 95, hydrogen: 90, // $/kW-year
                naturalGas: 20, hydro: 20, coal: 40,
                battery4hr: 15, battery8hr: 15, longduration: 60, // $/kW-year
                dac: 20 // $/ton/year
            },
            variable_om: {
                solar: 0, wind: 1, offshoreWind: 0, nuclear: 10, geothermal: 5, biomass: 10, rng: 50, hydrogen: 410, // $/MWh - includes green H2 fuel cost (~$6/kg at 45% efficiency)
                naturalGasCCGT: { start: 35, end: 80 }, // NEW: $/MWh
                naturalGasCT: { start: 100, end: 150 }, // NEW: $/MWh
                hydro: 5, coal: 30, // $/MWh
                battery4hr: 0, battery8hr: 2, longduration: 1,
                dac: 400, // $/ton
                storage: 30 // $/MWh - an assumed opportunity cost for dispatching storage
            },
            lifetime: {
                solar: 30, wind: 30, offshoreWind: 30, nuclear: 60, geothermal: 30, biomass: 25, rng: 25, hydrogen: 30,
                naturalGas: 30, hydro: 80, coal: 40,
                battery4hr: 15, battery8hr: 15, longduration: 25, dac: 25
            },
            capacity_factor: {
                solar: 0.25, wind: 0.35, offshoreWind: 0.50, nuclear: 0.9, geothermal: 0.9, biomass: 0.85, rng: 0.85, hydrogen: 0.20,
                naturalGas: 0.55, hydro: 0.45, coal: 0.6
            },
            discount_rate: 0.07
        };

        document.addEventListener('DOMContentLoaded', async function () {
            setLogLevel('debug');

            // --- DOM ELEMENTS ---
            const sliders = {
                solar: document.getElementById('solar-slider'), wind: document.getElementById('wind-slider'), offshoreWind: document.getElementById('offshoreWind-slider'),
                geothermal: document.getElementById('geothermal-slider'), nuclear: document.getElementById('nuclear-slider'),
                biomass: document.getElementById('biomass-slider'), rng: document.getElementById("rng-slider"), hydrogen: document.getElementById("hydrogen-slider"),
                battery4hr: document.getElementById('battery4hr-slider'), battery8hr: document.getElementById('battery8hr-slider'),
                longduration: document.getElementById('longduration-slider'), demandflex: document.getElementById('demandflex-slider'),
                dac: document.getElementById('dac-slider'), solarIncentive: document.getElementById('solar-incentive-slider'),
                windIncentive: document.getElementById('wind-incentive-slider'), offshoreWindIncentive: document.getElementById('offshoreWind-incentive-slider'),
                geothermalIncentive: document.getElementById('geothermal-incentive-slider'),
                nuclearIncentive: document.getElementById('nuclear-incentive-slider'), biomassIncentive: document.getElementById('biomass-incentive-slider'),
                rngIncentive: document.getElementById("rng-incentive-slider"), hydrogenIncentive: document.getElementById("hydrogen-incentive-slider"),
                storageIncentive: document.getElementById('storage-incentive-slider'),
                dacIncentive: document.getElementById('dac-incentive-slider'), carbonTax: document.getElementById('carbon-tax-slider'),
                exportPrice: document.getElementById('export-price-slider'),
            };
            const inputs = {
                solar: document.getElementById('solar-input'), wind: document.getElementById('wind-input'), offshoreWind: document.getElementById('offshoreWind-input'),
                geothermal: document.getElementById('geothermal-input'), nuclear: document.getElementById('nuclear-input'),
                biomass: document.getElementById('biomass-input'), rng: document.getElementById("rng-input"), hydrogen: document.getElementById("hydrogen-input"),
                battery4hr: document.getElementById('battery4hr-input'), battery8hr: document.getElementById('battery8hr-input'),
                longduration: document.getElementById('longduration-input'), demandflex: document.getElementById('demandflex-input'),
                dac: document.getElementById('dac-input'), solarIncentive: document.getElementById('solar-incentive-input'),
                windIncentive: document.getElementById('wind-incentive-input'), offshoreWindIncentive: document.getElementById('offshoreWind-incentive-input'),
                geothermalIncentive: document.getElementById('geothermal-incentive-input'),
                nuclearIncentive: document.getElementById('nuclear-incentive-input'), biomassIncentive: document.getElementById('biomass-incentive-input'),
                rngIncentive: document.getElementById("rng-incentive-input"), hydrogenIncentive: document.getElementById("hydrogen-incentive-input"),
                storageIncentive: document.getElementById('storage-incentive-input'),
                dacIncentive: document.getElementById('dac-incentive-input'), carbonTax: document.getElementById('carbon-tax-input'),
                exportPrice: document.getElementById('export-price-input'),
            };

            const billImpactEl = document.getElementById('bill-impact');
            const systemCostImpactEl = document.getElementById('system-cost-impact');
            const co2AvoidedEl = document.getElementById('co2-avoided-text');
            const resetToZeroButton = document.getElementById('reset-to-zero-button');
            const makeDefaultButton = document.getElementById('make-default-button');
            const resetToDefaultButton = document.getElementById('reset-to-default-button');
            const undoButton = document.getElementById('undo-button');
            const redoButton = document.getElementById('redo-button');
            const gridMixSlidersContainer = document.getElementById('grid-mix-sliders');
            const storageCapacityDisplayContainer = document.getElementById('storage-capacity-display');
            const generationMixSlidersContainer = document.getElementById('generation-mix-sliders');
            const countrySelect = document.getElementById('country-select');
            const hoverTooltip = document.getElementById('hover-tooltip');
            const startTutorialBtn = document.getElementById('start-tutorial-btn');

            const currentDemandProfileText = document.getElementById('current-demand-profile-text');
            const editDemandBtn = document.getElementById('edit-demand-btn');
            const confirmDemandBtn = document.getElementById('confirm-demand-btn');
            const revertDemandBtn = document.getElementById('revert-demand-btn');
            const demandPresetsDiv = document.getElementById('demand-presets');

            const currentCFProfileText = document.getElementById('current-cf-profile-text');
            const editCFBtn = document.getElementById('edit-cf-btn');
            const confirmCFBtn = document.getElementById('confirm-cf-btn');
            const revertCFBtn = document.getElementById('revert-cf-btn');
            const cfPresetsDiv = document.getElementById('cf-presets');
            const visitorCountEl = document.getElementById('visitor-count');


            // --- STATE MANAGEMENT ---
            let stateHistory = [];
            let historyIndex = -1;
            let userDefaultState = {};
            let systemDefaultState = {};
            let customBaselineSystemCost = 0;
            let customBaselineConsumerCost = 0; // NEW
            let customBaselineTotalAnnualCO2 = 0;
            let enabledTechnologies = {};
            let defaultCapacityMix = {};
            let defaultGenerationMix = {};
            let currentSystemDefaultProfileName = 'spring-typical';

            let isDemandEditMode = false;
            let currentDemand = [...SEASONAL_DEMAND_PROFILES['spring-high']];
            let originalDemandBeforeEdit = [];
            let currentDemandProfileName = 'Spring Typical';

            let isCFEditMode = false;
            let currentSolarCFProfile = [];
            let currentWindCFProfile = [];
            let currentOffshoreWindCFProfile = [];
            let currentHydroCF = SEASONAL_HYDRO_CF.spring; // Initialize with spring
            let originalSolarCFBeforeEdit = [];
            let originalWindCFBeforeEdit = [];
            let originalOffshoreWindCFBeforeEdit = [];
            let currentCFProfileName = 'Spring';


            // --- CHARTING SETUP ---
            const generationCtx = document.getElementById('generationMixChart').getContext('2d');
            const marginalPriceCtx = document.getElementById('marginalPriceChart').getContext('2d'); // NEW
            const co2Ctx = document.getElementById('co2EmissionsChart').getContext('2d');
            const capacityFactorCtx = document.getElementById('capacityFactorChart').getContext('2d');

            const COLORS = {
                naturalGas: 'rgba(107, 114, 128, 0.8)', hydro: 'rgba(59, 130, 246, 0.8)',
                nuclear: 'rgba(239, 68, 68, 0.8)', solar: 'rgba(251, 191, 36, 1)',
                wind: 'rgba(52, 211, 153, 0.8)', /* CHANGE: Lighter green for Onshore Wind */
                offshoreWind: 'rgba(12, 148, 103, 0.8)',
                geothermal: 'rgba(120, 40, 40, 0.8)',
                biomass: 'rgba(101, 67, 33, 0.8)',
                rng: 'rgba(132, 204, 22, 0.8)',
                hydrogen: 'rgba(219, 39, 119, 0.8)', /* Pink/magenta for hydrogen */
                storage: 'rgba(168, 85, 247, 0.8)', demand: 'rgba(17, 24, 39, 1)',
                curtailment: 'rgba(253, 186, 116, 0.8)', coal: 'rgba(0, 0, 0, 0.8)',
                price: 'rgba(79, 70, 229, 1)' // NEW for price chart
            };

            // Helper function to create a patterned fill for "to Storage" generation
            function createPattern(baseColor, patternColor) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 10;
                canvas.height = 10;
                ctx.fillStyle = baseColor;
                ctx.fillRect(0, 0, 10, 10);
                ctx.strokeStyle = patternColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, 10);
                ctx.lineTo(10, 0);
                ctx.moveTo(-1, 1);
                ctx.lineTo(1, -1);
                ctx.moveTo(9, 11);
                ctx.lineTo(11, 9);
                ctx.stroke();
                return ctx.createPattern(canvas, 'repeat');
            }

            const PATTERNS = {
                solarToStorage: createPattern(COLORS.solar, 'rgba(168, 85, 247, 0.7)'),
                windToStorage: createPattern(COLORS.wind, 'rgba(168, 85, 247, 0.7)'),
                offshoreWindToStorage: createPattern(COLORS.offshoreWind, 'rgba(168, 85, 247, 0.7)'),
                hydroToStorage: createPattern(COLORS.hydro, COLORS.storage),
                geothermalToStorage: createPattern(COLORS.geothermal, COLORS.storage),
                nuclearToStorage: createPattern(COLORS.nuclear, COLORS.storage),
                coalToStorage: createPattern(COLORS.coal, COLORS.storage),
                naturalGasToStorage: createPattern(COLORS.naturalGas, COLORS.storage),
                biomassToStorage: createPattern(COLORS.biomass, COLORS.storage),
            };

            const generationChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [
                        { label: 'Nuclear', data: [], backgroundColor: COLORS.nuclear, borderColor: COLORS.nuclear, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Geothermal', data: [], backgroundColor: COLORS.geothermal, borderColor: COLORS.geothermal, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Biomass', data: [], backgroundColor: COLORS.biomass, borderColor: COLORS.biomass, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'RNG (Biogas)', data: [], backgroundColor: COLORS.rng, borderColor: COLORS.rng, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Hydrogen', data: [], backgroundColor: COLORS.hydrogen, borderColor: COLORS.hydrogen, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Hydro', data: [], backgroundColor: COLORS.hydro, borderColor: COLORS.hydro, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Onshore Wind', data: [], backgroundColor: COLORS.wind, borderColor: COLORS.wind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Offshore Wind', data: [], backgroundColor: COLORS.offshoreWind, borderColor: COLORS.offshoreWind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Solar', data: [], backgroundColor: COLORS.solar, borderColor: COLORS.solar, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Natural Gas', data: [], backgroundColor: COLORS.naturalGas, borderColor: COLORS.naturalGas, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Coal', data: [], backgroundColor: COLORS.coal, borderColor: COLORS.coal, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Storage', data: [], backgroundColor: COLORS.storage, borderColor: COLORS.storage, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Solar to Storage', data: [], backgroundColor: PATTERNS.solarToStorage, borderColor: COLORS.solar, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Onshore Wind to Storage', data: [], backgroundColor: PATTERNS.windToStorage, borderColor: COLORS.wind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Offshore Wind to Storage', data: [], backgroundColor: PATTERNS.offshoreWindToStorage, borderColor: COLORS.offshoreWind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Curtailment', data: [], backgroundColor: COLORS.curtailment, borderColor: COLORS.curtailment, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Demand', data: currentDemand, type: 'line', borderColor: COLORS.demand, borderWidth: 1.5, pointRadius: 0, fill: false, order: -1 }
                    ]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                title: function (context) {
                                    return context[0].label;
                                },
                                label: function (context) {
                                    return ''; // We build the full tooltip in the footer
                                },
                                footer: function (tooltipItems) {
                                    const totals = {};
                                    let stackTotal = 0;

                                    tooltipItems.forEach(function (tooltipItem) {
                                        let label = tooltipItem.dataset.label;
                                        const value = tooltipItem.raw;
                                        if (value === 0) return;

                                        // Consolidate "to Storage" tooltips
                                        if (label.includes('to Storage')) {
                                            const sourceTech = label.replace(' to Storage', '');
                                            label = `${sourceTech} (to Storage)`;
                                        }

                                        totals[label] = (totals[label] || 0) + value;

                                        if (tooltipItem.dataset.type !== 'line') {
                                            if (!label.includes('to Storage') && label !== 'Curtailment') {
                                                stackTotal += value;
                                            }
                                        }
                                    });

                                    const lines = [];
                                    const tooltipOrder = ['Coal', 'Natural Gas', 'Hydro', 'Geothermal', 'Biomass', 'RNG (Biogas)', 'Hydrogen', 'Nuclear', 'Solar', 'Onshore Wind', 'Offshore Wind', 'Storage', 'Curtailment', 'Solar (to Storage)', 'Onshore Wind (to Storage)', 'Offshore Wind (to Storage)', 'Demand'];
                                    tooltipOrder.forEach(label => {
                                        if (totals[label] > 0.01) {
                                            lines.push(`${label}: ${totals[label].toFixed(2)}`);
                                        }
                                    });

                                    if (stackTotal > 0) {
                                        lines.push('------------------');
                                        lines.push(`Total Gen to Grid: ${stackTotal.toFixed(2)}`);
                                    }
                                    return lines;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                filter: function (legendItem) {
                                    return !legendItem.text.includes('to Storage') && legendItem.text !== 'Demand';
                                }
                            }
                        },
                        dragData: { enabled: false }
                    },
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Hour of Day' } },
                        y: { stacked: true, title: { display: true, text: 'Generation (GWh)' } }
                    }
                }
            };
            const marginalPriceChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [{
                        label: 'Marginal Price (with Storage)', data: [],
                        borderColor: COLORS.price, backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true, tension: 0.3, pointRadius: 0
                    }, {
                        label: 'Marginal Price (without Storage)', data: [],
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderDash: [5, 5],
                        fill: false, tension: 0.3, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    scales: {
                        x: { title: { display: true, text: 'Month & Hour' }, ticks: { maxTicksLimit: 12 } },
                        y: { title: { display: true, text: 'Price ($/MWh)' } }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            };
            const co2ChartConfig = {
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: 'Total CO2 Emissions (Metric Tons)', data: [],
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Total CO2 (Metric Tons)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                totalCO2: {
                                    type: 'label',
                                    content: 'Total Annual CO2: 0 tons',
                                    position: { x: 'center', y: 'top' },
                                    yAdjust: 10,
                                    backgroundColor: 'rgba(249, 250, 251, 0.85)',
                                    borderColor: 'rgba(209, 213, 219, 1)',
                                    borderWidth: 1,
                                    borderRadius: 6,
                                    color: '#1f2937',
                                    font: { weight: 'bold', size: 16 },
                                    padding: 8,
                                }
                            }
                        }
                    }
                }
            };
            const capacityFactorChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [
                        { label: 'Solar', data: [], borderColor: COLORS.solar, borderWidth: 3, pointRadius: 0, fill: false, tension: 0.4, dragData: false },
                        { label: 'Onshore Wind', data: [], borderColor: COLORS.wind, borderWidth: 3, pointRadius: 0, fill: false, tension: 0.4, dragData: false },
                        { label: 'Offshore Wind', data: [], borderColor: COLORS.offshoreWind, borderWidth: 3, pointRadius: 0, fill: false, tension: 0.4, dragData: false }
                    ]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    plugins: {
                        legend: { position: 'bottom' },
                        dragData: {
                            round: 2,
                            showTooltip: true,
                            onDrag: (e, datasetIndex, index, value) => {
                                // Enforce constraints DURING dragging for real-time feedback
                                if (value < 0) return 0;
                                if (value > 1) return 1;
                                return value;
                            },
                            onDragEnd: (e, datasetIndex, index, value) => {
                                const chart = e.chart;
                                let updatedValue = value;
                                if (value < 0) updatedValue = 0;
                                if (value > 1) updatedValue = 1;
                                chart.data.datasets[datasetIndex].data[index] = updatedValue;
                                chart.update('none');
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Hour of Day' } },
                        y: { title: { display: true, text: 'Capacity Factor (%)' }, min: 0, max: 1, ticks: { callback: value => `${value * 100}%` } }
                    }
                }
            };

            const generationChart = new Chart(generationCtx, generationChartConfig);
            const marginalPriceChart = new Chart(marginalPriceCtx, marginalPriceChartConfig); // NEW
            const co2Chart = new Chart(co2Ctx, co2ChartConfig);
            const capacityFactorChart = new Chart(capacityFactorCtx, capacityFactorChartConfig);


            // --- COST CALCULATION ---
            function calculateTotalAnnualSystemCost(generation, capacity, currentIncentives, curtailedEnergy, baselineCapacity, baselineStorage, gasGenDetails) {
                let totalAnnualCost = 0;
                const d = COST_DATA.discount_rate;
                const numHours = generation.solar.length;
                const hoursPerMonth = 24;

                function getAnnualSum(profile) {
                    if (!profile) return 0;
                    let sum = 0;
                    for (let i = 0; i < numHours; i++) {
                        const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                        sum += profile[i] * DAYS_IN_MONTH[monthIndex];
                    }
                    return sum;
                }

                for (const tech in COST_DATA.capacity_factor) {
                    if (tech === 'naturalGas') continue;

                    const techData = COST_DATA;
                    if (!techData.lifetime[tech]) continue;
                    const n = techData.lifetime[tech];
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                    const baselineCapacityGW = baselineCapacity[tech] || 0;
                    const newCapacityGW = capacity[tech] || 0;
                    const totalCapacityKW = (baselineCapacityGW + newCapacityGW) * 1000000;

                    if (totalCapacityKW > 0) {
                        const annualized_capex = techData.capex[tech] * totalCapacityKW * crf;
                        const annual_fom = techData.fixed_om[tech] * totalCapacityKW;
                        const annual_generation_mwh = getAnnualSum(generation[tech]) * 1000;
                        const annual_vom = techData.variable_om[tech] * annual_generation_mwh;

                        let annual_ptc = 0;
                        if (currentIncentives[tech]) {
                            annual_ptc = currentIncentives[tech] * annual_generation_mwh;
                        }

                        totalAnnualCost += annualized_capex + annual_fom + annual_vom - annual_ptc;
                    }
                }

                const baselineNGCapacityGW = baselineCapacity.naturalGas || 0;
                const newNGCapacityGW = capacity.naturalGas || 0;
                const totalNGCapacityKW = (baselineNGCapacityGW + newNGCapacityGW) * 1000000;

                if (totalNGCapacityKW > 0) {
                    const n = COST_DATA.lifetime.naturalGas;
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);
                    const annualized_capex = COST_DATA.capex.naturalGas * totalNGCapacityKW * crf;
                    const annual_fom = COST_DATA.fixed_om.naturalGas * totalNGCapacityKW;
                    const annual_vom_ng = (gasGenDetails?.ccgt?.cost || 0) + (gasGenDetails?.ct?.cost || 0);
                    totalAnnualCost += annualized_capex + annual_fom + annual_vom_ng;
                }

                for (const type of ['battery4hr', 'battery8hr', 'longduration']) {
                    if (!enabledTechnologies[type]) continue;
                    const baseline_gwh = baselineStorage[type] || 0;
                    const new_gwh = capacity[type] || 0;
                    const total_gwh = baseline_gwh + new_gwh;

                    if (total_gwh > 0) {
                        if (!COST_DATA.lifetime[type]) continue;
                        const n = COST_DATA.lifetime[type];
                        const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                        let capex_per_kwh = COST_DATA.capex[type] - currentIncentives.storage;
                        const total_kwh = total_gwh * 1000000;
                        const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                        const total_kw = total_kwh / duration;

                        const annualized_capex = capex_per_kwh * total_kwh * crf;
                        const annual_fom = COST_DATA.fixed_om[type] * total_kw;
                        const annual_discharge_mwh = getAnnualSum(generation.storage) * 1000;
                        const annual_vom = COST_DATA.variable_om[type] * annual_discharge_mwh;

                        totalAnnualCost += annualized_capex + annual_fom + annual_vom;
                    }
                }

                if (capacity.dac > 0) {
                    const annualDacCapacityTons = capacity.dac * 24 * 365;
                    const n = COST_DATA.lifetime.dac;
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                    const annualizedDacCapex = COST_DATA.capex.dac * annualDacCapacityTons * crf;
                    const annualDacFom = COST_DATA.fixed_om.dac * annualDacCapacityTons;
                    const dacVariableCost = annualDacCapacityTons * COST_DATA.variable_om.dac;
                    const dacIncentiveValue = annualDacCapacityTons * currentIncentives.dac;

                    totalAnnualCost += (annualizedDacCapex + annualDacFom + dacVariableCost - dacIncentiveValue);
                }

                const totalAnnualCO2 = getAnnualSum(calculateEmissions(generation, 0));
                totalAnnualCost += totalAnnualCO2 * currentIncentives.carbonTax;

                const annualExportRevenue = getAnnualSum(curtailedEnergy) * 1000 * currentIncentives.exportPrice;
                totalAnnualCost -= annualExportRevenue;

                return totalAnnualCost;
            }

            // NEW: Function to calculate consumer cost based on marginal price
            function calculateAnnualConsumerCost(hourlyMarginalPrice, demand) {
                let totalCost = 0;
                const numHours = hourlyMarginalPrice.length;
                const hoursPerMonth = 24;
                for (let i = 0; i < numHours; i++) {
                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    totalCost += hourlyMarginalPrice[i] * demand[i] * 1000 * DAYS_IN_MONTH[monthIndex];
                }
                return totalCost;
            }


            // --- REWRITTEN DISPATCH LOGIC ---
            function getSimulationResult(inputs, solarProfile, windProfile, offshoreWindProfile, potentialGen, baselineStorageGWh = {}, hydroCF, countryName, storageOverrideDisabled = false) {
                const VRE_SOURCES = ['solar', 'wind', 'offshoreWind'];
                const INFLEXIBLE_SOURCES = ['nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                const numHours = solarProfile.length;

                let finalGeneration = {
                    coal: Array(numHours).fill(0), naturalGas: Array(numHours).fill(0),
                    hydro: Array(numHours).fill(0), nuclear: Array(numHours).fill(0),
                    geothermal: Array(numHours).fill(0), biomass: Array(numHours).fill(0), rng: Array(numHours).fill(0), hydrogen: Array(numHours).fill(0),
                    solar: Array(numHours).fill(0), wind: Array(numHours).fill(0), offshoreWind: Array(numHours).fill(0),
                    storage: Array(numHours).fill(0), curtailment: Array(numHours).fill(0),
                    solarToStorage: Array(numHours).fill(0), windToStorage: Array(numHours).fill(0), offshoreWindToStorage: Array(numHours).fill(0)
                };

                let curtailmentBySource = { solar: Array(numHours).fill(0), wind: Array(numHours).fill(0), offshoreWind: Array(numHours).fill(0) };

                let modifiedDemand = [...currentDemand];

                if (inputs.capacity.demandflex > 0) {
                    for (let dayStart = 0; dayStart < numHours; dayStart += 24) {
                        const dayLoad = modifiedDemand.slice(dayStart, dayStart + 24);
                        const originalPeak = Math.max(...dayLoad);
                        let totalAmountToShift = originalPeak * (inputs.capacity.demandflex / 100);

                        const shiftIncrement = 0.1;
                        let iterations = 0;
                        while (totalAmountToShift > 0.01 && iterations < 100) {
                            const currentPeak = Math.max(...dayLoad);
                            const currentTrough = Math.min(...dayLoad);
                            if (currentPeak <= currentTrough) break;

                            const peakIndex = dayLoad.indexOf(currentPeak);
                            const troughIndex = dayLoad.indexOf(currentTrough);

                            const amount = Math.min(shiftIncrement, totalAmountToShift);
                            dayLoad[peakIndex] -= amount;
                            dayLoad[troughIndex] += amount;

                            modifiedDemand[dayStart + peakIndex] -= amount;
                            modifiedDemand[dayStart + troughIndex] += amount;

                            totalAmountToShift -= amount;
                            iterations++;
                        }
                    }
                }


                let currentPotential = JSON.parse(JSON.stringify(potentialGen));

                // Ensure all technology arrays exist and are correctly sized to numHours
                const allTechs = ['solar', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen', 'hydro', 'naturalGas', 'coal'];
                for (const tech of allTechs) {
                    if (!currentPotential[tech] || currentPotential[tech].length !== numHours) {
                        // If array is missing or wrong size, create/resize it
                        const existingArray = currentPotential[tech] || [];
                        currentPotential[tech] = Array(numHours).fill(0);
                        // Copy existing values if any
                        for (let j = 0; j < Math.min(existingArray.length, numHours); j++) {
                            currentPotential[tech][j] = existingArray[j] || 0;
                        }
                        // For arrays that were shorter, repeat the 24-hour pattern
                        if (existingArray.length === 24 && numHours > 24) {
                            for (let j = 24; j < numHours; j++) {
                                currentPotential[tech][j] = existingArray[j % 24] || 0;
                            }
                        }
                    }
                }

                for (let i = 0; i < numHours; i++) {
                    currentPotential.solar[i] += inputs.capacity.solar * solarProfile[i];
                    currentPotential.wind[i] += inputs.capacity.wind * windProfile[i];
                    currentPotential.offshoreWind[i] += inputs.capacity.offshoreWind * offshoreWindProfile[i];
                    currentPotential.nuclear[i] += inputs.capacity.nuclear * COST_DATA.capacity_factor.nuclear;
                    currentPotential.geothermal[i] += inputs.capacity.geothermal * COST_DATA.capacity_factor.geothermal;
                    currentPotential.biomass[i] += inputs.capacity.biomass * COST_DATA.capacity_factor.biomass;
                    currentPotential.rng[i] += inputs.capacity.rng * COST_DATA.capacity_factor.rng;
                    currentPotential.hydrogen[i] += inputs.capacity.hydrogen * COST_DATA.capacity_factor.hydrogen;
                }
                const hydroCapacity = (currentCountryInstalledCapacity.hydro || 0) + (inputs.capacity.hydro || 0);
                const maxHourlyHydroOutput = countryName === 'California' ? hydroCapacity * 0.32 : hydroCapacity;

                let netLoad = Array(numHours).fill(0);
                for (let i = 0; i < numHours; i++) {
                    let vreAndInflexibleGen = 0;
                    [...INFLEXIBLE_SOURCES, ...VRE_SOURCES].forEach(tech => {
                        const potential = currentPotential[tech][i];
                        finalGeneration[tech][i] = potential;
                        vreAndInflexibleGen += potential;
                    });
                    netLoad[i] = modifiedDemand[i] - vreAndInflexibleGen;
                }

                if (!storageOverrideDisabled) {
                    const storageDispatch = dispatchStorageEconomically(netLoad, inputs, baselineStorageGWh, currentPotential);
                    finalGeneration.storage = storageDispatch.discharge;

                    for (let i = 0; i < numHours; i++) {
                        netLoad[i] += storageDispatch.charge[i];
                        netLoad[i] -= storageDispatch.discharge[i];

                        if (storageDispatch.charge[i] > 0) {
                            let totalVrePotential = finalGeneration.solar[i] + finalGeneration.wind[i] + finalGeneration.offshoreWind[i];
                            if (totalVrePotential > 0) {
                                const vreChargeAmount = Math.min(storageDispatch.charge[i], totalVrePotential);
                                let solarCharge = (finalGeneration.solar[i] / totalVrePotential) * vreChargeAmount;
                                let windCharge = (finalGeneration.wind[i] / totalVrePotential) * vreChargeAmount;
                                let offshoreCharge = (finalGeneration.offshoreWind[i] / totalVrePotential) * vreChargeAmount;

                                finalGeneration.solarToStorage[i] = solarCharge = Math.min(solarCharge, finalGeneration.solar[i]);
                                finalGeneration.windToStorage[i] = windCharge = Math.min(windCharge, finalGeneration.wind[i]);
                                finalGeneration.offshoreWindToStorage[i] = offshoreCharge = Math.min(offshoreCharge, finalGeneration.offshoreWind[i]);

                                finalGeneration.solar[i] -= solarCharge;
                                finalGeneration.wind[i] -= windCharge;
                                finalGeneration.offshoreWind[i] -= offshoreCharge;
                            }
                        }
                    }
                }

                for (let i = 0; i < numHours; i++) {
                    if (netLoad[i] < 0) {
                        finalGeneration.curtailment[i] = -netLoad[i];
                        let availableForCurtailment = 0;
                        VRE_SOURCES.forEach(tech => availableForCurtailment += finalGeneration[tech][i]);

                        if (availableForCurtailment > 0) {
                            VRE_SOURCES.forEach(tech => {
                                const proportion = finalGeneration[tech][i] / availableForCurtailment;
                                const reduction = Math.min(finalGeneration.curtailment[i] * proportion, finalGeneration[tech][i]);
                                curtailmentBySource[tech][i] += reduction;
                                finalGeneration[tech][i] -= reduction;
                            });
                        }
                        netLoad[i] = 0;
                    }
                }

                for (let dayStart = 0; dayStart < numHours; dayStart += 24) {
                    const dayNetLoad = netLoad.slice(dayStart, dayStart + 24);
                    const totalDailyHydroEnergy = hydroCapacity * hydroCF * 24;
                    const baseloadHydroEnergy = totalDailyHydroEnergy * 0.40;
                    let flexibleHydroEnergy = totalDailyHydroEnergy * 0.60;

                    const deficitHours = dayNetLoad.map((load, h) => load > 0.01 ? h + dayStart : -1).filter(h => h !== -1);
                    if (deficitHours.length > 0) {
                        const hourlyBaseloadHydro = baseloadHydroEnergy / deficitHours.length;
                        deficitHours.forEach(i => {
                            const hydroToDispatch = Math.min(hourlyBaseloadHydro, netLoad[i], maxHourlyHydroOutput - finalGeneration.hydro[i]);
                            finalGeneration.hydro[i] += hydroToDispatch;
                            netLoad[i] -= hydroToDispatch;
                        });
                    }
                    while (flexibleHydroEnergy > 0.01) {
                        let maxPriority = -Infinity, maxPriorityHour = -1;
                        for (let i = dayStart; i < dayStart + 24; i++) {
                            if (netLoad[i] > 0.01 && netLoad[i] > maxPriority) {
                                maxPriority = netLoad[i];
                                maxPriorityHour = i;
                            }
                        }
                        if (maxPriorityHour === -1) break;
                        const hydroToDispatch = Math.min(0.1, flexibleHydroEnergy, netLoad[maxPriorityHour], maxHourlyHydroOutput - finalGeneration.hydro[maxPriorityHour]);
                        if (hydroToDispatch < 0.001) break;
                        finalGeneration.hydro[maxPriorityHour] += hydroToDispatch;
                        netLoad[maxPriorityHour] -= hydroToDispatch;
                        flexibleHydroEnergy -= hydroToDispatch;
                    }
                }

                const { gasGenDetails, hourlyMarginalPrice, thermalGeneration } = calculateThermalDispatchAndPrice(netLoad, inputs, currentPotential);
                finalGeneration.naturalGas = thermalGeneration.naturalGas;
                finalGeneration.coal = thermalGeneration.coal;

                for (let i = 0; i < numHours; i++) {
                    if (finalGeneration.curtailment[i] > 0.01) {
                        hourlyMarginalPrice[i] = inputs.incentives.exportPrice;
                    }
                }

                const newEmissions = calculateEmissions(finalGeneration, inputs.capacity.dac);
                const newSystemCost = calculateTotalAnnualSystemCost(finalGeneration, inputs.capacity, inputs.incentives, finalGeneration.curtailment, currentCountryInstalledCapacity, baselineStorageGWh, gasGenDetails);

                return {
                    generation: finalGeneration,
                    emissions: newEmissions,
                    systemCost: newSystemCost,
                    demand: modifiedDemand,
                    curtailmentBySource: curtailmentBySource,
                    hourlyMarginalPrice: hourlyMarginalPrice
                };
            }

            function calculateThermalDispatchAndPrice(netLoad, inputs, currentPotential) {
                const gasGenDetails = { ccgt: { generation: 0, cost: 0 }, ct: { generation: 0, cost: 0 } };
                const numHours = netLoad.length;
                const hourlyMarginalPrice = Array(numHours).fill(0);
                const thermalGeneration = { naturalGas: Array(numHours).fill(0), coal: Array(numHours).fill(0) };

                const totalNGCapacity = (currentCountryInstalledCapacity.naturalGas || 0) + (inputs.capacity.naturalGas || 0);
                const ccgtCapacity = totalNGCapacity * 0.7;
                const ctCapacity = totalNGCapacity * 0.3;

                const hoursPerMonth = 24;

                for (let i = 0; i < numHours; i++) {
                    let remainingLoad = netLoad[i];
                    let hourlyPrice = 0;

                    if (remainingLoad <= 0.01) {
                        hourlyMarginalPrice[i] = 0;
                        continue;
                    }

                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    const days = DAYS_IN_MONTH[monthIndex];

                    if (ccgtCapacity > 0) {
                        const ccgtToDispatch = Math.min(remainingLoad, ccgtCapacity);
                        if (ccgtToDispatch > 0) {
                            thermalGeneration.naturalGas[i] += ccgtToDispatch;
                            remainingLoad -= ccgtToDispatch;
                            const costStart = COST_DATA.variable_om.naturalGasCCGT.start;
                            const costEnd = COST_DATA.variable_om.naturalGasCCGT.end;
                            const priceAtDispatch = costStart + (costEnd - costStart) * (ccgtToDispatch / ccgtCapacity);
                            hourlyPrice = Math.max(hourlyPrice, priceAtDispatch);
                            const avgCost = (costStart + priceAtDispatch) / 2;
                            gasGenDetails.ccgt.cost += ccgtToDispatch * 1000 * avgCost * days;
                        }
                    }

                    if (remainingLoad > 0.01 && ctCapacity > 0) {
                        const ctToDispatch = Math.min(remainingLoad, ctCapacity);
                        if (ctToDispatch > 0) {
                            thermalGeneration.naturalGas[i] += ctToDispatch;
                            remainingLoad -= ctToDispatch;
                            const costStart = COST_DATA.variable_om.naturalGasCT.start;
                            const costEnd = COST_DATA.variable_om.naturalGasCT.end;
                            const priceAtDispatch = costStart + (costEnd - costStart) * (ctToDispatch / ctCapacity);
                            hourlyPrice = Math.max(hourlyPrice, priceAtDispatch);
                            const avgCost = (costStart + priceAtDispatch) / 2;
                            gasGenDetails.ct.cost += ctToDispatch * 1000 * avgCost * days;
                        }
                    }

                    if (remainingLoad > 0.01 && currentPotential.coal[i] > 0) {
                        const coalToDispatch = Math.min(remainingLoad, currentPotential.coal[i]);
                        thermalGeneration.coal[i] += coalToDispatch;
                        remainingLoad -= coalToDispatch;
                        hourlyPrice = Math.max(hourlyPrice, COST_DATA.variable_om.coal);
                    }
                    hourlyMarginalPrice[i] = hourlyPrice;
                }
                return { gasGenDetails, hourlyMarginalPrice, thermalGeneration };
            }

            function dispatchStorageEconomically(initialNetLoad, inputs, baselineStorageGWh, currentPotential) {
                const storageTypes = ['battery4hr', 'battery8hr', 'longduration'];
                const storageCapacityGWh = {};
                const storagePowerGW = {};
                let totalStorageEnergyGWh = 0;

                storageTypes.forEach(type => {
                    if (enabledTechnologies[type]) {
                        const capacity = (baselineStorageGWh[type] || 0) + inputs.capacity[type];
                        storageCapacityGWh[type] = capacity;
                        totalStorageEnergyGWh += capacity;
                        const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                        storagePowerGW[type] = capacity / duration;
                    } else {
                        storageCapacityGWh[type] = 0;
                        storagePowerGW[type] = 0;
                    }
                });

                const numHours = initialNetLoad.length;

                if (totalStorageEnergyGWh === 0) {
                    return { charge: Array(numHours).fill(0), discharge: Array(numHours).fill(0) };
                }

                let netLoad = [...initialNetLoad];
                let hourlyCharge = Array(numHours).fill(0);
                let hourlyDischarge = Array(numHours).fill(0);
                let totalChargedGWh = 0;

                const storageEfficiency = 0.85;
                const DISPATCH_INCREMENT = 0.1;
                const PROFIT_THRESHOLD = 20;

                for (let dayStart = 0; dayStart < numHours; dayStart += 24) {

                    let dayPotential = {};
                    for (let k in currentPotential) {
                        if (Array.isArray(currentPotential[k])) dayPotential[k] = currentPotential[k].slice(dayStart, dayStart + 24);
                    }

                    let dayNetLoad = netLoad.slice(dayStart, dayStart + 24);
                    let dayCharge = Array(24).fill(0);
                    let dayDischarge = Array(24).fill(0);

                    let dayTotalCharged = 0;

                    while (true) {
                        const { hourlyMarginalPrice } = calculateThermalDispatchAndPrice(dayNetLoad, inputs, dayPotential);

                        let maxPrice = -Infinity, minPrice = Infinity;
                        let maxPriceHour = -1, minPriceHour = -1;

                        // Find max and min prices
                        for (let i = 0; i < 24; i++) {
                            if (hourlyMarginalPrice[i] > maxPrice) { maxPrice = hourlyMarginalPrice[i]; }
                            if (hourlyMarginalPrice[i] < minPrice) { minPrice = hourlyMarginalPrice[i]; }
                        }

                        // Find all hours with maximum price, then pick the one with least existing discharge
                        // This spreads discharging across multiple high-price hours
                        const maxPriceHours = [];
                        for (let i = 0; i < 24; i++) {
                            if (Math.abs(hourlyMarginalPrice[i] - maxPrice) < 0.01) {
                                maxPriceHours.push(i);
                            }
                        }

                        if (maxPriceHours.length > 0) {
                            maxPriceHour = maxPriceHours[0];
                            let minExistingDischarge = dayDischarge[maxPriceHours[0]];
                            for (let j = 1; j < maxPriceHours.length; j++) {
                                const hour = maxPriceHours[j];
                                if (dayDischarge[hour] < minExistingDischarge) {
                                    minExistingDischarge = dayDischarge[hour];
                                    maxPriceHour = hour;
                                }
                            }
                        }

                        // Find all hours with minimum price, then pick the one with least existing charge
                        // This spreads charging across multiple low-price hours instead of concentrating it
                        const minPriceHours = [];
                        for (let i = 0; i < 24; i++) {
                            if (Math.abs(hourlyMarginalPrice[i] - minPrice) < 0.01) {
                                minPriceHours.push(i);
                            }
                        }

                        if (minPriceHours.length > 0) {
                            // Pick the hour with the least existing charge to spread charging out
                            minPriceHour = minPriceHours[0];
                            let minExistingCharge = dayCharge[minPriceHours[0]];
                            for (let j = 1; j < minPriceHours.length; j++) {
                                const hour = minPriceHours[j];
                                if (dayCharge[hour] < minExistingCharge) {
                                    minExistingCharge = dayCharge[hour];
                                    minPriceHour = hour;
                                }
                            }
                        }

                        if ((maxPrice * storageEfficiency) - minPrice <= PROFIT_THRESHOLD || maxPriceHour === -1 || minPriceHour === -1) break;

                        let availableCharge = 0, availableDischarge = 0;
                        storageTypes.forEach(t => { availableCharge += storagePowerGW[t]; availableDischarge += storagePowerGW[t]; });

                        const chargeHeadroom = availableCharge - dayCharge[minPriceHour];
                        const dischargeHeadroom = availableDischarge - dayDischarge[maxPriceHour];
                        const energyHeadroom = totalStorageEnergyGWh - dayTotalCharged;

                        const dispatchAmount = Math.min(DISPATCH_INCREMENT, chargeHeadroom, dischargeHeadroom, energyHeadroom);
                        if (dispatchAmount < 0.01) break;

                        const chargeAmount = dispatchAmount / storageEfficiency;
                        dayCharge[minPriceHour] += chargeAmount;
                        dayDischarge[maxPriceHour] += dispatchAmount;
                        dayTotalCharged += chargeAmount;

                        dayNetLoad[minPriceHour] += chargeAmount;
                        dayNetLoad[maxPriceHour] -= dispatchAmount;
                    }

                    for (let i = 0; i < 24; i++) {
                        hourlyCharge[dayStart + i] = dayCharge[i];
                        hourlyDischarge[dayStart + i] = dayDischarge[i];
                        netLoad[dayStart + i] = dayNetLoad[i];
                    }
                }

                return { charge: hourlyCharge, discharge: hourlyDischarge };
            }


            function runSimulation() {
                // Collect inputs
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                const selectedCountry = countrySelect.value;
                // If profiles aren't ready, use empty arrays (prevents crash on first load)
                const baseProfiles = {
                    solar: countryProfiles[selectedCountry]?.solar || countryProfiles['default'].solar,
                    wind: countryProfiles[selectedCountry]?.wind || countryProfiles['default'].wind,
                    offshoreWind: countryProfiles[selectedCountry]?.offshoreWind || countryProfiles['default'].offshoreWind
                };

                // Construct 12-month profiles
                const fullSolarProfile = [];
                const fullWindProfile = [];
                const fullOffshoreWindProfile = [];
                const fullDemand = [];

                // Map months to seasons (0=Jan, 11=Dec)
                const userSeasonMap = [
                    'winter', 'winter', // Jan, Feb
                    'spring', 'spring', 'spring', // Mar, Apr, May
                    'summer', 'summer', 'summer', 'summer', // Jun, Jul, Aug, Sep
                    'fall', 'fall', // Oct, Nov
                    'winter' // Dec
                ];

                // Determine if we are using High or Typical demand based on current selection
                const isHighDemand = currentDemandProfileName.toLowerCase().includes('high');

                let activePotentialGeneration = {};
                if (typeof BASELINE_POTENTIAL_GENERATION !== 'undefined') {
                    for (const tech in BASELINE_POTENTIAL_GENERATION) {
                        activePotentialGeneration[tech] = [];
                    }
                }

                for (let m = 0; m < 12; m++) {
                    const season = userSeasonMap[m];
                    const seasonalMultipliers = SEASONAL_MULTIPLIERS[season] || { solar: 1.0, wind: 1.0, offshoreWind: 1.0 };

                    // Apply seasonal multipliers to base profiles to create monthly profiles
                    const sSolar = baseProfiles.solar.map(cf => Math.min(1, cf * seasonalMultipliers.solar));
                    const sWind = baseProfiles.wind.map(cf => Math.min(1, cf * seasonalMultipliers.wind));
                    const sOffshoreWind = baseProfiles.offshoreWind.map(cf => Math.min(1, cf * seasonalMultipliers.offshoreWind));

                    fullSolarProfile.push(...sSolar);
                    fullWindProfile.push(...sWind);
                    fullOffshoreWindProfile.push(...sOffshoreWind);

                    // Demand Generation - use the appropriate seasonal profile
                    // For typical: 'winter-typical', 'spring-typical', etc.
                    // For high: 'winter-high', 'spring-high', etc.
                    const demandType = isHighDemand ? 'high' : 'typical';
                    const demandKey = `${season}-${demandType}`;
                    const sDemand = SEASONAL_DEMAND_PROFILES[demandKey] || SEASONAL_DEMAND_PROFILES[`${season}-high`] || Array(24).fill(30);
                    fullDemand.push(...sDemand);

                    // Duplicate potential generation for 12 months
                    if (typeof BASELINE_POTENTIAL_GENERATION !== 'undefined') {
                        for (const tech in BASELINE_POTENTIAL_GENERATION) {
                            activePotentialGeneration[tech].push(...(BASELINE_POTENTIAL_GENERATION[tech] || Array(24).fill(0)));
                        }
                    }
                }

                currentDemand = fullDemand; // Update global currentDemand

                // DEBUG: Log array lengths to identify the issue
                console.log('DEBUG runSimulation:', {
                    fullDemandLength: fullDemand.length,
                    fullSolarProfileLength: fullSolarProfile.length,
                    fullWindProfileLength: fullWindProfile.length,
                    fullOffshoreWindProfileLength: fullOffshoreWindProfile.length,
                    activePotentialGenerationSolar: activePotentialGeneration.solar?.length,
                    activePotentialGenerationWind: activePotentialGeneration.wind?.length,
                    currentDemandLength: currentDemand.length,
                    firstFewDemandValues: fullDemand.slice(0, 5),
                    lastFewDemandValues: fullDemand.slice(-5)
                });

                const inputsForSim = {
                    capacity: {
                        solar: currentValues.solar,
                        wind: currentValues.wind,
                        offshoreWind: currentValues.offshoreWind,
                        geothermal: currentValues.geothermal,
                        nuclear: currentValues.nuclear,
                        biomass: currentValues.biomass,
                        rng: currentValues.rng,
                        hydrogen: currentValues.hydrogen,
                        battery4hr: currentValues.battery4hr,
                        battery8hr: currentValues.battery8hr,
                        longduration: currentValues.longduration,
                        dac: currentValues.dac,
                        hydro: 0,
                        naturalGas: 0,
                        coal: 0,
                        demandflex: currentValues.demandflex
                    },
                    incentives: {
                        solar: currentValues.solarIncentive,
                        wind: currentValues.windIncentive,
                        offshoreWind: currentValues.offshoreWindIncentive,
                        geothermal: currentValues.geothermalIncentive,
                        nuclear: currentValues.nuclearIncentive,
                        biomass: currentValues.biomassIncentive,
                        rng: currentValues.rngIncentive,
                        hydrogen: currentValues.hydrogenIncentive,
                        storage: currentValues.storageIncentive,
                        dac: currentValues.dacIncentive,
                        carbonTax: currentValues.carbonTax,
                        exportPrice: currentValues.exportPrice
                    }
                };

                const result = getSimulationResult(inputsForSim, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, activePotentialGeneration, currentBaselineStorage, currentHydroCF, selectedCountry);
                const resultWithoutStorage = getSimulationResult(inputsForSim, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, activePotentialGeneration, currentBaselineStorage, currentHydroCF, selectedCountry, true);

                const totalAnnualSystemCost = calculateTotalAnnualSystemCost(result.generation, inputsForSim.capacity, inputsForSim.incentives, result.curtailedEnergy, currentCountryInstalledCapacity, currentBaselineStorage, result.gasGenDetails);
                const annualConsumerCost = calculateAnnualConsumerCost(result.hourlyMarginalPrice, result.demand);

                const co2Avoided = customBaselineTotalAnnualCO2 - (result.totalAnnualCO2 || 0);
                const totalAnnualSystemCostBaseline = customBaselineSystemCost;
                const systemCostPercentageChange = totalAnnualSystemCostBaseline > 0 ? ((totalAnnualSystemCost - totalAnnualSystemCostBaseline) / totalAnnualSystemCostBaseline) * 100 : 0;

                const billPercentageChange = customBaselineConsumerCost > 0 ? ((annualConsumerCost - customBaselineConsumerCost) / customBaselineConsumerCost) * 100 : 0;

                // Calculate abatement cost
                // result.totalAnnualCO2 is just a sum of daily totals in getSimulationResult? No, getSimulationResult was updated to handle 288 hours?
                // Actually, getSimulationResult returns 'emissions' (288 array). 
                // We need to calculate totalAnnualCO2 carefully using DAYS_IN_MONTH weights here or trust the return value if I added it.
                // In my memory I didn't update getSimulationResult to return a sophisticated 'totalAnnualCO2' weighted sum.
                // So I will calculate it here to be safe and overwrite whatever 'result.totalAnnualCO2' says.

                let totalAnnualCO2 = 0;
                const hoursPerMonth = 24;
                for (let i = 0; i < result.emissions.length; i++) {
                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    totalAnnualCO2 += result.emissions[i] * DAYS_IN_MONTH[monthIndex];
                }

                const abatementCost = co2Avoided > 0 ? (totalAnnualSystemCost - totalAnnualSystemCostBaseline) / (co2Avoided / 1000) : 0;

                updateCharts(result.generation, result.emissions, result.demand, totalAnnualCO2, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, result.hourlyMarginalPrice, resultWithoutStorage.hourlyMarginalPrice);

                updateGridMixSlider(currentCountryInstalledCapacity, defaultCapacityMix);
                updateGenerationMixSlider(result.generation, defaultGenerationMix, result.curtailmentBySource);

                billImpactEl.textContent = `${billPercentageChange > 0 ? '+' : ''}${billPercentageChange.toFixed(0)}%`;
                systemCostImpactEl.textContent = `${systemCostPercentageChange > 0 ? '+' : ''}${systemCostPercentageChange.toFixed(0)}%`;

                [billImpactEl, systemCostImpactEl].forEach((el, index) => {
                    const change = index === 0 ? billPercentageChange : systemCostPercentageChange;
                    if (change > 0) {
                        el.className = 'text-5xl font-bold text-red-600 mt-2';
                    } else if (change < 0) {
                        el.className = 'text-5xl font-bold text-green-600 mt-2';
                    } else {
                        el.className = 'text-5xl font-bold text-blue-600 mt-2';
                    }
                });

                // Display CO2 Avoided
                const co2AvoidedPercent = customBaselineTotalAnnualCO2 > 0 ? (co2Avoided / customBaselineTotalAnnualCO2) * 100 : 0;

                if (Math.abs(co2Avoided) < 1) { // 1 ton tolerance
                    co2AvoidedEl.textContent = `CO2 avoided: 0 tons (0%)`;
                    co2AvoidedEl.className = 'text-md font-medium text-gray-700';
                } else {
                    let text = `CO2 avoided: ${(co2Avoided / 1000000).toFixed(1)}M tons (${co2AvoidedPercent.toFixed(0)}%)`;
                    if (co2Avoided > 0) {
                        text += ` at $${abatementCost.toFixed(0)}/ton`;
                    }
                    co2AvoidedEl.textContent = text;
                    co2AvoidedEl.className = co2Avoided > 0 ? 'text-md font-medium text-green-600' : 'text-md font-medium text-red-600';
                }
            }

            function calculateEmissions(generation, dacRate) {
                const co2 = [];
                const numHours = generation.naturalGas.length;
                for (let i = 0; i < numHours; i++) {
                    let hourlyEmission = 0;
                    if (EMISSION_FACTORS) {
                        hourlyEmission += (generation.naturalGas[i] || 0) * EMISSION_FACTORS.naturalGas;
                        hourlyEmission += (generation.coal[i] || 0) * EMISSION_FACTORS.coal;
                        hourlyEmission += (generation.biomass[i] || 0) * EMISSION_FACTORS.biomass;
                    } else {
                        // Fallback
                        hourlyEmission += (generation.naturalGas[i] || 0) * 1000 * 0.45;
                        hourlyEmission += (generation.coal[i] || 0) * 1000 * 1.0;
                    }
                    hourlyEmission -= dacRate;
                    co2.push(Math.max(0, hourlyEmission));
                }
                return co2;
            }

            function updateCharts(generation, emissions, demand, totalAnnualCO2, solarProfile, windProfile, offshoreWindProfile, hourlyMarginalPrice, priceWithoutStorage) {
                const chartData = generationChart.data.datasets;

                const techMap = {
                    nuclear: 0, geothermal: 1, biomass: 2, rng: 3, hydrogen: 4, hydro: 5,
                    wind: 6, offshoreWind: 7, solar: 8,
                    naturalGas: 9, coal: 10, storage: 11,
                    solarToStorage: 12, windToStorage: 13, offshoreWindToStorage: 14, curtailment: 15
                };

                for (const tech in techMap) {
                    if (generation[tech]) {
                        chartData[techMap[tech]].data = generation[tech];
                    }
                }
                chartData[16].data = demand;

                generationChart.update('none');

                // Update marginal price chart
                marginalPriceChart.data.datasets[0].data = hourlyMarginalPrice;
                marginalPriceChart.data.datasets[1].data = priceWithoutStorage;
                marginalPriceChart.update('none');

                // Update CO2 chart (Monthly Bar Chart)
                const monthlyEmissions = Array(12).fill(0);
                // emissions is length 288 (hourly rates t/hr)
                for (let i = 0; i < emissions.length; i++) {
                    const monthIndex = Math.floor(i / 24) % 12;
                    monthlyEmissions[monthIndex] += emissions[i] * DAYS_IN_MONTH[monthIndex];
                }

                co2Chart.data.datasets[0].data = monthlyEmissions;
                if (co2Chart.options.plugins.annotation && co2Chart.options.plugins.annotation.annotations.totalCO2) {
                    co2Chart.options.plugins.annotation.annotations.totalCO2.content = `Total Annual CO2: ${(totalAnnualCO2 / 1000000).toFixed(2)} Million Tons`;
                }
                co2Chart.update('none');

                capacityFactorChart.data.datasets[0].data = solarProfile;
                capacityFactorChart.data.datasets[1].data = windProfile;
                capacityFactorChart.data.datasets[2].data = offshoreWindProfile;
                capacityFactorChart.update('none');
            }

            function updateGridMixSlider(installedCapacity, defaultMix) {
                const capacities = {};
                let totalCapacity = 0;

                for (const tech in COST_DATA.capacity_factor) {
                    const baselineCapacity = installedCapacity[tech] || 0;
                    let newCapacity = 0;
                    if (sliders[tech]) {
                        newCapacity = parseFloat(sliders[tech].value);
                    }
                    capacities[tech] = baselineCapacity + newCapacity;
                    totalCapacity += capacities[tech];
                }

                if (totalCapacity > 0) {
                    for (const tech in capacities) {
                        if (COST_DATA.capacity_factor[tech]) { // Only for generators
                            const percentage = (capacities[tech] / totalCapacity) * 100;
                            const fillEl = document.getElementById(`mix-fill-${tech}`);
                            const valueEl = document.getElementById(`mix-value-${tech}`);
                            const outlineEl = document.getElementById(`mix-default-outline-${tech}`);

                            if (fillEl && valueEl) {
                                fillEl.style.width = `${percentage}%`;
                                valueEl.textContent = `${percentage.toFixed(1)}%`;
                            }
                            if (outlineEl && defaultMix[tech] !== undefined) {
                                outlineEl.style.width = `${defaultMix[tech]}%`;
                            }
                        }
                    }
                }

                // Update storage display
                ['battery4hr', 'battery8hr', 'longduration'].forEach(type => {
                    const baselineGWh = currentBaselineStorage[type] || 0;
                    const newGWh = parseFloat(sliders[type].value);
                    const totalGWh = baselineGWh + newGWh;
                    const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                    const totalGW = totalGWh / duration;
                    const displayEl = document.getElementById(`storage-capacity-${type}`);
                    if (displayEl) {
                        displayEl.textContent = `${totalGW.toFixed(2)} GW / ${totalGWh.toFixed(2)} GWh`;
                    }
                });
            }

            function createGridMixSliders() {
                const techOrder = ['coal', 'naturalGas', 'solar', 'hydro', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                techOrder.forEach(tech => {
                    let name = tech.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    if (tech === 'wind') name = 'Onshore Wind';
                    if (tech === 'offshoreWind') name = 'Offshore Wind';
                    if (tech === 'rng') name = 'RNG (Biogas)';
                    if (tech === 'hydrogen') name = 'Hydrogen';

                    const color = COLORS[tech] || '#ccc';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-6 gap-2 items-center mix-slider-row';
                    wrapper.dataset.tech = tech;

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = "flex items-center justify-center";
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${tech}`;
                    checkbox.checked = true;
                    checkbox.className = "form-checkbox h-5 w-5 text-blue-600 rounded";
                    checkbox.addEventListener('change', () => {
                        enabledTechnologies[tech] = checkbox.checked;
                        runSimulation();
                        saveState();
                    });
                    checkboxContainer.appendChild(checkbox);
                    wrapper.appendChild(checkboxContainer);

                    const label = document.createElement('label');
                    label.textContent = name;
                    label.className = 'col-span-1 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'col-span-3';
                    const track = document.createElement('div');
                    track.className = 'mix-slider-track';
                    const fill = document.createElement('div');
                    fill.id = `mix-fill-${tech}`;
                    fill.className = 'mix-slider-fill';
                    fill.style.backgroundColor = color;
                    const outline = document.createElement('div');
                    outline.id = `mix-default-outline-${tech}`;
                    outline.className = 'mix-slider-default-outline';
                    track.appendChild(fill);
                    track.appendChild(outline);
                    sliderContainer.appendChild(track);
                    wrapper.appendChild(sliderContainer);

                    const value = document.createElement('span');
                    value.id = `mix-value-${tech}`;
                    value.className = 'col-span-1 text-sm font-semibold text-right';
                    value.textContent = '0.0%';
                    wrapper.appendChild(value);

                    gridMixSlidersContainer.appendChild(wrapper);
                });

                // Create storage section
                const storageHeader = document.createElement('h3');
                storageHeader.className = 'text-lg font-lora font-semibold mt-6 mb-2 text-gray-800';
                storageHeader.textContent = 'Installed Storage Capacity';
                storageCapacityDisplayContainer.appendChild(storageHeader);

                const storageTypes = [
                    { id: 'battery4hr', name: '4-hr Battery' },
                    { id: 'battery8hr', name: '8-hr Battery' },
                    { id: 'longduration', name: '24-hr Storage' }
                ];

                storageTypes.forEach(type => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-6 gap-2 items-center';

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = "flex items-center justify-center";
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${type.id}`;
                    checkbox.checked = true;
                    checkbox.className = "form-checkbox h-5 w-5 text-blue-600 rounded";
                    checkbox.addEventListener('change', () => {
                        enabledTechnologies[type.id] = checkbox.checked;
                        runSimulation();
                        saveState();
                    });
                    checkboxContainer.appendChild(checkbox);
                    wrapper.appendChild(checkboxContainer);

                    const label = document.createElement('label');
                    label.textContent = type.name;
                    label.className = 'col-span-2 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const value = document.createElement('span');
                    value.id = `storage-capacity-${type.id}`;
                    value.className = 'col-span-3 text-sm font-semibold text-right';
                    value.textContent = '0.00 GW / 0.00 GWh';
                    wrapper.appendChild(value);

                    storageCapacityDisplayContainer.appendChild(wrapper);
                });
            }

            // --- GENERATION MIX SLIDER ---
            function updateGenerationMixSlider(generation, defaultMix, curtailmentBySource) {
                dailyGenerationTotalsGWh = {}; // Clear previous totals
                let totalGeneration = 0;

                const gridTechs = ['coal', 'naturalGas', 'hydro', 'geothermal', 'biomass', 'rng', 'hydrogen', 'nuclear', 'solar', 'wind', 'offshoreWind', 'storage'];
                gridTechs.forEach(tech => {
                    const techTotal = (generation[tech] || []).reduce((a, b) => a + b, 0);
                    dailyGenerationTotalsGWh[tech] = techTotal;
                    totalGeneration += techTotal;
                });

                if (totalGeneration > 0) {
                    gridTechs.forEach(tech => {
                        const percentage = (dailyGenerationTotalsGWh[tech] / totalGeneration) * 100;
                        const fillEl = document.getElementById(`gen-mix-fill-${tech}`);
                        const valueEl = document.getElementById(`gen-mix-value-${tech}`);
                        const outlineEl = document.getElementById(`gen-mix-default-outline-${tech}`);

                        if (fillEl && valueEl) {
                            fillEl.style.width = `${percentage}%`;
                            valueEl.textContent = `${percentage.toFixed(1)}%`;
                        }
                        if (outlineEl && defaultMix[tech] !== undefined) {
                            outlineEl.style.width = `${defaultMix[tech]}%`;
                        }
                    });
                } else {
                    gridTechs.forEach(tech => {
                        const fillEl = document.getElementById(`gen-mix-fill-${tech}`);
                        const valueEl = document.getElementById(`gen-mix-value-${tech}`);
                        if (fillEl && valueEl) {
                            fillEl.style.width = '0%';
                            valueEl.textContent = '0.0%';
                        }
                    });
                }

                const curtailmentTrack = document.getElementById('gen-mix-track-curtailment');
                const curtailmentValue = document.getElementById('gen-mix-value-curtailment');
                curtailmentTrack.innerHTML = '';

                let totalCurtailed = (generation.curtailment || []).reduce((a, b) => a + b, 0);
                dailyGenerationTotalsGWh['curtailment'] = totalCurtailed;
                let totalPotentialGeneration = totalGeneration + totalCurtailed + (generation.solarToStorage || []).reduce((a, b) => a + b, 0) + (generation.windToStorage || []).reduce((a, b) => a + b, 0) + (generation.offshoreWindToStorage || []).reduce((a, b) => a + b, 0);

                if (totalPotentialGeneration > 0) {
                    const overallCurtailmentPercent = (totalCurtailed / totalPotentialGeneration) * 100;
                    curtailmentValue.textContent = `${overallCurtailmentPercent.toFixed(1)}%`;

                    if (totalCurtailed > 0) {
                        const solarCurtail = (curtailmentBySource.solar || []).reduce((a, b) => a + b, 0) || 0;
                        const windCurtail = (curtailmentBySource.wind || []).reduce((a, b) => a + b, 0) || 0;
                        const offshoreWindCurtail = (curtailmentBySource.offshoreWind || []).reduce((a, b) => a + b, 0) || 0;

                        const techWithCurtailment = [{ tech: 'solar', val: solarCurtail }, { tech: 'wind', val: windCurtail }, { tech: 'offshoreWind', val: offshoreWindCurtail }];

                        techWithCurtailment.forEach(item => {
                            if (item.val > 0) {
                                const contributionPercent = (item.val / totalCurtailed);
                                const segmentWidth = 100 * contributionPercent;

                                const segment = document.createElement('div');
                                segment.className = 'h-full';
                                segment.style.backgroundColor = COLORS[item.tech];
                                segment.style.width = `${segmentWidth}%`;
                                segment.style.float = 'left';
                                curtailmentTrack.appendChild(segment);
                            }
                        });
                        curtailmentTrack.parentElement.style.width = `${overallCurtailmentPercent}%`;
                    } else {
                        curtailmentTrack.parentElement.style.width = `0%`;
                    }
                } else {
                    curtailmentValue.textContent = '0.0%';
                    curtailmentTrack.parentElement.style.width = `0%`;
                }
            }

            function createGenerationMixSliders() {
                const techOrder = ['coal', 'naturalGas', 'solar', 'hydro', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen', 'storage'];
                techOrder.forEach(tech => {
                    let name = tech.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    if (tech === 'wind') name = 'Onshore Wind';
                    if (tech === 'offshoreWind') name = 'Offshore Wind';
                    if (tech === 'rng') name = 'RNG (Biogas)';
                    if (tech === 'hydrogen') name = 'Hydrogen';
                    const color = COLORS[tech] || '#ccc';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-5 gap-2 items-center mix-slider-row';
                    wrapper.dataset.tech = tech;

                    const label = document.createElement('label');
                    label.textContent = name;
                    label.className = 'col-span-1 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'col-span-3';
                    const track = document.createElement('div');
                    track.className = 'mix-slider-track';
                    const fill = document.createElement('div');
                    fill.id = `gen-mix-fill-${tech}`;
                    fill.className = 'mix-slider-fill';
                    fill.style.backgroundColor = color;
                    const outline = document.createElement('div');
                    outline.id = `gen-mix-default-outline-${tech}`;
                    outline.className = 'mix-slider-default-outline';
                    track.appendChild(fill);
                    track.appendChild(outline);
                    sliderContainer.appendChild(track);
                    wrapper.appendChild(sliderContainer);

                    const value = document.createElement('span');
                    value.id = `gen-mix-value-${tech}`;
                    value.className = 'col-span-1 text-sm font-semibold text-right';
                    value.textContent = '0.0%';
                    wrapper.appendChild(value);

                    generationMixSlidersContainer.appendChild(wrapper);
                });

                const wrapper = document.createElement('div');
                wrapper.className = 'grid grid-cols-5 gap-2 items-center mix-slider-row';
                wrapper.dataset.tech = 'curtailment';
                const label = document.createElement('label');
                label.textContent = 'Curtailment';
                label.className = 'col-span-1 text-sm font-medium text-gray-700';
                wrapper.appendChild(label);
                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'col-span-3';
                const outerTrack = document.createElement('div');
                outerTrack.className = 'mix-slider-track';
                const innerTrack = document.createElement('div');
                innerTrack.id = 'gen-mix-track-curtailment';
                innerTrack.className = 'h-full w-full';
                outerTrack.appendChild(innerTrack);
                sliderContainer.appendChild(outerTrack);
                wrapper.appendChild(sliderContainer);
                const value = document.createElement('span');
                value.id = `gen-mix-value-curtailment`;
                value.className = 'col-span-1 text-sm font-semibold text-right';
                value.textContent = '0.0%';
                wrapper.appendChild(value);
                generationMixSlidersContainer.appendChild(wrapper);
            }

            // --- HELPER: Calculate minimum demand based on inflexible baseload ---
            function calculateMinimumDemand() {
                const INFLEXIBLE_SOURCES = ['nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                let minDemand = 0;
                INFLEXIBLE_SOURCES.forEach(tech => {
                    const baselineCapacity = currentCountryInstalledCapacity[tech] || 0;
                    const newCapacity = currentValues[tech] || 0;
                    const totalCapacity = baselineCapacity + newCapacity;
                    const cf = COST_DATA.capacity_factor[tech] || 0;
                    minDemand += totalCapacity * cf;
                });
                return minDemand;
            }

            // --- DEMAND EDIT MODE ---
            function setDemandEditMode(enabled) {
                isDemandEditMode = enabled;
                const demandDatasetIndex = generationChart.data.datasets.findIndex(ds => ds.label === 'Demand');

                if (enabled) {
                    if (editDemandBtn) editDemandBtn.classList.add('hidden');
                    if (confirmDemandBtn) confirmDemandBtn.classList.remove('hidden');
                    if (revertDemandBtn) revertDemandBtn.classList.remove('hidden');
                    if (demandPresetsDiv) demandPresetsDiv.classList.remove('hidden');

                    document.querySelectorAll('#demand-presets button').forEach(btn => {
                        btn.classList.remove('preset-active');
                        if (btn.id === `preset-demand-${currentDemandProfileName.toLowerCase().replace(' ', '-')}`) {
                            btn.classList.add('preset-active');
                        }
                    });

                    generationChart.data.datasets.forEach((dataset, index) => {
                        if (index !== demandDatasetIndex) {
                            dataset.hidden = true;
                        } else {
                            dataset.borderWidth = 4;
                            dataset.pointRadius = 6;
                            dataset.pointHoverRadius = 8;
                            dataset.pointBackgroundColor = 'rgba(17, 24, 39, 1)';
                            dataset.pointBorderColor = 'white';
                            dataset.pointBorderWidth = 2;
                        }
                    });

                    generationChart.options.plugins.dragData = {
                        round: 1,
                        showTooltip: true,
                        onDrag: function (e, datasetIndex, index, value) {
                            // Enforce constraints DURING dragging for real-time feedback
                            const minDemand = calculateMinimumDemand();

                            if (value < minDemand) {
                                return minDemand;
                            }
                            if (value < 0) {
                                return 0;
                            }
                            return value;
                        },
                        onDragEnd: function (e, datasetIndex, index, value) {
                            const chart = e.chart;
                            let updatedValue = value;

                            // Calculate minimum demand based on inflexible baseload
                            const minDemand = calculateMinimumDemand();

                            // Enforce minimum demand constraint
                            if (updatedValue < minDemand) {
                                updatedValue = minDemand;
                            }

                            // Enforce non-negative constraint
                            if (updatedValue < 0) {
                                updatedValue = 0;
                            }

                            chart.data.datasets[datasetIndex].data[index] = updatedValue;
                            generationChart.update('none');
                        }
                    };
                    generationChart.options.plugins.dragData.enabled = true;
                    generationChart.options.scales.y.stacked = false;
                    generationChart.update();

                } else {
                    if (editDemandBtn) editDemandBtn.classList.remove('hidden');
                    if (confirmDemandBtn) confirmDemandBtn.classList.add('hidden');
                    if (revertDemandBtn) revertDemandBtn.classList.add('hidden');
                    if (demandPresetsDiv) demandPresetsDiv.classList.add('hidden');

                    generationChart.data.datasets.forEach((dataset, index) => {
                        dataset.hidden = false;
                        if (index === demandDatasetIndex) {
                            dataset.borderWidth = 3;
                            dataset.pointRadius = 0;
                            dataset.pointHoverRadius = 0;
                        }
                    });

                    if (generationChart.options.plugins.dragData) {
                        generationChart.options.plugins.dragData.enabled = false;
                        generationChart.options.plugins.dragData.onDragEnd = null;
                    }
                    generationChart.options.scales.y.stacked = true;
                    generationChart.update();
                }
            }

            // --- CF EDIT MODE ---
            function setCFEditMode(enabled) {
                isCFEditMode = enabled;

                if (enabled) {
                    if (editCFBtn) editCFBtn.classList.add('hidden');
                    if (confirmCFBtn) confirmCFBtn.classList.remove('hidden');
                    if (revertCFBtn) revertCFBtn.classList.remove('hidden');
                    if (cfPresetsDiv) cfPresetsDiv.classList.remove('hidden');

                    document.querySelectorAll('#cf-presets button').forEach(btn => {
                        btn.classList.remove('preset-active');
                        if (btn.id === `preset-cf-${currentCFProfileName.toLowerCase()}`) {
                            btn.classList.add('preset-active');
                        }
                    });

                    capacityFactorChart.data.datasets.forEach(dataset => {
                        dataset.pointRadius = 6;
                        dataset.pointHoverRadius = 8;
                        dataset.pointBorderColor = 'white';
                        dataset.pointBorderWidth = 2;
                        dataset.dragData = true;
                    });

                } else {
                    if (editCFBtn) editCFBtn.classList.remove('hidden');
                    if (confirmCFBtn) confirmCFBtn.classList.add('hidden');
                    if (revertCFBtn) revertCFBtn.classList.add('hidden');
                    if (cfPresetsDiv) cfPresetsDiv.classList.add('hidden');

                    capacityFactorChart.data.datasets.forEach(dataset => {
                        dataset.pointRadius = 0;
                        dataset.dragData = false;
                    });
                }
                capacityFactorChart.update();
            }

            // --- NEW: Function to set the baseline from the current state ---
            // Returns the simulation result to avoid running the simulation twice
            function setNewBaselineFromCurrentState() {
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                let activePotentialGeneration = JSON.parse(JSON.stringify(BASELINE_POTENTIAL_GENERATION));
                for (const tech in enabledTechnologies) {
                    if (!enabledTechnologies[tech]) {
                        activePotentialGeneration[tech] = Array(24).fill(0);
                    }
                }

                const newBaselineResult = getSimulationResult(
                    {
                        capacity: {
                            solar: currentValues.solar, wind: currentValues.wind, offshoreWind: currentValues.offshoreWind,
                            geothermal: currentValues.geothermal, nuclear: currentValues.nuclear,
                            biomass: currentValues.biomass, rng: currentValues.rng, hydrogen: currentValues.hydrogen,
                            battery4hr: currentValues.battery4hr, battery8hr: currentValues.battery8hr,
                            longduration: currentValues.longduration, dac: currentValues.dac,
                            demandflex: currentValues.demandflex,
                        },
                        incentives: {
                            solar: currentValues.solarIncentive, wind: currentValues.windIncentive, offshoreWind: currentValues.offshoreWindIncentive,
                            geothermal: currentValues.geothermalIncentive, nuclear: currentValues.nuclearIncentive,
                            biomass: currentValues.biomassIncentive, rng: currentValues.rngIncentive, hydrogen: currentValues.hydrogenIncentive,
                            storage: currentValues.storageIncentive, dac: currentValues.dacIncentive,
                            carbonTax: currentValues.carbonTax,
                            exportPrice: currentValues.exportPrice,
                        }
                    },
                    currentSolarCFProfile,
                    currentWindCFProfile,
                    currentOffshoreWindCFProfile,
                    activePotentialGeneration,
                    currentBaselineStorage,
                    currentHydroCF,
                    countrySelect.value
                );

                customBaselineSystemCost = newBaselineResult.systemCost;
                customBaselineConsumerCost = calculateAnnualConsumerCost(newBaselineResult.hourlyMarginalPrice, newBaselineResult.demand);
                customBaselineTotalAnnualCO2 = newBaselineResult.emissions.reduce((a, b) => a + b, 0) * 365;

                // Return the simulation result so we can display it without re-running
                return newBaselineResult;
            }

            // --- EVENT LISTENERS ---
            function updateUndoRedoButtons() {
                undoButton.disabled = historyIndex <= 0;
                redoButton.disabled = historyIndex >= stateHistory.length - 1;
            }

            function saveState() {
                const currentState = {};
                for (const key in sliders) {
                    currentState[key] = sliders[key].value;
                }
                currentState.enabledTech = { ...enabledTechnologies };
                currentState.demandProfile = [...currentDemand];
                currentState.solarCFProfile = [...currentSolarCFProfile];
                currentState.windCFProfile = [...currentWindCFProfile];
                currentState.offshoreWindCFProfile = [...currentOffshoreWindCFProfile];
                currentState.demandProfileName = currentDemandProfileName;
                currentState.cfProfileName = currentCFProfileName;
                currentState.hydroCF = currentHydroCF;

                stateHistory = stateHistory.slice(0, historyIndex + 1);
                stateHistory.push(currentState);
                historyIndex++;
                updateUndoRedoButtons();
            }

            function syncInputs(sourceElement, targetElement) {
                targetElement.value = sourceElement.value;
            }

            function setupInputSyncing() {
                for (const key in sliders) {
                    const slider = sliders[key];
                    const input = inputs[key];

                    // All sliders behave the same way - just run simulation
                    // Baseline only updates when "Make Default" is clicked
                    slider.addEventListener('input', () => {
                        syncInputs(slider, input);
                        runSimulation();
                    });

                    input.addEventListener('input', () => {
                        let value = parseFloat(input.value);
                        const min = parseFloat(slider.min);
                        const max = parseFloat(slider.max);
                        if (isNaN(value)) value = min;
                        if (value > max) value = max;
                        if (value < min) value = min;
                        input.value = value;
                        syncInputs(input, slider);
                        runSimulation();
                    });

                    slider.addEventListener('change', saveState);
                    input.addEventListener('change', saveState);
                }
            }


            function applySeason(profileName) {
                currentSystemDefaultProfileName = profileName;
                const nameParts = profileName.split('-');
                const baseSeason = nameParts[0];
                const profileDisplayName = nameParts.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');

                currentDemandProfileName = profileDisplayName;
                if (currentDemandProfileText) currentDemandProfileText.textContent = currentDemandProfileName;

                const cfProfileDisplayName = baseSeason.charAt(0).toUpperCase() + baseSeason.slice(1);
                const seasonalMultipliers = SEASONAL_MULTIPLIERS[baseSeason];
                const baseSolarProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).solar;
                const baseWindProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).wind;
                const baseOffshoreWindProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).offshoreWind;
                currentSolarCFProfile = baseSolarProfile.map(cf => Math.min(1, cf * seasonalMultipliers.solar));
                currentWindCFProfile = baseWindProfile.map(cf => Math.min(1, cf * seasonalMultipliers.wind));
                currentOffshoreWindCFProfile = baseOffshoreWindProfile.map(cf => Math.min(1, cf * seasonalMultipliers.offshoreWind));
                currentHydroCF = SEASONAL_HYDRO_CF[baseSeason];
                currentCFProfileName = cfProfileDisplayName;
                if (currentCFProfileText) currentCFProfileText.textContent = currentCFProfileName;

                updateBaselineForCountry(countrySelect.value, profileName);

                setDemandEditMode(false);
                setCFEditMode(false);
                saveState();
            }



            if (editDemandBtn) {
                editDemandBtn.addEventListener('click', () => {
                    originalDemandBeforeEdit = [...currentDemand];
                    setDemandEditMode(true);
                });
            }

            if (revertDemandBtn) {
                revertDemandBtn.addEventListener('click', () => {
                    generationChart.data.datasets.find(ds => ds.label === 'Demand').data = [...originalDemandBeforeEdit];
                    generationChart.update('none');
                });
            }

            if (confirmDemandBtn) {
                confirmDemandBtn.addEventListener('click', () => {
                    currentDemand = [...generationChart.data.datasets.find(ds => ds.label === 'Demand').data];
                    currentDemandProfileName = "User Defined";
                    currentDemandProfileText.textContent = currentDemandProfileName;
                    setDemandEditMode(false);
                    runSimulation();
                    saveState();
                });
            }

            const demandProfiles = [
                'spring-typical', 'spring-high', 'summer-typical', 'summer-high',
                'fall-typical', 'fall-high', 'winter-typical', 'winter-high'
            ];
            demandProfiles.forEach(profile => {
                const btn = document.getElementById(`preset-demand-${profile}`);
                if (btn) btn.addEventListener('click', () => applySeason(profile));
            });

            ['spring', 'summer', 'fall', 'winter'].forEach(season => {
                const btn = document.getElementById(`preset-cf-${season}`);
                if (btn) btn.addEventListener('click', () => {
                    applySeason(`${season}-typical`);
                });
            });

            if (editCFBtn) {
                editCFBtn.addEventListener('click', () => {
                    originalSolarCFBeforeEdit = [...capacityFactorChart.data.datasets[0].data];
                    originalWindCFBeforeEdit = [...capacityFactorChart.data.datasets[1].data];
                    originalOffshoreWindCFBeforeEdit = [...capacityFactorChart.data.datasets[2].data];
                    setCFEditMode(true);
                });
            }

            if (revertCFBtn) {
                revertCFBtn.addEventListener('click', () => {
                    capacityFactorChart.data.datasets[0].data = [...originalSolarCFBeforeEdit];
                    capacityFactorChart.data.datasets[1].data = [...originalWindCFBeforeEdit];
                    capacityFactorChart.data.datasets[2].data = [...originalOffshoreWindCFBeforeEdit];
                    capacityFactorChart.update('none');
                });
            }

            if (confirmCFBtn) {
                confirmCFBtn.addEventListener('click', () => {
                    currentSolarCFProfile = [...capacityFactorChart.data.datasets[0].data];
                    currentWindCFProfile = [...capacityFactorChart.data.datasets[1].data];
                    currentOffshoreWindCFProfile = [...capacityFactorChart.data.datasets[2].data];
                    currentCFProfileName = "User Defined";
                    currentCFProfileText.textContent = currentCFProfileName;

                    const lastDemandProfile = currentDemandProfileName.toLowerCase().replace(' ', '-');
                    updateBaselineForCountry(countrySelect.value, lastDemandProfile);

                    setCFEditMode(false);
                    runSimulation();
                    saveState();
                });
            }



            resetToZeroButton.addEventListener('click', () => {
                Object.keys(sliders).forEach(key => {
                    if (key === 'exportPrice') {
                        sliders[key].value = 20;
                        inputs[key].value = 20;
                    } else {
                        sliders[key].value = 0;
                        inputs[key].value = 0;
                    }
                });
                runSimulation();
                saveState();
            });

            makeDefaultButton.addEventListener('click', () => {
                userDefaultState = {};
                for (const key in sliders) {
                    userDefaultState[key] = sliders[key].value;
                }
                userDefaultState.enabledTech = { ...enabledTechnologies };
                userDefaultState.demandProfile = [...currentDemand];
                userDefaultState.solarCFProfile = [...currentSolarCFProfile];
                userDefaultState.windCFProfile = [...currentWindCFProfile];
                userDefaultState.offshoreWindCFProfile = [...currentOffshoreWindCFProfile];
                userDefaultState.demandProfileName = currentDemandProfileName;
                userDefaultState.cfProfileName = currentCFProfileName;
                userDefaultState.hydroCF = currentHydroCF;

                // Set the new baseline (runs simulation once)
                setNewBaselineFromCurrentState();

                userDefaultState.baselineCost = customBaselineSystemCost;
                userDefaultState.baselineCO2 = customBaselineTotalAnnualCO2;

                // Run normal simulation to update display
                // This may show 1-2% difference due to iterative optimization, which is acceptable
                runSimulation();

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl text-center">
                        <p class="text-lg font-semibold text-gray-800">Current settings saved as user default.</p>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.remove(), 2500);
            });

            resetToDefaultButton.addEventListener('click', () => {
                const isUserDefaultAvailable = Object.keys(userDefaultState).length > 0;

                if (isUserDefaultAvailable) {
                    restoreState(userDefaultState);
                    saveState();
                } else {
                    applySeason(currentSystemDefaultProfileName);
                }
            });

            function restoreState(state) {
                currentDemand = [...state.demandProfile];
                currentSolarCFProfile = [...state.solarCFProfile];
                currentWindCFProfile = [...state.windCFProfile];
                currentOffshoreWindCFProfile = [...state.offshoreWindCFProfile];
                currentDemandProfileName = state.demandProfileName;
                currentCFProfileName = state.cfProfileName;
                currentHydroCF = state.hydroCF;
                currentDemandProfileText.textContent = currentDemandProfileName;
                currentCFProfileText.textContent = currentCFProfileName;

                for (const key in state) {
                    if (sliders[key] && inputs[key]) {
                        sliders[key].value = state[key];
                        inputs[key].value = state[key];
                    }
                }
                if (state.enabledTech) {
                    for (const tech in state.enabledTech) {
                        const checkbox = document.getElementById(`toggle-${tech}`);
                        if (checkbox) {
                            checkbox.checked = state.enabledTech[tech];
                            enabledTechnologies[tech] = state.enabledTech[tech];
                        }
                    }
                }
                runSimulation();
                updateUndoRedoButtons();
            }

            undoButton.addEventListener('click', () => {
                if (historyIndex > 0) {
                    historyIndex--;
                    restoreState(stateHistory[historyIndex]);
                }
            });

            redoButton.addEventListener('click', () => {
                if (historyIndex < stateHistory.length - 1) {
                    historyIndex++;
                    restoreState(stateHistory[historyIndex]);
                }
            });

            // --- INITIALIZATION & DYNAMIC CONTENT ---

            function populateCountryDropdown() {
                countrySelect.innerHTML = '';
                const caOption = document.createElement('option');
                caOption.value = "California";
                caOption.textContent = "California";
                countrySelect.appendChild(caOption);

                for (const country in countryGridMixData) {
                    if (country !== "California") {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    }
                }
                countrySelect.value = "California";
            }

            function updateBaselineForCountry(countryName, profileName) {
                let newCarbonTax = 0;
                let countryData = countryGridMixData[countryName];

                if (!countryData) {
                    console.error(`No data for country: ${countryName}`);
                    return;
                }

                newCarbonTax = carbonTaxes[countryName] || 0;

                const nameParts = profileName.split('-');
                const baseSeason = nameParts[0];
                const profileType = nameParts[1];

                if (currentDemandProfileName !== 'User Defined') {
                    // For California, use JSON profiles directly (same calculation as Grid Dispatch Test)
                    if (countryName === 'California' && CALIFORNIA_PROFILES[profileName]) {
                        const profile = CALIFORNIA_PROFILES[profileName];
                        const peakMW = profile.peakMW;
                        const hourlyPercentages = profile.hourlyPercentages;

                        // Match tester's calculation: (pct / 100) * peakMW, then convert to GW
                        currentDemand = hourlyPercentages.map(pct => (pct / 100) * (peakMW / 1000));
                    } else {
                        // For other countries, use scaling approach
                        const TYPICAL_DAY_SCALING_FACTORS = {
                            spring: 0.79, summer: 0.82, fall: 0.77, winter: 0.73
                        };

                        const hourlyPercentages = SEASONAL_DEMAND_PROFILES[profileName] || SEASONAL_DEMAND_PROFILES[`${baseSeason}-high`];
                        const scalingFactor = profileType === 'typical' ? TYPICAL_DAY_SCALING_FACTORS[baseSeason] || 1.0 : 1.0;
                        const peakLoadMW = countryData.peakLoadsMW[baseSeason] || countryData.peakLoadsMW.summer;
                        const peakPercentage = Math.max(...hourlyPercentages);
                        currentDemand = hourlyPercentages.map(pct => (pct / peakPercentage) * (peakLoadMW / 1000) * scalingFactor);
                    }
                }

                currentCountryInstalledCapacity = {};
                for (const tech in COST_DATA.capacity_factor) {
                    const techCapacityGW = (countryData.totalCapacityMW / 1000) * ((countryData.mix[tech] || 0) / 100);
                    currentCountryInstalledCapacity[tech] = techCapacityGW;
                }

                currentBaselineStorage = countryData.storageGWh || {};

                const potentialGeneration = {};
                for (const tech in currentCountryInstalledCapacity) {
                    potentialGeneration[tech] = Array(24).fill(0);
                    const cf = COST_DATA.capacity_factor[tech];
                    let capacity = currentCountryInstalledCapacity[tech];

                    if (tech === 'solar') {
                        for (let i = 0; i < 24; i++) potentialGeneration.solar[i] = capacity * currentSolarCFProfile[i];
                    } else if (tech === 'wind') {
                        for (let i = 0; i < 24; i++) potentialGeneration.wind[i] = capacity * currentWindCFProfile[i];
                    } else if (tech === 'offshoreWind') {
                        for (let i = 0; i < 24; i++) potentialGeneration.offshoreWind[i] = capacity * currentOffshoreWindCFProfile[i];
                    } else if (tech === 'hydro') {
                        for (let i = 0; i < 24; i++) potentialGeneration.hydro[i] = capacity;
                    } else if (tech === 'naturalGas' || tech === 'coal') {
                        for (let i = 0; i < 24; i++) potentialGeneration[tech][i] = capacity * 1.0;
                    } else {
                        for (let i = 0; i < 24; i++) potentialGeneration[tech][i] = capacity * cf;
                    }
                }
                BASELINE_POTENTIAL_GENERATION = potentialGeneration;

                Object.keys(sliders).forEach(key => {
                    sliders[key].value = 0;
                    inputs[key].value = 0;
                });

                sliders.carbonTax.value = newCarbonTax;
                inputs.carbonTax.value = newCarbonTax;

                const newExportPrice = countryData.defaultExportPrice ?? 20;
                sliders.exportPrice.value = newExportPrice;
                inputs.exportPrice.value = newExportPrice;

                const allTechs = [...Object.keys(COST_DATA.capacity_factor), 'battery4hr', 'battery8hr', 'longduration'];
                allTechs.forEach(tech => {
                    const checkbox = document.getElementById(`toggle-${tech}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        enabledTechnologies[tech] = true;
                    }
                });

                const baselineResult = getSimulationResult(
                    {
                        capacity: { solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, nuclear: 0, biomass: 0, rng: 0, hydrogen: 0, battery4hr: 0, battery8hr: 0, longduration: 0, dac: 0, demandflex: 0 },
                        incentives: { solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, nuclear: 0, biomass: 0, rng: 0, hydrogen: 0, storage: 0, dac: 0, carbonTax: newCarbonTax, exportPrice: newExportPrice }
                    },
                    currentSolarCFProfile,
                    currentWindCFProfile,
                    currentOffshoreWindCFProfile,
                    BASELINE_POTENTIAL_GENERATION,
                    currentBaselineStorage,
                    currentHydroCF,
                    countryName
                );
                customBaselineSystemCost = baselineResult.systemCost;
                customBaselineConsumerCost = calculateAnnualConsumerCost(baselineResult.hourlyMarginalPrice, baselineResult.demand); // NEW
                customBaselineTotalAnnualCO2 = baselineResult.emissions.reduce((a, b) => a + b, 0) * 365;

                systemDefaultState = {};
                for (const key in sliders) {
                    systemDefaultState[key] = sliders[key].value;
                }
                systemDefaultState.enabledTech = { ...enabledTechnologies };
                userDefaultState = {};

                let totalDefaultCapacity = 0;
                for (const tech in currentCountryInstalledCapacity) {
                    defaultCapacityMix[tech] = currentCountryInstalledCapacity[tech];
                    totalDefaultCapacity += currentCountryInstalledCapacity[tech];
                }

                if (totalDefaultCapacity > 0) {
                    for (const tech in defaultCapacityMix) {
                        defaultCapacityMix[tech] = (defaultCapacityMix[tech] / totalDefaultCapacity) * 100;
                    }
                }

                let totalDefaultGeneration = 0;
                for (const tech in baselineResult.generation) {
                    if (tech !== 'curtailment' && !tech.includes('ToStorage')) {
                        const gen = baselineResult.generation[tech].reduce((a, b) => a + b, 0);
                        defaultGenerationMix[tech] = gen;
                        totalDefaultGeneration += gen;
                    }
                }
                if (totalDefaultGeneration > 0) {
                    for (const tech in defaultGenerationMix) {
                        defaultGenerationMix[tech] = (defaultGenerationMix[tech] / totalDefaultGeneration) * 100;
                    }
                }
                runSimulation();
            }

            countrySelect.addEventListener('change', (e) => {
                applySeason(currentSystemDefaultProfileName);
            });

            document.addEventListener('mousemove', (e) => {
                hoverTooltip.style.left = e.pageX + 15 + 'px';
                hoverTooltip.style.top = e.pageY + 15 + 'px';
            });

            gridMixSlidersContainer.addEventListener('mouseover', (e) => {
                const row = e.target.closest('.mix-slider-row');
                if (!row) return;
                const tech = row.dataset.tech;
                if (!tech) return;

                const baselineCapacity = currentCountryInstalledCapacity[tech] || 0;
                const newCapacity = (sliders[tech] ? parseFloat(sliders[tech].value) : 0) || 0;
                const totalCapacity = baselineCapacity + newCapacity;

                hoverTooltip.innerHTML = `Total Capacity: ${totalCapacity.toFixed(2)} GW`;
                hoverTooltip.classList.remove('hidden');
            });
            gridMixSlidersContainer.addEventListener('mouseout', () => {
                hoverTooltip.classList.add('hidden');
            });

            generationMixSlidersContainer.addEventListener('mouseover', (e) => {
                const row = e.target.closest('.mix-slider-row');
                if (!row) return;
                const tech = row.dataset.tech;
                if (!tech || dailyGenerationTotalsGWh[tech] === undefined) return;

                const totalGWh = dailyGenerationTotalsGWh[tech];
                const label = tech === 'curtailment' ? 'Total Daily Curtailment' : 'Total Daily Generation';
                hoverTooltip.innerHTML = `${label}: ${totalGWh.toFixed(2)} GWh`;
                hoverTooltip.classList.remove('hidden');
            });
            generationMixSlidersContainer.addEventListener('mouseout', () => {
                hoverTooltip.classList.add('hidden');
            });


            // --- INPUT SYNCING ---
            // This function connects sliders and input boxes to runSimulation
            function setupInputSyncing() {
                console.log('DEBUG: setupInputSyncing called');
                console.log('DEBUG: sliders object has keys:', Object.keys(sliders));

                // Debounce function to limit how often simulation runs during rapid slider movements
                let debounceTimeout = null;
                const debouncedRunSimulation = () => {
                    if (debounceTimeout) clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        console.log('DEBUG: Running simulation after debounce');
                        runSimulation();
                    }, 150); // 150ms debounce - adjust as needed for responsiveness
                };

                // Connect each slider and input pair
                let connectedCount = 0;
                for (const key in sliders) {
                    if (sliders[key] && inputs[key]) {
                        connectedCount++;
                        // Slider -> Input sync + run simulation
                        sliders[key].addEventListener('input', (e) => {
                            inputs[key].value = e.target.value;
                            debouncedRunSimulation();
                        });

                        // Input -> Slider sync + run simulation  
                        inputs[key].addEventListener('input', (e) => {
                            // Handle empty or invalid input - treat as 0
                            const value = parseFloat(e.target.value);
                            if (isNaN(value) || e.target.value === '') {
                                sliders[key].value = 0;
                            } else {
                                sliders[key].value = value;
                            }
                            debouncedRunSimulation();
                        });

                        // On blur (focus lost), save state for undo/redo
                        sliders[key].addEventListener('change', () => {
                            saveState();
                        });
                        inputs[key].addEventListener('change', () => {
                            saveState();
                        });
                    } else {
                        console.warn(`DEBUG: Missing element for key "${key}": slider=${!!sliders[key]}, input=${!!inputs[key]}`);
                    }
                }
                console.log(`DEBUG: Connected ${connectedCount} slider/input pairs`);
            }

            // --- TUTORIAL LOGIC ---
            const tutorialSteps = [
                {
                    title: 'Welcome to the Grid Simulator!',
                    text: 'This interactive tool lets you explore pathways to a zero-carbon electricity grid. Let\'s take a quick tour of the main features.',
                    position: 'center'
                },
                {
                    element: '#tutorial-step-2',
                    title: 'Live Simulation Charts',
                    text: 'These charts show the real-time results of your decisions. See how the generation mix and CO2 emissions change as you adjust the levers.',
                    position: 'right',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#tutorial-step-3',
                    title: 'Your Control Panel',
                    text: 'This is where you make things happen! Use these sliders to deploy new technologies, set government incentives, and choose a starting grid mix.',
                    position: 'left',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#tutorial-step-4',
                    title: 'Manage Existing Resources',
                    text: 'Use these checkboxes to turn off an existing resource type and watch the impact it has on emissions and costs.',
                    position: 'right',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#make-default-button',
                    title: 'Save Your Scenario',
                    text: 'Once you find a set of policies you like, you can save them as your new default. The cost metrics will then be calculated relative to this new baseline.',
                    position: 'top',
                    highlightClass: 'rounded-full'
                },
                {
                    element: '#tutorial-step-5',
                    title: 'Key Outcome Metrics',
                    text: 'Your goal is to get CO2 emissions to zero while keeping costs low. These cards show the impact on electricity bills and the cost of avoiding CO2.',
                    position: 'bottom',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#edit-demand-btn',
                    title: 'Customize Demand',
                    text: 'Click the edit icon to create your own custom daily demand profile, or select a seasonal preset.',
                    position: 'left',
                    highlightClass: 'rounded-full'
                },
                {
                    element: '#edit-cf-btn',
                    title: 'Customize Weather',
                    text: 'Click this edit icon to change the hourly performance of solar and wind to simulate different weather conditions.',
                    position: 'top',
                    highlightClass: 'rounded-full'
                }
            ];

            let currentStep = 0;
            const overlay = document.getElementById('tutorial-overlay');
            const popover = document.getElementById('tutorial-popover');
            const titleEl = document.getElementById('tutorial-title');
            const textEl = document.getElementById('tutorial-text');
            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');
            const skipBtn = document.getElementById('tutorial-skip');
            let highlightedElement = null;

            function startTutorial() {
                if (localStorage.getItem('gridSimulatorTutorialSeen')) {
                    return;
                }
                document.body.classList.add('tutorial-active');
                currentStep = 0;
                showTutorialStep(currentStep);
            }

            function endTutorial() {
                document.body.classList.remove('tutorial-active');
                overlay.style.display = 'none';
                popover.style.display = 'none';
                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight-active', 'rounded-full', 'rounded-lg');
                }
                localStorage.setItem('gridSimulatorTutorialSeen', 'true');
            }

            function positionPopover(targetElement, popoverEl, position) {
                popoverEl.style.visibility = 'hidden';
                popoverEl.style.display = 'block';

                const popoverRect = popoverEl.getBoundingClientRect();
                const margin = 15;

                if (position === 'center' || !targetElement) {
                    popoverEl.style.left = '50%';
                    popoverEl.style.top = '50%';
                    popoverEl.style.transform = 'translate(-50%, -50%)';
                    popoverEl.style.visibility = 'visible';
                    return;
                }

                const targetRect = targetElement.getBoundingClientRect();
                let top, left;

                switch (position) {
                    case 'top':
                        top = targetRect.top - popoverRect.height - margin;
                        left = targetRect.left + (targetRect.width / 2) - (popoverRect.width / 2);
                        break;
                    case 'bottom':
                        top = targetRect.bottom + margin;
                        left = targetRect.left + (targetRect.width / 2) - (popoverRect.width / 2);
                        break;
                    case 'left':
                        top = targetRect.left - popoverRect.width - margin;
                        left = targetRect.top + (targetRect.height / 2) - (popoverRect.height / 2);
                        break;
                    case 'right':
                    default:
                        top = targetRect.top + (targetRect.height / 2) - (popoverRect.height / 2);
                        left = targetRect.right + margin;
                        break;
                }

                if (top < margin) top = margin;
                if (left < margin) left = margin;
                if (left + popoverRect.width > window.innerWidth - margin) {
                    left = window.innerWidth - popoverRect.width - margin;
                }
                if (top + popoverRect.height > window.innerHeight - margin) {
                    top = window.innerHeight - popoverRect.height - margin;
                }

                popoverEl.style.top = `${top}px`;
                popoverEl.style.left = `${left}px`;
                popoverEl.style.transform = 'none';
                popoverEl.style.visibility = 'visible';
            }

            function showTutorialStep(stepIndex) {
                if (stepIndex < 0 || stepIndex >= tutorialSteps.length) {
                    endTutorial();
                    return;
                }

                const step = tutorialSteps[stepIndex];

                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight-active', 'rounded-full', 'rounded-lg');
                    highlightedElement = null;
                }

                titleEl.textContent = step.title;
                textEl.textContent = step.text;

                let targetElement;
                if (step.element) {
                    targetElement = document.querySelector(step.element);
                }

                if (targetElement) {
                    overlay.style.display = 'none';
                    highlightedElement = targetElement;
                    highlightedElement.classList.add('tutorial-highlight-active');
                    if (step.highlightClass) {
                        highlightedElement.classList.add(step.highlightClass);
                    }

                    highlightedElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                    setTimeout(() => {
                        positionPopover(highlightedElement, popover, step.position);
                    }, 400);
                } else {
                    overlay.style.display = 'block';
                    positionPopover(null, popover, 'center');
                }

                prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-block';
                nextBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Finish' : 'Next';
            }

            nextBtn.addEventListener('click', () => {
                currentStep++;
                showTutorialStep(currentStep);
            });

            prevBtn.addEventListener('click', () => {
                currentStep--;
                showTutorialStep(currentStep);
            });

            skipBtn.addEventListener('click', endTutorial);

            startTutorialBtn.addEventListener('click', () => {
                localStorage.removeItem('gridSimulatorTutorialSeen');
                startTutorial();
            });


            // --- MAIN INITIALIZATION FUNCTION ---
            async function initialize() {
                // Load California seasonal profiles from JSON
                try {
                    const response = await fetch('../grid-operator/seasonal_profiles.json');
                    const profilesData = await response.json();
                    CALIFORNIA_PROFILES = profilesData.california.profiles;
                    console.log('Loaded California profiles from JSON:', Object.keys(CALIFORNIA_PROFILES));
                } catch (error) {
                    console.error('Error loading California profiles from JSON:', error);
                    console.log('Falling back to scaling method for California');
                }

                try {
                    await signInAnonymously(auth);
                    console.log("Firebase authentication successful.");
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    visitorCountEl.textContent = "Auth Failed";
                    return;
                }

                const counterRef = doc(db, `artifacts/${appId}/public/data/counters/visitor_counter`);
                try {
                    const newCount = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        if (!counterDoc.exists()) {
                            transaction.set(counterRef, { count: 1 });
                            return 1;
                        }
                        const newCount = counterDoc.data().count + 1;
                        transaction.update(counterRef, { count: newCount });
                        return newCount;
                    });
                    visitorCountEl.textContent = newCount.toLocaleString();
                } catch (e) {
                    console.error("Firestore transaction failed: ", e);
                    visitorCountEl.textContent = "DB Error";
                }

                createGridMixSliders();
                createGenerationMixSliders();
                populateCountryDropdown();
                applySeason('spring-typical');
                setupInputSyncing();

                setTimeout(startTutorial, 500);
            }

            await initialize();
        });
    </script>
</body>

=======
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Planning Simulator | Dr. Eshan Singh</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.1/dist/chartjs-plugin-dragdata.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc;
            color: #1f2937;
        }

        .font-lora {
            font-family: 'Lora', serif;
        }

        .glass-card {
            background-color: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .mesh-gradient-container {
            position: relative;
            z-index: 1;
        }

        .mesh-gradient-1 {
            background-image: radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 20%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 1) 0px, transparent 50%);
            background-size: 100% 100%;
            filter: blur(25px) saturate(1.2);
            opacity: 0.15;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            animation: pulse-bg 15s infinite alternate;
        }

        .tutorial-active .mesh-gradient-1 {
            animation: none !important;
        }

        .form-input {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 9999px;
            outline: none;
            border: 1px solid #e5e7eb;
            transition: background .2s;
        }

        .form-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-input::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mix-slider-track {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.75rem;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .mix-slider-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.2s ease-in-out;
        }

        .mix-slider-default-outline {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border: 1px solid black;
            border-radius: 9999px;
            box-sizing: border-box;
            background: transparent;
        }

        .value-input {
            width: 6rem;
            /* Adjust width as needed */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            text-align: right;
            background-color: rgba(255, 255, 255, 0.8);
        }

        /* Color-coded slider thumbs */
        .thumb-solar::-webkit-slider-thumb {
            background-color: rgba(251, 191, 36, 1);
        }

        .thumb-solar::-moz-range-thumb {
            background-color: rgba(251, 191, 36, 1);
        }

        .thumb-wind::-webkit-slider-thumb {
            background-color: rgba(52, 211, 153, 1);
        }

        /* Lighter green */
        .thumb-wind::-moz-range-thumb {
            background-color: rgba(52, 211, 153, 1);
        }

        /* Lighter green */
        .thumb-offshoreWind::-webkit-slider-thumb {
            background-color: rgba(12, 148, 103, 1);
        }

        .thumb-offshoreWind::-moz-range-thumb {
            background-color: rgba(12, 148, 103, 1);
        }

        .thumb-geothermal::-webkit-slider-thumb {
            background-color: rgba(120, 40, 40, 1);
        }

        .thumb-geothermal::-moz-range-thumb {
            background-color: rgba(120, 40, 40, 1);
        }

        .thumb-nuclear::-webkit-slider-thumb {
            background-color: rgba(239, 68, 68, 1);
        }

        .thumb-nuclear::-moz-range-thumb {
            background-color: rgba(239, 68, 68, 1);
        }

        .thumb-storage::-webkit-slider-thumb {
            background-color: rgba(168, 85, 247, 1);
        }

        .thumb-storage::-moz-range-thumb {
            background-color: rgba(168, 85, 247, 1);
        }

        .thumb-neutral::-webkit-slider-thumb {
            background-color: rgba(107, 114, 128, 1);
        }

        .thumb-neutral::-moz-range-thumb {
            background-color: rgba(107, 114, 128, 1);
        }

        .thumb-biomass::-webkit-slider-thumb {
            background-color: rgba(101, 67, 33, 1);
        }

        /* Brown color for biomass */
        .thumb-biomass::-moz-range-thumb {
            background-color: rgba(101, 67, 33, 1);
        }

        .thumb-rng::-webkit-slider-thumb {
            background-color: rgba(132, 204, 22, 1);
        }

        /* Lime green for RNG */
        .thumb-rng::-moz-range-thumb {
            background-color: rgba(132, 204, 22, 1);
        }

        .thumb-hydrogen::-webkit-slider-thumb {
            background-color: rgba(219, 39, 119, 1);
        }

        /* Pink/magenta for hydrogen */
        .thumb-hydrogen::-moz-range-thumb {
            background-color: rgba(219, 39, 119, 1);
        }

        /* Rainbow Border Animation */
        @keyframes rainbow-border {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        .rainbow-glow {
            position: relative;
            background: linear-gradient(90deg, #ff0080, #ff8000, #ffff00, #80ff00, #00ff80, #0080ff, #8000ff, #ff0080);
            background-size: 200% 200%;
            animation: rainbow-border 2s linear infinite;
            padding: 2px;
            border-radius: 9999px;
        }

        .rainbow-glow .button-content {
            background: #f3f4f6;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            display: block;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .rainbow-glow:hover .button-content {
            background: #e5e7eb;
        }

        /* Style for active season preset button */
        .preset-active {
            background-color: #4b5563 !important;
            /* A darker gray */
            color: #ffffff !important;
        }

        /* --- TUTORIAL STYLES --- */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            display: none;
            /* Controlled by JS */
        }

        #tutorial-popover {
            position: fixed;
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            width: 320px;
            max-width: 90vw;
            display: none;
            transition: top 0.3s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .tutorial-highlight-active {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7),
                0 0 20px 10px rgba(59, 130, 246, 0.4),
                0 0 0 9999px rgba(0, 0, 0, 0.6);
            transition: box-shadow 0.3s ease-in-out;
        }

        .tutorial-highlight-active.rounded-full {
            border-radius: 9999px;
        }

        .tutorial-highlight-active.rounded-lg {
            border-radius: 1rem;
        }
    </style>
</head>

<body class="antialiased">
    <!-- Tooltip element -->
    <div id="hover-tooltip"
        class="absolute hidden bg-gray-800 text-white text-sm rounded-md px-2 py-1 z-50 pointer-events-none shadow-lg">
    </div>

    <!-- TUTORIAL HTML -->
    <div id="tutorial-overlay"></div>
    <div id="tutorial-popover">
        <h3 id="tutorial-title" class="text-xl font-lora font-bold mb-2 text-gray-800"></h3>
        <p id="tutorial-text" class="text-gray-600 mb-4"></p>
        <div class="flex justify-between items-center">
            <button id="tutorial-skip" class="text-sm text-gray-500 hover:text-gray-800">Skip Tour</button>
            <div>
                <button id="tutorial-prev"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 mr-2">Prev</button>
                <button id="tutorial-next"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Next</button>
            </div>
        </div>
    </div>

    <div class="mesh-gradient-container">
        <div class="mesh-gradient-1"></div>

        <header class="p-8">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex flex-col">
                    <a href="/" class="font-lora text-2xl font-semibold">Dr. Eshan Singh</a>
                    <div class="text-sm text-gray-500 mt-1">
                        <span>Views: </span><span id="visitor-count">Loading...</span>
                    </div>
                </div>
                <nav class="flex items-center space-x-2">
                    <a href="/energy.html"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">Articles</a>
                    <a href="/transport-model/index.html" class="rainbow-glow">
                        <span class="button-content">Transport Model</span>
                    </a>
                    <a href="/grid-planner/index.html" class="rainbow-glow">
                        <span class="button-content">Grid Planner</span>
                    </a>
                    <a href="/grid-operator/index.html" class="rainbow-glow">
                        <span class="button-content">Grid Operator</span>
                    </a>
                    <a href="https://www.eshansingh.xyz/transmission/index.html" class="rainbow-glow">
                        <span class="button-content">CA Grid Map</span>
                    </a>
                    <a href="/musings.html"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">Musings</a>
                </nav>
            </div>
        </header>

        <div class="container mx-auto p-4 md:p-8 pt-0">

            <section id="tutorial-step-1" class="text-center mb-12">
                <h1 class="font-lora text-5xl md:text-6xl font-medium leading-tight text-gray-900">Grid Planning
                    Simulator</h1>
                <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">
                    Your challenge: Use policy levers for clean energy and direct air capture to eliminate CO2 emissions
                    from the electricity grid, while minimizing the impact on customer bill.
                </p>
                <div class="flex justify-center items-center space-x-4 mt-4">
                    <a href="grid-model-documentation.html"
                        class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors text-sm font-medium">
                        ðŸ“– View Documentation
                    </a>
                    <button id="start-tutorial-btn"
                        class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors text-sm font-medium">
                        ðŸš€ Show Tutorial
                    </button>
                </div>
                <p class="mt-4 text-sm text-gray-600">
                    Send your queries at <a href="mailto:hello@eshansingh.xyz"
                        class="text-blue-600 hover:underline">hello@eshansingh.xyz</a>
                </p>
            </section>

            <!-- Full Width Charts Section - LOAD GENERATION, PRICE, CO2 -->
            <div class="space-y-8 mb-8">
                <!-- Load Generation Chart -->
                <div class="glass-card rounded-lg w-full">
                    <div class="mb-4 relative">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-lora font-semibold text-gray-800">All Year - Hourly Electricity
                                Generation (GWh)</h2>
                        </div>
                        <canvas id="generationMixChart" height="100"></canvas>
                    </div>
                </div>

                <!-- Marginal Price Chart -->
                <div class="glass-card rounded-lg w-full">
                    <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">All Year - Hourly Marginal Price
                        ($/MWh)</h2>
                    <canvas id="marginalPriceChart" height="100"></canvas>
                </div>

                <!-- Monthly CO2 Emissions Bar Chart -->
                <div class="glass-card rounded-lg w-full">
                    <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Monthly Total CO2 Emissions (Metric
                        Tons)</h2>
                    <canvas id="co2EmissionsChart" height="100"></canvas>
                </div>
            </div>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Sliders Section Container -->
                <div id="tutorial-step-2" class="lg:col-span-2 glass-card rounded-lg">

                    <div id="tutorial-step-4" class="mt-8">
                        <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Installed Capacity Mix (%)</h2>
                        <div id="grid-mix-sliders" class="space-y-3">
                            <!-- Sliders will be dynamically inserted here -->
                        </div>
                        <!-- NEW: Container for storage capacity display -->
                        <div id="storage-capacity-display" class="mt-6"></div>
                    </div>
                    <div class="mt-8">
                        <h2 class="text-2xl font-lora font-semibold mb-4 text-gray-800">Yearly Generation Mix (%)</h2>
                        <div id="generation-mix-sliders" class="space-y-3">
                            <!-- New chart sliders will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-lora font-semibold text-gray-800">Hourly Capacity Factors</h2>
                            <div class="flex items-center space-x-2">
                                <div id="cf-edit-controls" class="flex items-center space-x-1">
                                    <button id="edit-cf-btn" class="p-2 rounded-full hover:bg-gray-200"
                                        title="Edit capacity factor profiles">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path
                                                d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                            <path fill-rule="evenodd"
                                                d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button id="revert-cf-btn" class="p-2 rounded-full hover:bg-gray-200 hidden"
                                        title="Revert to original capacity factor profiles">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button id="confirm-cf-btn" class="p-2 rounded-full hover:bg-gray-200 hidden"
                                        title="Confirm changes to capacity factors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <canvas id="capacityFactorChart"></canvas>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div id="tutorial-step-5" class="glass-card rounded-lg sticky top-6 z-10">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div
                                title="Based on the average wholesale price of electricity&#10;Assuming natural gas plant on the margin drives the price">
                                <h3 class="text-xl font-lora font-semibold text-gray-800">Marginal Price</h3>
                                <p id="bill-impact" class="text-5xl font-bold text-blue-600 mt-2">0%</p>
                            </div>
                            <div title="Based on the total annualized cost to operate the grid">
                                <h3 class="text-xl font-lora font-semibold text-gray-800">System Cost</h3>
                                <p id="system-cost-impact" class="text-5xl font-bold text-blue-600 mt-2">0%</p>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <p id="co2-avoided-text" class="text-md font-medium text-gray-700"></p>
                        </div>
                    </div>



                    <div id="tutorial-step-3" class="glass-card space-y-6 rounded-lg">
                        <div class="mb-6">
                            <label for="country-select" class="block text-md font-medium text-gray-700 mb-2">Select
                                Default Grid Mix</label>
                            <select id="country-select"
                                class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center justify-around">
                                <button id="undo-button"
                                    class="p-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Undo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button id="redo-button"
                                    class="p-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Redo" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <button id="make-default-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Set the current lever positions as your new default">Make Default</button>
                            <button id="reset-to-default-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Reset levers to the default for this grid mix">Reset to Default</button>
                            <button id="reset-to-zero-button"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                                title="Reset all policy and new capacity levers to zero">Reset to Zero</button>
                        </div>
                        <div>
                            <h2
                                class="text-2xl font-lora font-semibold mb-4 border-b border-t pt-4 border-gray-300 pb-4 text-gray-800">
                                Policy Levers</h2>
                            <div class="space-y-6 pt-4">
                                <!-- Levers -->
                                <div>
                                    <label for="solar-slider" class="block text-md font-medium text-gray-700">New Solar
                                        Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="solar-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-solar">
                                        <input type="number" id="solar-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="solar-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="wind-slider" class="block text-md font-medium text-gray-700">New Onshore
                                        Wind Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="wind-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-wind">
                                        <input type="number" id="wind-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="wind-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="offshoreWind-slider" class="block text-md font-medium text-gray-700">New
                                        Offshore Wind Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="offshoreWind-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-offshoreWind">
                                        <input type="number" id="offshoreWind-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="offshoreWind-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="geothermal-slider" class="block text-md font-medium text-gray-700">New
                                        Geothermal Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="geothermal-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-geothermal">
                                        <input type="number" id="geothermal-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="geothermal-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="nuclear-slider" class="block text-md font-medium text-gray-700">New
                                        Nuclear Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="nuclear-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-nuclear">
                                        <input type="number" id="nuclear-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="nuclear-unit">GW</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="biomass-slider" class="block text-md font-medium text-gray-700">New
                                        Biomass Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="biomass-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-biomass">
                                        <input type="number" id="biomass-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="biomass-unit">GW</span>
                                    </div>
                                </div>
                                <!-- NEW: RNG (Biogas) Slider -->
                                <div>
                                    <label for="rng-slider" class="block text-md font-medium text-gray-700">New RNG
                                        (Biogas) Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="rng-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-rng">
                                        <input type="number" id="rng-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left" id="rng-unit">GW</span>
                                    </div>
                                </div>
                                <!-- NEW: Hydrogen Slider -->
                                <div>
                                    <label for="hydrogen-slider" class="block text-md font-medium text-gray-700">New
                                        Hydrogen Capacity</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="hydrogen-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-hydrogen">
                                        <input type="number" id="hydrogen-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="hydrogen-unit">GW</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="battery4hr-slider" class="block text-md font-medium text-gray-700">4-hr
                                        Battery Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="battery4hr-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="battery4hr-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="battery4hr-unit">GWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="battery8hr-slider" class="block text-md font-medium text-gray-700">8-hr
                                        Battery Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="battery8hr-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="battery8hr-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="battery8hr-unit">GWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="longduration-slider"
                                        class="block text-md font-medium text-gray-700">24-hr Long Duration
                                        Storage</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="longduration-slider" min="0" max="500" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="longduration-input" min="0" max="500" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="longduration-unit">GWh</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="demandflex-slider"
                                        class="block text-md font-medium text-gray-700">Demand Flexibility</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="demandflex-slider" min="0" max="25" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="demandflex-input" min="0" max="25" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="demandflex-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h2
                                class="text-2xl font-lora font-semibold mb-4 border-b border-t border-gray-300 pt-6 pb-4 text-gray-800">
                                Government Incentives</h2>
                            <div class="space-y-6 pt-4">
                                <!-- Incentive levers -->
                                <div>
                                    <label for="carbon-tax-slider"
                                        class="block text-sm font-medium text-gray-700">Carbon Tax</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="carbon-tax-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="carbon-tax-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="carbon-tax-unit">$/ton</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="export-price-slider"
                                        class="block text-sm font-medium text-gray-700">Export Price</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="export-price-slider" min="-100" max="100" value="-20"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="export-price-input" min="-100" max="100" value="-20"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="export-price-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-300 pt-6">
                                    <label for="solar-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Solar (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="solar-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-solar">
                                        <input type="number" id="solar-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="solar-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="wind-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Onshore Wind (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="wind-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-wind">
                                        <input type="number" id="wind-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="wind-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="offshoreWind-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Offshore Wind (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="offshoreWind-incentive-slider" min="0" max="50"
                                            value="0" class="w-full form-input thumb-offshoreWind">
                                        <input type="number" id="offshoreWind-incentive-input" min="0" max="50"
                                            value="0" class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="offshoreWind-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="geothermal-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Geothermal (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="geothermal-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-geothermal">
                                        <input type="number" id="geothermal-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="geothermal-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="nuclear-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Nuclear (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="nuclear-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-nuclear">
                                        <input type="number" id="nuclear-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="nuclear-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="biomass-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Biomass (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="biomass-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-biomass">
                                        <input type="number" id="biomass-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="biomass-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <!-- NEW: RNG (Biogas) Incentive Slider -->
                                <div>
                                    <label for="rng-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">RNG (Biogas) (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="rng-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-rng">
                                        <input type="number" id="rng-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="rng-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <!-- NEW: Hydrogen Incentive Slider -->
                                <div>
                                    <label for="hydrogen-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Hydrogen (PTC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="hydrogen-incentive-slider" min="0" max="50" value="0"
                                            class="w-full form-input thumb-hydrogen">
                                        <input type="number" id="hydrogen-incentive-input" min="0" max="50" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="hydrogen-incentive-unit">$/MWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="storage-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Storage (ITC)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="storage-incentive-slider" min="0" max="100" value="0"
                                            class="w-full form-input thumb-storage">
                                        <input type="number" id="storage-incentive-input" min="0" max="100" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="storage-incentive-unit">$/kWh</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="dac-incentive-slider"
                                        class="block text-sm font-medium text-gray-700">Direct Air Capture (45Q)</label>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <input type="range" id="dac-incentive-slider" min="0" max="200" value="0"
                                            class="w-full form-input thumb-neutral">
                                        <input type="number" id="dac-incentive-input" min="0" max="200" value="0"
                                            class="value-input">
                                        <span class="font-semibold text-gray-900 w-12 text-left"
                                            id="dac-incentive-unit">$/ton</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-300 pt-6">
                            <label for="dac-slider" class="block text-md font-medium text-gray-700">Direct Air Capture
                                Deployment</label>
                            <div class="flex items-center space-x-2 mt-2">
                                <input type="range" id="dac-slider" min="0" max="10000" value="0"
                                    class="w-full form-input thumb-neutral">
                                <input type="number" id="dac-input" min="0" max="10000" value="0" class="value-input">
                                <span class="font-semibold text-gray-900 w-12 text-left" id="dac-unit">t/hr</span>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    </main>
    </div>
    </div>
    <!-- Copyright Footer -->
    <footer class="container mx-auto p-4 mt-12 text-center border-t border-gray-200">
        <p class="text-sm text-gray-600">
            Â© 2025 <a href="https://eshansingh.xyz" class="font-medium text-gray-800 hover:text-blue-600">Dr. Eshan
                Singh</a>. All rights reserved.
        </p>
        <p class="text-xs text-gray-500 mt-1">
            For licensing inquiries: <a href="mailto:hello@eshansingh.xyz"
                class="text-blue-600 hover:text-blue-700 underline">hello@eshansingh.xyz</a>
        </p>
    </footer>
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdEeu0VugTfZD-R-62pFvBdb313TeM4xs",
            authDomain: "grid-decarbonization.firebaseapp.com",
            projectId: "grid-decarbonization",
            storageBucket: "grid-decarbonization.appspot.com",
            messagingSenderId: "902419724670",
            appId: "1:902419724670:web:b636a75ea44325946a9b2f",
            measurementId: "G-3Q9HE19CGN"
        };

        // --- INITIALIZE FIREBASE & DEFINE KEY VARIABLES ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId;

        // --- MODEL PARAMETERS & DATA (GLOBAL SCOPE) ---
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const DAYS_IN_MONTH = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        const HOURS = [];
        MONTHS.forEach(m => {
            Array.from({ length: 24 }, (_, i) => HOURS.push(`${m} ${i}:00`));
        });

        const countryGridMixData = {
            "California": {
                totalCapacityMW: 89223,
                peakLoadsMW: { summer: 52061, winter: 47500, fall: 46000, spring: 41000 },
                mix: { coal: 0.1, naturalGas: 43.4, hydro: 15.7, wind: 7.1, offshoreWind: 0, solar: 26.1, nuclear: 2.7, geothermal: 3.0, biomass: 1.0, rng: 0.4 },
                storageGWh: { battery4hr: 53.0 },
                defaultExportPrice: -20
            },
            "China": {
                totalCapacityMW: 3400000,
                peakLoadsMW: { summer: 1340000, winter: 1206000, fall: 1179200, spring: 1072000 },
                mix: { coal: 40.0, naturalGas: 8.0, hydro: 12.5, wind: 14.0, offshoreWind: 1.6, solar: 20.0, nuclear: 2.5, geothermal: 0.1, biomass: 0.9, rng: 0.4 },
                storageGWh: { battery4hr: 222 }
            },
            "United States": {
                totalCapacityMW: 1275000,
                peakLoadsMW: { summer: 800000, winter: 720000, fall: 704000, spring: 640000 },
                mix: { coal: 15.0, naturalGas: 48.0, hydro: 7.8, wind: 11.5, offshoreWind: 0.2, solar: 9.0, nuclear: 8.0, geothermal: 0.3, biomass: 0.8, rng: 0.4 },
                storageGWh: { battery4hr: 95 }
            },
            "India": {
                totalCapacityMW: 476000,
                peakLoadsMW: { summer: 243000, winter: 206550, fall: 213840, spring: 194400 },
                mix: { coal: 50.0, naturalGas: 6.0, hydro: 10.0, wind: 9.5, offshoreWind: 0, solar: 18.0, nuclear: 1.8, geothermal: 0.0, biomass: 1.9, rng: 0.8 },
                storageGWh: { battery4hr: 1 }
            },
            "Japan": {
                totalCapacityMW: 295000,
                peakLoadsMW: { summer: 181000, winter: 162900, fall: 159280, spring: 144800 },
                mix: { coal: 20.0, naturalGas: 35.0, hydro: 17.0, wind: 1.6, offshoreWind: 0.1, solar: 15.5, nuclear: 10.5, geothermal: 0.2, biomass: 1.1, rng: 0.5 },
                storageGWh: { battery4hr: 1.2 }
            },
            "Russia": {
                totalCapacityMW: 248000,
                peakLoadsMW: { winter: 160000, summer: 144000, fall: 140800, spring: 128000 },
                mix: { coal: 15.0, naturalGas: 52.0, hydro: 20.0, wind: 0.9, offshoreWind: 0, solar: 0.8, nuclear: 11.3, geothermal: 0.0, biomass: 0.1, rng: 0.1 }
            },
            "Brazil": {
                totalCapacityMW: 180000,
                peakLoadsMW: { summer: 101860, winter: 91674, fall: 89637, spring: 81488 },
                mix: { coal: 2.0, naturalGas: 18.0, hydro: 59.0, wind: 10.5, offshoreWind: 0, solar: 9.5, nuclear: 1.0, geothermal: 0.0, biomass: 5.6, rng: 2.4 }
            },
            "Germany": {
                totalCapacityMW: 210000,
                peakLoadsMW: { winter: 84000, summer: 75600, fall: 73920, spring: 67200 },
                mix: { coal: 14.0, naturalGas: 38.0, hydro: 4.0, wind: 22.0, offshoreWind: 4.0, solar: 12.0, nuclear: 5.0, geothermal: 0.0, biomass: 4.2, rng: 1.8 },
                storageGWh: { battery4hr: 22.1 }
            },
            "Canada": {
                totalCapacityMW: 165000,
                peakLoadsMW: { winter: 140000, summer: 126000, fall: 123200, spring: 112000 },
                mix: { coal: 4.5, naturalGas: 13.5, hydro: 57.0, wind: 8.5, offshoreWind: 0, solar: 2.5, nuclear: 14.0, geothermal: 0.0, biomass: 1.4, rng: 0.6 },
                storageGWh: { battery4hr: 1 }
            },
            "South Korea": {
                totalCapacityMW: 125000,
                peakLoadsMW: { summer: 93000, winter: 83700, fall: 81840, spring: 74400 },
                mix: { coal: 34.0, naturalGas: 20.0, hydro: 5.0, wind: 1.4, offshoreWind: 0.1, solar: 12.5, nuclear: 27.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 9 }
            },
            "France": {
                totalCapacityMW: 115000,
                peakLoadsMW: { winter: 102000, summer: 91800, fall: 89760, spring: 81600 },
                mix: { coal: 1.0, naturalGas: 10.0, hydro: 10.0, wind: 8.0, offshoreWind: 0.5, solar: 6.0, nuclear: 64.0, geothermal: 0.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 1.0 }
            },
            "United Kingdom": {
                totalCapacityMW: 78000,
                peakLoadsMW: { winter: 60000, summer: 54000, fall: 52800, spring: 48000 },
                mix: { coal: 1.0, naturalGas: 38.0, hydro: 2.0, wind: 15.0, offshoreWind: 14.0, solar: 19.0, nuclear: 9.0, geothermal: 0.0, biomass: 4.2, rng: 1.8 },
                storageGWh: { battery4hr: 16.0 }
            },
            "Australia": {
                totalCapacityMW: 65000,
                peakLoadsMW: { summer: 47000, winter: 42300, fall: 41360, spring: 37600 },
                mix: { coal: 45.0, naturalGas: 18.0, hydro: 13.0, wind: 10.0, offshoreWind: 0, solar: 13.0, nuclear: 0.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 5.6 }
            },
            "Spain": {
                totalCapacityMW: 120000,
                peakLoadsMW: { summer: 45000, winter: 40500, fall: 39600, spring: 36000 },
                mix: { coal: 2.0, naturalGas: 22.0, hydro: 17.0, wind: 27.5, offshoreWind: 0, solar: 21.5, nuclear: 7.0, geothermal: 0.0, biomass: 1.0, rng: 0.4 },
                storageGWh: { battery4hr: 1.7 }
            },
            "Italy": {
                totalCapacityMW: 122000,
                peakLoadsMW: { summer: 60000, winter: 54000, fall: 52800, spring: 48000 },
                mix: { coal: 4.0, naturalGas: 47.0, hydro: 18.0, wind: 10.0, offshoreWind: 0, solar: 19.0, nuclear: 0.0, geothermal: 1.0, biomass: 1.4, rng: 0.6 },
                storageGWh: { battery4hr: 6 }
            },
            "Indonesia": {
                totalCapacityMW: 75000,
                peakLoadsMW: { summer: 50000, winter: 45000, fall: 44000, spring: 40000 },
                mix: { coal: 48.0, naturalGas: 28.0, hydro: 9.0, wind: 0.2, offshoreWind: 0, solar: 2.8, nuclear: 0.0, geothermal: 3.0, biomass: 0.7, rng: 0.3 }
            },
            "South Africa": {
                totalCapacityMW: 60000,
                peakLoadsMW: { winter: 34000, summer: 30600, fall: 29920, spring: 27200 },
                mix: { coal: 78.0, naturalGas: 6.0, hydro: 6.0, wind: 5.5, offshoreWind: 0, solar: 3.5, nuclear: 0.0, geothermal: 0.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 2 }
            },
            "Mexico": {
                totalCapacityMW: 88000,
                peakLoadsMW: { summer: 50000, winter: 45000, fall: 44000, spring: 40000 },
                mix: { coal: 5.0, naturalGas: 58.0, hydro: 15.0, wind: 9.0, offshoreWind: 0, solar: 11.0, nuclear: 1.0, geothermal: 1.0, biomass: 0.3, rng: 0.1 },
                storageGWh: { battery4hr: 0.6 }
            },
            "Norway": {
                totalCapacityMW: 39000,
                peakLoadsMW: { winter: 25000, summer: 22500, fall: 22000, spring: 20000 },
                mix: { coal: 0.0, naturalGas: 0.0, hydro: 91.0, wind: 8.5, offshoreWind: 0, solar: 0.5, nuclear: 0.0, geothermal: 0.0, biomass: 0.0, rng: 0.0 },
                storageGWh: { battery4hr: 0.2 }
            },
            "New Zealand": {
                totalCapacityMW: 9800,
                peakLoadsMW: { winter: 7000, summer: 6300, fall: 6160, spring: 5600 },
                mix: { coal: 0.0, naturalGas: 14.0, hydro: 56.0, wind: 7.5, offshoreWind: 0, solar: 1.5, nuclear: 0.0, geothermal: 20.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 0.4 }
            },
            "Vietnam": {
                totalCapacityMW: 80000,
                peakLoadsMW: { summer: 45000, winter: 40500, fall: 39600, spring: 36000 },
                mix: { coal: 32.0, naturalGas: 9.0, hydro: 28.0, wind: 6.0, offshoreWind: 0, solar: 24.0, nuclear: 0.0, geothermal: 0.0, biomass: 0.7, rng: 0.3 },
                storageGWh: { battery4hr: 0.1 }
            }
        };

        const carbonTaxes = {
            "California": 26, "Canada": 61, "China": 8, "France": 48, "Germany": 43, "Japan": 2,
            "South Korea": 22, "Spain": 16, "United Kingdom": 22, "South Africa": 9,
            "Mexico": 3, "Norway": 85, "New Zealand": 50
        };

        // High-demand seasonal profiles (used for non-California countries)
        const SEASONAL_DEMAND_PROFILES = {
            'spring-high': [28, 26, 25, 24, 24, 25, 28, 32, 33, 32, 30, 28, 27, 28, 30, 34, 39, 45, 48, 46, 42, 38, 34, 30],
            'summer-high': [30, 28, 27, 26, 26, 27, 29, 33, 37, 40, 42, 44, 46, 48, 50, 52, 55, 56, 55, 52, 48, 43, 38, 33],
            'fall-high': [27, 25, 24, 23, 23, 24, 27, 31, 34, 36, 37, 38, 39, 40, 41, 43, 46, 50, 49, 46, 42, 37, 32, 29],
            'winter-high': [32, 30, 29, 29, 30, 34, 40, 45, 44, 42, 40, 39, 39, 40, 41, 43, 45, 46, 45, 42, 39, 36, 34, 32],
            // Typical profiles (scaled from high profiles)
            'spring-typical': [28, 26, 25, 24, 24, 25, 28, 32, 33, 32, 30, 28, 27, 28, 30, 34, 39, 45, 48, 46, 42, 38, 34, 30].map(v => v * 0.79),
            'summer-typical': [30, 28, 27, 26, 26, 27, 29, 33, 37, 40, 42, 44, 46, 48, 50, 52, 55, 56, 55, 52, 48, 43, 38, 33].map(v => v * 0.82),
            'fall-typical': [27, 25, 24, 23, 23, 24, 27, 31, 34, 36, 37, 38, 39, 40, 41, 43, 46, 50, 49, 46, 42, 37, 32, 29].map(v => v * 0.77),
            'winter-typical': [32, 30, 29, 29, 30, 34, 40, 45, 44, 42, 40, 39, 39, 40, 41, 43, 45, 46, 45, 42, 39, 36, 34, 32].map(v => v * 0.73)
        };

        // California profiles loaded from JSON (populated during initialization)
        let CALIFORNIA_PROFILES = {};

        // This object will hold the calculated POTENTIAL generation, not a pre-dispatched baseline.
        let BASELINE_POTENTIAL_GENERATION = {};
        let currentCountryInstalledCapacity = {};
        let currentBaselineStorage = {};
        let yearlyGenerationTotalsGWh = {}; // For tooltips

        const SOLAR_CF_PROFILE = [0, 0, 0, 0, 0, 0.05, 0.15, 0.3, 0.5, 0.7, 0.8, 0.85, 0.9, 0.85, 0.8, 0.7, 0.3, 0.05, 0, 0, 0, 0, 0, 0];
        const WIND_CF_PROFILE = [0.4, 0.42, 0.45, 0.46, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.2, 0.2, 0.25, 0.3, 0.35, 0.4, 0.5, 0.6, 0.65, 0.6, 0.55, 0.5, 0.45, 0.4];
        const OFFSHORE_WIND_CF_PROFILE = [0.55, 0.56, 0.57, 0.58, 0.58, 0.57, 0.55, 0.52, 0.5, 0.48, 0.47, 0.46, 0.47, 0.48, 0.5, 0.52, 0.55, 0.6, 0.62, 0.61, 0.6, 0.58, 0.57, 0.56];

        const SEASONAL_HYDRO_CF = {
            spring: 0.50,
            summer: 0.30,
            fall: 0.25,
            winter: 0.35
        };

        const SEASONAL_MULTIPLIERS = {
            spring: { solar: 1.0, wind: 1.0, offshoreWind: 1.0 },
            summer: { solar: 1.1, wind: 0.8, offshoreWind: 0.9 },
            fall: { solar: 0.8, wind: 1.0, offshoreWind: 1.0 },
            winter: { solar: 0.6, wind: 1.1, offshoreWind: 1.1 }
        };
        const countryProfiles = {
            "California": { // Using default CA profile
                solar: SOLAR_CF_PROFILE,
                wind: WIND_CF_PROFILE,
                offshoreWind: OFFSHORE_WIND_CF_PROFILE
            },
            "Germany": {
                solar: [0, 0, 0, 0, 0, 0.02, 0.1, 0.25, 0.45, 0.6, 0.7, 0.75, 0.7, 0.6, 0.4, 0.15, 0.05, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.5, 0.52, 0.55, 0.56, 0.55, 0.5, 0.45, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.45, 0.5, 0.6, 0.7, 0.75, 0.7, 0.65, 0.6, 0.55, 0.5],
                offshoreWind: [0.6, 0.62, 0.65, 0.66, 0.65, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.55, 0.6, 0.7, 0.8, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6]
            },
            "United Kingdom": {
                solar: [0, 0, 0, 0, 0, 0.01, 0.08, 0.2, 0.4, 0.55, 0.65, 0.7, 0.65, 0.55, 0.35, 0.1, 0.02, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.6, 0.62, 0.65, 0.68, 0.66, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.55, 0.6, 0.7, 0.8, 0.85, 0.8, 0.75, 0.7, 0.65, 0.6],
                offshoreWind: [0.7, 0.72, 0.75, 0.78, 0.76, 0.7, 0.65, 0.6, 0.55, 0.5, 0.5, 0.5, 0.55, 0.6, 0.65, 0.7, 0.8, 0.9, 0.95, 0.9, 0.85, 0.8, 0.75, 0.7]
            },
            "Australia": {
                solar: [0, 0, 0, 0, 0, 0.08, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.9, 0.8, 0.6, 0.3, 0.1, 0, 0, 0, 0, 0, 0, 0],
                wind: [0.3, 0.3, 0.3, 0.25, 0.2, 0.2, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.45, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.4, 0.35, 0.3],
                offshoreWind: [0.4, 0.4, 0.4, 0.35, 0.3, 0.3, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.55, 0.5, 0.45, 0.4, 0.4, 0.4, 0.45, 0.5, 0.5, 0.45, 0.4]
            },
            "default": {
                solar: SOLAR_CF_PROFILE,
                wind: WIND_CF_PROFILE,
                offshoreWind: OFFSHORE_WIND_CF_PROFILE
            }
        };
        const EMISSION_FACTORS = { naturalGas: 395, hydro: 0, nuclear: 0, solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, coal: 850, biomass: 0, rng: 0, hydrogen: 0 };

        const COST_DATA = {
            capex: {
                solar: 1200, wind: 1500, offshoreWind: 5000, nuclear: 7242, geothermal: 3329, biomass: 3500, rng: 3000, hydrogen: 3500,
                naturalGas: 1300, hydro: 3336, coal: 4407,
                battery4hr: 350, battery8hr: 300, longduration: 300, // $/kWh
                dac: 1000 // $/ton/year
            },
            fixed_om: {
                solar: 15, wind: 35, offshoreWind: 100, nuclear: 140, geothermal: 120, biomass: 100, rng: 95, hydrogen: 90, // $/kW-year
                naturalGas: 20, hydro: 20, coal: 40,
                battery4hr: 15, battery8hr: 15, longduration: 60, // $/kW-year
                dac: 20 // $/ton/year
            },
            variable_om: {
                solar: 0, wind: 1, offshoreWind: 0, nuclear: 10, geothermal: 5, biomass: 10, rng: 50, hydrogen: 410, // $/MWh - includes green H2 fuel cost (~$6/kg at 45% efficiency)
                naturalGasCCGT: { start: 35, end: 80 }, // NEW: $/MWh
                naturalGasCT: { start: 100, end: 150 }, // NEW: $/MWh
                hydro: 5, coal: 30, // $/MWh
                battery4hr: 0, battery8hr: 2, longduration: 1,
                dac: 400, // $/ton
                storage: 30 // $/MWh - an assumed opportunity cost for dispatching storage
            },
            lifetime: {
                solar: 30, wind: 30, offshoreWind: 30, nuclear: 60, geothermal: 30, biomass: 25, rng: 25, hydrogen: 30,
                naturalGas: 30, hydro: 80, coal: 40,
                battery4hr: 15, battery8hr: 15, longduration: 25, dac: 25
            },
            capacity_factor: {
                solar: 0.25, wind: 0.35, offshoreWind: 0.50, nuclear: 0.9, geothermal: 0.9, biomass: 0.85, rng: 0.85, hydrogen: 0.20,
                naturalGas: 0.55, hydro: 0.45, coal: 0.6
            },
            discount_rate: 0.07
        };

        document.addEventListener('DOMContentLoaded', async function () {
            setLogLevel('debug');

            // --- DOM ELEMENTS ---
            const sliders = {
                solar: document.getElementById('solar-slider'), wind: document.getElementById('wind-slider'), offshoreWind: document.getElementById('offshoreWind-slider'),
                geothermal: document.getElementById('geothermal-slider'), nuclear: document.getElementById('nuclear-slider'),
                biomass: document.getElementById('biomass-slider'), rng: document.getElementById("rng-slider"), hydrogen: document.getElementById("hydrogen-slider"),
                battery4hr: document.getElementById('battery4hr-slider'), battery8hr: document.getElementById('battery8hr-slider'),
                longduration: document.getElementById('longduration-slider'), demandflex: document.getElementById('demandflex-slider'),
                dac: document.getElementById('dac-slider'), solarIncentive: document.getElementById('solar-incentive-slider'),
                windIncentive: document.getElementById('wind-incentive-slider'), offshoreWindIncentive: document.getElementById('offshoreWind-incentive-slider'),
                geothermalIncentive: document.getElementById('geothermal-incentive-slider'),
                nuclearIncentive: document.getElementById('nuclear-incentive-slider'), biomassIncentive: document.getElementById('biomass-incentive-slider'),
                rngIncentive: document.getElementById("rng-incentive-slider"), hydrogenIncentive: document.getElementById("hydrogen-incentive-slider"),
                storageIncentive: document.getElementById('storage-incentive-slider'),
                dacIncentive: document.getElementById('dac-incentive-slider'), carbonTax: document.getElementById('carbon-tax-slider'),
                exportPrice: document.getElementById('export-price-slider'),
            };
            const inputs = {
                solar: document.getElementById('solar-input'), wind: document.getElementById('wind-input'), offshoreWind: document.getElementById('offshoreWind-input'),
                geothermal: document.getElementById('geothermal-input'), nuclear: document.getElementById('nuclear-input'),
                biomass: document.getElementById('biomass-input'), rng: document.getElementById("rng-input"), hydrogen: document.getElementById("hydrogen-input"),
                battery4hr: document.getElementById('battery4hr-input'), battery8hr: document.getElementById('battery8hr-input'),
                longduration: document.getElementById('longduration-input'), demandflex: document.getElementById('demandflex-input'),
                dac: document.getElementById('dac-input'), solarIncentive: document.getElementById('solar-incentive-input'),
                windIncentive: document.getElementById('wind-incentive-input'), offshoreWindIncentive: document.getElementById('offshoreWind-incentive-input'),
                geothermalIncentive: document.getElementById('geothermal-incentive-input'),
                nuclearIncentive: document.getElementById('nuclear-incentive-input'), biomassIncentive: document.getElementById('biomass-incentive-input'),
                rngIncentive: document.getElementById("rng-incentive-input"), hydrogenIncentive: document.getElementById("hydrogen-incentive-input"),
                storageIncentive: document.getElementById('storage-incentive-input'),
                dacIncentive: document.getElementById('dac-incentive-input'), carbonTax: document.getElementById('carbon-tax-input'),
                exportPrice: document.getElementById('export-price-input'),
            };

            const billImpactEl = document.getElementById('bill-impact');
            const systemCostImpactEl = document.getElementById('system-cost-impact');
            const co2AvoidedEl = document.getElementById('co2-avoided-text');
            const resetToZeroButton = document.getElementById('reset-to-zero-button');
            const makeDefaultButton = document.getElementById('make-default-button');
            const resetToDefaultButton = document.getElementById('reset-to-default-button');
            const undoButton = document.getElementById('undo-button');
            const redoButton = document.getElementById('redo-button');
            const gridMixSlidersContainer = document.getElementById('grid-mix-sliders');
            const storageCapacityDisplayContainer = document.getElementById('storage-capacity-display');
            const generationMixSlidersContainer = document.getElementById('generation-mix-sliders');
            const countrySelect = document.getElementById('country-select');
            const hoverTooltip = document.getElementById('hover-tooltip');
            const startTutorialBtn = document.getElementById('start-tutorial-btn');

            const currentDemandProfileText = document.getElementById('current-demand-profile-text');
            const editDemandBtn = document.getElementById('edit-demand-btn');
            const confirmDemandBtn = document.getElementById('confirm-demand-btn');
            const revertDemandBtn = document.getElementById('revert-demand-btn');
            const demandPresetsDiv = document.getElementById('demand-presets');

            const editCFBtn = document.getElementById('edit-cf-btn');
            const confirmCFBtn = document.getElementById('confirm-cf-btn');
            const revertCFBtn = document.getElementById('revert-cf-btn');
            const visitorCountEl = document.getElementById('visitor-count');


            // --- STATE MANAGEMENT ---
            let stateHistory = [];
            let historyIndex = -1;
            let userDefaultState = {};
            let systemDefaultState = {};
            let customBaselineSystemCost = 0;
            let customBaselineConsumerCost = 0; // NEW
            let customBaselineTotalAnnualCO2 = 0;
            let enabledTechnologies = {};
            let defaultCapacityMix = {};
            let defaultGenerationMix = {};
            let currentSystemDefaultProfileName = 'spring-typical';

            let isDemandEditMode = false;
            let currentDemand = [...SEASONAL_DEMAND_PROFILES['spring-high']];
            let originalDemandBeforeEdit = [];
            let currentDemandProfileName = 'Spring Typical';

            let isCFEditMode = false;
            let currentSolarCFProfile = [];
            let currentWindCFProfile = [];
            let currentOffshoreWindCFProfile = [];
            let currentHydroCF = SEASONAL_HYDRO_CF.spring; // Initialize with spring
            let originalSolarCFBeforeEdit = [];
            let originalWindCFBeforeEdit = [];
            let originalOffshoreWindCFBeforeEdit = [];
            let currentCFProfileName = 'Spring';


            // --- CHARTING SETUP ---
            const generationCtx = document.getElementById('generationMixChart').getContext('2d');
            const marginalPriceCtx = document.getElementById('marginalPriceChart').getContext('2d'); // NEW
            const co2Ctx = document.getElementById('co2EmissionsChart').getContext('2d');
            const capacityFactorCtx = document.getElementById('capacityFactorChart').getContext('2d');

            const COLORS = {
                naturalGas: 'rgba(107, 114, 128, 0.8)', hydro: 'rgba(59, 130, 246, 0.8)',
                nuclear: 'rgba(239, 68, 68, 0.8)', solar: 'rgba(251, 191, 36, 1)',
                wind: 'rgba(52, 211, 153, 0.8)', /* CHANGE: Lighter green for Onshore Wind */
                offshoreWind: 'rgba(12, 148, 103, 0.8)',
                geothermal: 'rgba(120, 40, 40, 0.8)',
                biomass: 'rgba(101, 67, 33, 0.8)',
                rng: 'rgba(132, 204, 22, 0.8)',
                hydrogen: 'rgba(219, 39, 119, 0.8)', /* Pink/magenta for hydrogen */
                storage: 'rgba(168, 85, 247, 0.8)', demand: 'rgba(17, 24, 39, 1)',
                curtailment: 'rgba(253, 186, 116, 0.8)', coal: 'rgba(0, 0, 0, 0.8)',
                price: 'rgba(79, 70, 229, 1)' // NEW for price chart
            };

            // Helper function to create a patterned fill for "to Storage" generation
            function createPattern(baseColor, patternColor) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 10;
                canvas.height = 10;
                ctx.fillStyle = baseColor;
                ctx.fillRect(0, 0, 10, 10);
                ctx.strokeStyle = patternColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, 10);
                ctx.lineTo(10, 0);
                ctx.moveTo(-1, 1);
                ctx.lineTo(1, -1);
                ctx.moveTo(9, 11);
                ctx.lineTo(11, 9);
                ctx.stroke();
                return ctx.createPattern(canvas, 'repeat');
            }

            const PATTERNS = {
                solarToStorage: createPattern(COLORS.solar, 'rgba(168, 85, 247, 0.7)'),
                windToStorage: createPattern(COLORS.wind, 'rgba(168, 85, 247, 0.7)'),
                offshoreWindToStorage: createPattern(COLORS.offshoreWind, 'rgba(168, 85, 247, 0.7)'),
                hydroToStorage: createPattern(COLORS.hydro, COLORS.storage),
                geothermalToStorage: createPattern(COLORS.geothermal, COLORS.storage),
                nuclearToStorage: createPattern(COLORS.nuclear, COLORS.storage),
                coalToStorage: createPattern(COLORS.coal, COLORS.storage),
                naturalGasToStorage: createPattern(COLORS.naturalGas, COLORS.storage),
                biomassToStorage: createPattern(COLORS.biomass, COLORS.storage),
            };

            const generationChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [
                        { label: 'Nuclear', data: [], backgroundColor: COLORS.nuclear, borderColor: COLORS.nuclear, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Geothermal', data: [], backgroundColor: COLORS.geothermal, borderColor: COLORS.geothermal, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Biomass', data: [], backgroundColor: COLORS.biomass, borderColor: COLORS.biomass, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'RNG (Biogas)', data: [], backgroundColor: COLORS.rng, borderColor: COLORS.rng, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Hydrogen', data: [], backgroundColor: COLORS.hydrogen, borderColor: COLORS.hydrogen, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Hydro', data: [], backgroundColor: COLORS.hydro, borderColor: COLORS.hydro, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Onshore Wind', data: [], backgroundColor: COLORS.wind, borderColor: COLORS.wind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Offshore Wind', data: [], backgroundColor: COLORS.offshoreWind, borderColor: COLORS.offshoreWind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Solar', data: [], backgroundColor: COLORS.solar, borderColor: COLORS.solar, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Natural Gas', data: [], backgroundColor: COLORS.naturalGas, borderColor: COLORS.naturalGas, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Coal', data: [], backgroundColor: COLORS.coal, borderColor: COLORS.coal, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Storage', data: [], backgroundColor: COLORS.storage, borderColor: COLORS.storage, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Solar to Storage', data: [], backgroundColor: PATTERNS.solarToStorage, borderColor: COLORS.solar, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Onshore Wind to Storage', data: [], backgroundColor: PATTERNS.windToStorage, borderColor: COLORS.wind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Offshore Wind to Storage', data: [], backgroundColor: PATTERNS.offshoreWindToStorage, borderColor: COLORS.offshoreWind, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false, hidden: false },
                        { label: 'Curtailment', data: [], backgroundColor: COLORS.curtailment, borderColor: COLORS.curtailment, borderWidth: 1, fill: true, stack: 'generators', pointRadius: 0, tension: 0.1, dragData: false },
                        { label: 'Demand', data: currentDemand, type: 'line', borderColor: COLORS.demand, borderWidth: 1.5, pointRadius: 0, fill: false, order: -1 }
                    ]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                title: function (context) {
                                    return context[0].label;
                                },
                                label: function (context) {
                                    return ''; // We build the full tooltip in the footer
                                },
                                footer: function (tooltipItems) {
                                    const totals = {};
                                    let stackTotal = 0;

                                    tooltipItems.forEach(function (tooltipItem) {
                                        let label = tooltipItem.dataset.label;
                                        const value = tooltipItem.raw;
                                        if (value === 0) return;

                                        // Consolidate "to Storage" tooltips
                                        if (label.includes('to Storage')) {
                                            const sourceTech = label.replace(' to Storage', '');
                                            label = `${sourceTech} (to Storage)`;
                                        }

                                        totals[label] = (totals[label] || 0) + value;

                                        if (tooltipItem.dataset.type !== 'line') {
                                            if (!label.includes('to Storage') && label !== 'Curtailment') {
                                                stackTotal += value;
                                            }
                                        }
                                    });

                                    const lines = [];
                                    const tooltipOrder = ['Coal', 'Natural Gas', 'Hydro', 'Geothermal', 'Biomass', 'RNG (Biogas)', 'Hydrogen', 'Nuclear', 'Solar', 'Onshore Wind', 'Offshore Wind', 'Storage', 'Curtailment', 'Solar (to Storage)', 'Onshore Wind (to Storage)', 'Offshore Wind (to Storage)', 'Demand'];
                                    tooltipOrder.forEach(label => {
                                        if (totals[label] > 0.01) {
                                            lines.push(`${label}: ${totals[label].toFixed(2)}`);
                                        }
                                    });

                                    if (stackTotal > 0) {
                                        lines.push('------------------');
                                        lines.push(`Total Gen to Grid: ${stackTotal.toFixed(2)}`);
                                    }
                                    return lines;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                filter: function (legendItem) {
                                    return !legendItem.text.includes('to Storage') && legendItem.text !== 'Demand';
                                }
                            }
                        },
                        dragData: { enabled: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    // Show month name only at the center of each month (hour 12 of 24)
                                    if (index % 24 === 12) {
                                        const monthIndex = Math.floor(index / 24);
                                        return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][monthIndex];
                                    }
                                    return '';
                                },
                                autoSkip: false,
                                maxRotation: 0
                            }
                        },
                        y: { stacked: true, title: { display: true, text: 'Generation (GWh)' } }
                    }
                }
            };
            const marginalPriceChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [{
                        label: 'Marginal Price (with Storage)', data: [],
                        borderColor: COLORS.price, backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0
                    }, {
                        label: 'Marginal Price (without Storage)', data: [],
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1.5, borderDash: [5, 5],
                        fill: false, tension: 0.3, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    scales: {
                        x: {
                            title: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    // Show month name only at the center of each month (hour 12 of 24)
                                    if (index % 24 === 12) {
                                        const monthIndex = Math.floor(index / 24);
                                        return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][monthIndex];
                                    }
                                    return '';
                                },
                                autoSkip: false,
                                maxRotation: 0
                            }
                        },
                        y: { title: { display: true, text: 'Price ($/MWh)' } }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            };
            const co2ChartConfig = {
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: 'Total CO2 Emissions (Metric Tons)', data: [],
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Total CO2 (Metric Tons)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                totalCO2: {
                                    type: 'label',
                                    content: 'Total Annual CO2: 0 tons',
                                    position: { x: 'center', y: 'top' },
                                    yAdjust: 10,
                                    backgroundColor: 'rgba(249, 250, 251, 0.85)',
                                    borderColor: 'rgba(209, 213, 219, 1)',
                                    borderWidth: 1,
                                    borderRadius: 6,
                                    color: '#1f2937',
                                    font: { weight: 'bold', size: 16 },
                                    padding: 8,
                                }
                            }
                        }
                    }
                }
            };
            const capacityFactorChartConfig = {
                type: 'line',
                data: {
                    labels: HOURS,
                    datasets: [
                        { label: 'Solar', data: [], borderColor: COLORS.solar, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4, dragData: false },
                        { label: 'Onshore Wind', data: [], borderColor: COLORS.wind, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4, dragData: false },
                        { label: 'Offshore Wind', data: [], borderColor: COLORS.offshoreWind, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4, dragData: false }
                    ]
                },
                options: {
                    responsive: true, animation: { duration: 0 },
                    plugins: {
                        legend: { position: 'bottom' },
                        dragData: {
                            round: 2,
                            showTooltip: true,
                            onDrag: (e, datasetIndex, index, value) => {
                                // Enforce constraints DURING dragging for real-time feedback
                                if (value < 0) return 0;
                                if (value > 1) return 1;
                                return value;
                            },
                            onDragEnd: (e, datasetIndex, index, value) => {
                                const chart = e.chart;
                                let updatedValue = value;
                                if (value < 0) updatedValue = 0;
                                if (value > 1) updatedValue = 1;
                                chart.data.datasets[datasetIndex].data[index] = updatedValue;
                                chart.update('none');
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    // Show month name only at the center of each month (hour 12 of 24)
                                    if (index % 24 === 12) {
                                        const monthIndex = Math.floor(index / 24);
                                        return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][monthIndex];
                                    }
                                    return '';
                                },
                                autoSkip: false,
                                maxRotation: 0
                            }
                        },
                        y: { title: { display: true, text: 'Capacity Factor (%)' }, min: 0, max: 1, ticks: { callback: value => `${value * 100}%` } }
                    }
                }
            };

            const generationChart = new Chart(generationCtx, generationChartConfig);
            const marginalPriceChart = new Chart(marginalPriceCtx, marginalPriceChartConfig); // NEW
            const co2Chart = new Chart(co2Ctx, co2ChartConfig);
            const capacityFactorChart = new Chart(capacityFactorCtx, capacityFactorChartConfig);

            // Magnifying glass for capacity factor chart
            const cfMagnifier = document.getElementById('cf-magnifier');
            const cfMagnifierCanvas = document.getElementById('cf-magnifier-canvas');
            const cfMagnifierCtx = cfMagnifierCanvas.getContext('2d');

            function updateMagnifier(e, chart) {
                // Only show magnifier when in edit mode
                if (!isCFEditMode) return;

                const rect = chart.canvas.getBoundingClientRect();

                // Calculate cursor position relative to canvas
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Only show magnifier if cursor is within canvas display bounds
                if (mouseX < 0 || mouseX > rect.width || mouseY < 0 || mouseY > rect.height) {
                    hideMagnifier();
                    return;
                }

                // Convert display coordinates to canvas coordinates (handle canvas scaling)
                const scaleX = chart.canvas.width / rect.width;
                const scaleY = chart.canvas.height / rect.height;
                const x = mouseX * scaleX;
                const y = mouseY * scaleY;

                // Position magnifier centered on cursor
                const magnifierLeft = e.clientX - 100;
                const magnifierTop = e.clientY - 100;

                cfMagnifier.style.left = magnifierLeft + 'px';
                cfMagnifier.style.top = magnifierTop + 'px';
                cfMagnifier.classList.remove('hidden');

                // Draw zoomed portion of chart
                const sourceSize = 80; // 80px becomes 200px = 2.5x zoom
                const sourceX = x - sourceSize / 2;
                const sourceY = y - sourceSize / 2;

                cfMagnifierCtx.fillStyle = 'white';
                cfMagnifierCtx.fillRect(0, 0, 200, 200);
                cfMagnifierCtx.drawImage(
                    chart.canvas,
                    sourceX, sourceY, sourceSize, sourceSize,
                    0, 0, 200, 200
                );

                // Draw crosshair at center
                cfMagnifierCtx.strokeStyle = '#EF4444';
                cfMagnifierCtx.lineWidth = 2;
                cfMagnifierCtx.beginPath();
                cfMagnifierCtx.moveTo(100, 90);
                cfMagnifierCtx.lineTo(100, 110);
                cfMagnifierCtx.moveTo(90, 100);
                cfMagnifierCtx.lineTo(110, 100);
                cfMagnifierCtx.stroke();
            }

            function hideMagnifier() {
                cfMagnifier.classList.add('hidden');
            }

            // Add event listeners to capacity factor chart for magnifier
            capacityFactorCtx.canvas.addEventListener('mousemove', (e) => {
                if (isCFEditMode) {
                    updateMagnifier(e, capacityFactorChart);
                }
            });

            capacityFactorCtx.canvas.addEventListener('mouseleave', hideMagnifier);


            // --- COST CALCULATION ---
            function calculateTotalAnnualSystemCost(generation, capacity, currentIncentives, curtailedEnergy, baselineCapacity, baselineStorage, gasGenDetails) {
                let totalAnnualCost = 0;
                const d = COST_DATA.discount_rate;
                const numHours = generation.solar.length;
                const hoursPerMonth = 24;

                function getAnnualSum(profile) {
                    if (!profile) return 0;
                    let sum = 0;
                    for (let i = 0; i < numHours; i++) {
                        const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                        sum += profile[i] * DAYS_IN_MONTH[monthIndex];
                    }
                    return sum;
                }

                for (const tech in COST_DATA.capacity_factor) {
                    if (tech === 'naturalGas') continue;

                    const techData = COST_DATA;
                    if (!techData.lifetime[tech]) continue;
                    const n = techData.lifetime[tech];
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                    const baselineCapacityGW = baselineCapacity[tech] || 0;
                    const newCapacityGW = capacity[tech] || 0;
                    const totalCapacityKW = (baselineCapacityGW + newCapacityGW) * 1000000;

                    if (totalCapacityKW > 0) {
                        const annualized_capex = techData.capex[tech] * totalCapacityKW * crf;
                        const annual_fom = techData.fixed_om[tech] * totalCapacityKW;
                        const annual_generation_mwh = getAnnualSum(generation[tech]) * 1000;
                        const annual_vom = techData.variable_om[tech] * annual_generation_mwh;

                        let annual_ptc = 0;
                        if (currentIncentives[tech]) {
                            annual_ptc = currentIncentives[tech] * annual_generation_mwh;
                        }

                        totalAnnualCost += annualized_capex + annual_fom + annual_vom - annual_ptc;
                    }
                }

                const baselineNGCapacityGW = baselineCapacity.naturalGas || 0;
                const newNGCapacityGW = capacity.naturalGas || 0;
                const totalNGCapacityKW = (baselineNGCapacityGW + newNGCapacityGW) * 1000000;

                if (totalNGCapacityKW > 0) {
                    const n = COST_DATA.lifetime.naturalGas;
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);
                    const annualized_capex = COST_DATA.capex.naturalGas * totalNGCapacityKW * crf;
                    const annual_fom = COST_DATA.fixed_om.naturalGas * totalNGCapacityKW;
                    const annual_vom_ng = (gasGenDetails?.ccgt?.cost || 0) + (gasGenDetails?.ct?.cost || 0);
                    totalAnnualCost += annualized_capex + annual_fom + annual_vom_ng;
                }

                for (const type of ['battery4hr', 'battery8hr', 'longduration']) {
                    if (!enabledTechnologies[type]) continue;
                    const baseline_gwh = baselineStorage[type] || 0;
                    const new_gwh = capacity[type] || 0;
                    const total_gwh = baseline_gwh + new_gwh;

                    if (total_gwh > 0) {
                        if (!COST_DATA.lifetime[type]) continue;
                        const n = COST_DATA.lifetime[type];
                        const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                        let capex_per_kwh = COST_DATA.capex[type] - currentIncentives.storage;
                        const total_kwh = total_gwh * 1000000;
                        const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                        const total_kw = total_kwh / duration;

                        const annualized_capex = capex_per_kwh * total_kwh * crf;
                        const annual_fom = COST_DATA.fixed_om[type] * total_kw;
                        const annual_discharge_mwh = getAnnualSum(generation.storage) * 1000;
                        const annual_vom = COST_DATA.variable_om[type] * annual_discharge_mwh;

                        totalAnnualCost += annualized_capex + annual_fom + annual_vom;
                    }
                }

                if (capacity.dac > 0) {
                    const annualDacCapacityTons = capacity.dac * 24 * 365;
                    const n = COST_DATA.lifetime.dac;
                    const crf = (d * Math.pow(1 + d, n)) / (Math.pow(1 + d, n) - 1);

                    const annualizedDacCapex = COST_DATA.capex.dac * annualDacCapacityTons * crf;
                    const annualDacFom = COST_DATA.fixed_om.dac * annualDacCapacityTons;
                    const dacVariableCost = annualDacCapacityTons * COST_DATA.variable_om.dac;
                    const dacIncentiveValue = annualDacCapacityTons * currentIncentives.dac;

                    totalAnnualCost += (annualizedDacCapex + annualDacFom + dacVariableCost - dacIncentiveValue);
                }

                const totalAnnualCO2 = getAnnualSum(calculateEmissions(generation, 0));
                totalAnnualCost += totalAnnualCO2 * currentIncentives.carbonTax;

                const annualExportRevenue = getAnnualSum(curtailedEnergy) * 1000 * currentIncentives.exportPrice;
                totalAnnualCost -= annualExportRevenue;

                return totalAnnualCost;
            }

            // NEW: Function to calculate consumer cost based on marginal price
            function calculateAnnualConsumerCost(hourlyMarginalPrice, demand) {
                let totalCost = 0;
                const numHours = hourlyMarginalPrice.length;
                const hoursPerMonth = 24;
                for (let i = 0; i < numHours; i++) {
                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    totalCost += hourlyMarginalPrice[i] * demand[i] * 1000 * DAYS_IN_MONTH[monthIndex];
                }
                return totalCost;
            }


            // --- REWRITTEN DISPATCH LOGIC ---
            function getSimulationResult(inputs, solarProfile, windProfile, offshoreWindProfile, potentialGen, baselineStorageGWh = {}, hydroCF, countryName, storageOverrideDisabled = false) {
                const VRE_SOURCES = ['solar', 'wind', 'offshoreWind'];
                const INFLEXIBLE_SOURCES = ['nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                const numHours = solarProfile.length;

                let finalGeneration = {
                    coal: Array(numHours).fill(0), naturalGas: Array(numHours).fill(0),
                    hydro: Array(numHours).fill(0), nuclear: Array(numHours).fill(0),
                    geothermal: Array(numHours).fill(0), biomass: Array(numHours).fill(0), rng: Array(numHours).fill(0), hydrogen: Array(numHours).fill(0),
                    solar: Array(numHours).fill(0), wind: Array(numHours).fill(0), offshoreWind: Array(numHours).fill(0),
                    storage: Array(numHours).fill(0), curtailment: Array(numHours).fill(0),
                    solarToStorage: Array(numHours).fill(0), windToStorage: Array(numHours).fill(0), offshoreWindToStorage: Array(numHours).fill(0)
                };

                let curtailmentBySource = { solar: Array(numHours).fill(0), wind: Array(numHours).fill(0), offshoreWind: Array(numHours).fill(0) };

                let modifiedDemand = [...currentDemand];

                if (inputs.capacity.demandflex > 0) {
                    for (let dayStart = 0; dayStart < numHours; dayStart += 24) {
                        const dayLoad = modifiedDemand.slice(dayStart, dayStart + 24);
                        const originalPeak = Math.max(...dayLoad);
                        let totalAmountToShift = originalPeak * (inputs.capacity.demandflex / 100);

                        const shiftIncrement = 0.1;
                        let iterations = 0;
                        while (totalAmountToShift > 0.01 && iterations < 100) {
                            const currentPeak = Math.max(...dayLoad);
                            const currentTrough = Math.min(...dayLoad);
                            if (currentPeak <= currentTrough) break;

                            const peakIndex = dayLoad.indexOf(currentPeak);
                            const troughIndex = dayLoad.indexOf(currentTrough);

                            const amount = Math.min(shiftIncrement, totalAmountToShift);
                            dayLoad[peakIndex] -= amount;
                            dayLoad[troughIndex] += amount;

                            modifiedDemand[dayStart + peakIndex] -= amount;
                            modifiedDemand[dayStart + troughIndex] += amount;

                            totalAmountToShift -= amount;
                            iterations++;
                        }
                    }
                }


                let currentPotential = JSON.parse(JSON.stringify(potentialGen));

                // Ensure all technology arrays exist and are correctly sized to numHours
                const allTechs = ['solar', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen', 'hydro', 'naturalGas', 'coal'];
                for (const tech of allTechs) {
                    if (!currentPotential[tech] || currentPotential[tech].length !== numHours) {
                        // If array is missing or wrong size, create/resize it
                        const existingArray = currentPotential[tech] || [];
                        currentPotential[tech] = Array(numHours).fill(0);
                        // Copy existing values if any
                        for (let j = 0; j < Math.min(existingArray.length, numHours); j++) {
                            currentPotential[tech][j] = existingArray[j] || 0;
                        }
                        // For arrays that were shorter, repeat the 24-hour pattern
                        if (existingArray.length === 24 && numHours > 24) {
                            for (let j = 24; j < numHours; j++) {
                                currentPotential[tech][j] = existingArray[j % 24] || 0;
                            }
                        }
                    }
                }

                for (let i = 0; i < numHours; i++) {
                    currentPotential.solar[i] += inputs.capacity.solar * solarProfile[i];
                    currentPotential.wind[i] += inputs.capacity.wind * windProfile[i];
                    currentPotential.offshoreWind[i] += inputs.capacity.offshoreWind * offshoreWindProfile[i];
                    currentPotential.nuclear[i] += inputs.capacity.nuclear * COST_DATA.capacity_factor.nuclear;
                    currentPotential.geothermal[i] += inputs.capacity.geothermal * COST_DATA.capacity_factor.geothermal;
                    currentPotential.biomass[i] += inputs.capacity.biomass * COST_DATA.capacity_factor.biomass;
                    currentPotential.rng[i] += inputs.capacity.rng * COST_DATA.capacity_factor.rng;
                    currentPotential.hydrogen[i] += inputs.capacity.hydrogen * COST_DATA.capacity_factor.hydrogen;
                }
                const hydroCapacity = (currentCountryInstalledCapacity.hydro || 0) + (inputs.capacity.hydro || 0);
                const maxHourlyHydroOutput = countryName === 'California' ? hydroCapacity * 0.32 : hydroCapacity;

                let netLoad = Array(numHours).fill(0);
                for (let i = 0; i < numHours; i++) {
                    let vreAndInflexibleGen = 0;
                    [...INFLEXIBLE_SOURCES, ...VRE_SOURCES].forEach(tech => {
                        const potential = currentPotential[tech][i];
                        finalGeneration[tech][i] = potential;
                        vreAndInflexibleGen += potential;
                    });
                    netLoad[i] = modifiedDemand[i] - vreAndInflexibleGen;
                }

                if (!storageOverrideDisabled) {
                    const storageDispatch = dispatchStorageEconomically(netLoad, inputs, baselineStorageGWh, currentPotential);
                    finalGeneration.storage = storageDispatch.discharge;

                    for (let i = 0; i < numHours; i++) {
                        netLoad[i] += storageDispatch.charge[i];
                        netLoad[i] -= storageDispatch.discharge[i];

                        if (storageDispatch.charge[i] > 0) {
                            let totalVrePotential = finalGeneration.solar[i] + finalGeneration.wind[i] + finalGeneration.offshoreWind[i];
                            if (totalVrePotential > 0) {
                                const vreChargeAmount = Math.min(storageDispatch.charge[i], totalVrePotential);
                                let solarCharge = (finalGeneration.solar[i] / totalVrePotential) * vreChargeAmount;
                                let windCharge = (finalGeneration.wind[i] / totalVrePotential) * vreChargeAmount;
                                let offshoreCharge = (finalGeneration.offshoreWind[i] / totalVrePotential) * vreChargeAmount;

                                finalGeneration.solarToStorage[i] = solarCharge = Math.min(solarCharge, finalGeneration.solar[i]);
                                finalGeneration.windToStorage[i] = windCharge = Math.min(windCharge, finalGeneration.wind[i]);
                                finalGeneration.offshoreWindToStorage[i] = offshoreCharge = Math.min(offshoreCharge, finalGeneration.offshoreWind[i]);

                                finalGeneration.solar[i] -= solarCharge;
                                finalGeneration.wind[i] -= windCharge;
                                finalGeneration.offshoreWind[i] -= offshoreCharge;
                            }
                        }
                    }
                }

                for (let i = 0; i < numHours; i++) {
                    if (netLoad[i] < 0) {
                        finalGeneration.curtailment[i] = -netLoad[i];
                        let availableForCurtailment = 0;
                        VRE_SOURCES.forEach(tech => availableForCurtailment += finalGeneration[tech][i]);

                        if (availableForCurtailment > 0) {
                            VRE_SOURCES.forEach(tech => {
                                const proportion = finalGeneration[tech][i] / availableForCurtailment;
                                const reduction = Math.min(finalGeneration.curtailment[i] * proportion, finalGeneration[tech][i]);
                                curtailmentBySource[tech][i] += reduction;
                                finalGeneration[tech][i] -= reduction;
                            });
                        }
                        netLoad[i] = 0;
                    }
                }

                for (let dayStart = 0; dayStart < numHours; dayStart += 24) {
                    const dayNetLoad = netLoad.slice(dayStart, dayStart + 24);
                    const totalDailyHydroEnergy = hydroCapacity * hydroCF * 24;
                    const baseloadHydroEnergy = totalDailyHydroEnergy * 0.40;
                    let flexibleHydroEnergy = totalDailyHydroEnergy * 0.60;

                    const deficitHours = dayNetLoad.map((load, h) => load > 0.01 ? h + dayStart : -1).filter(h => h !== -1);
                    if (deficitHours.length > 0) {
                        const hourlyBaseloadHydro = baseloadHydroEnergy / deficitHours.length;
                        deficitHours.forEach(i => {
                            const hydroToDispatch = Math.min(hourlyBaseloadHydro, netLoad[i], maxHourlyHydroOutput - finalGeneration.hydro[i]);
                            finalGeneration.hydro[i] += hydroToDispatch;
                            netLoad[i] -= hydroToDispatch;
                        });
                    }
                    while (flexibleHydroEnergy > 0.01) {
                        let maxPriority = -Infinity, maxPriorityHour = -1;
                        for (let i = dayStart; i < dayStart + 24; i++) {
                            if (netLoad[i] > 0.01 && netLoad[i] > maxPriority) {
                                maxPriority = netLoad[i];
                                maxPriorityHour = i;
                            }
                        }
                        if (maxPriorityHour === -1) break;
                        const hydroToDispatch = Math.min(0.1, flexibleHydroEnergy, netLoad[maxPriorityHour], maxHourlyHydroOutput - finalGeneration.hydro[maxPriorityHour]);
                        if (hydroToDispatch < 0.001) break;
                        finalGeneration.hydro[maxPriorityHour] += hydroToDispatch;
                        netLoad[maxPriorityHour] -= hydroToDispatch;
                        flexibleHydroEnergy -= hydroToDispatch;
                    }
                }

                const { gasGenDetails, hourlyMarginalPrice, thermalGeneration } = calculateThermalDispatchAndPrice(netLoad, inputs, currentPotential);
                finalGeneration.naturalGas = thermalGeneration.naturalGas;
                finalGeneration.coal = thermalGeneration.coal;

                for (let i = 0; i < numHours; i++) {
                    if (finalGeneration.curtailment[i] > 0.01) {
                        hourlyMarginalPrice[i] = inputs.incentives.exportPrice;
                    }
                }

                const newEmissions = calculateEmissions(finalGeneration, inputs.capacity.dac);
                const newSystemCost = calculateTotalAnnualSystemCost(finalGeneration, inputs.capacity, inputs.incentives, finalGeneration.curtailment, currentCountryInstalledCapacity, baselineStorageGWh, gasGenDetails);

                return {
                    generation: finalGeneration,
                    emissions: newEmissions,
                    systemCost: newSystemCost,
                    demand: modifiedDemand,
                    curtailmentBySource: curtailmentBySource,
                    hourlyMarginalPrice: hourlyMarginalPrice
                };
            }

            function calculateThermalDispatchAndPrice(netLoad, inputs, currentPotential) {
                const gasGenDetails = { ccgt: { generation: 0, cost: 0 }, ct: { generation: 0, cost: 0 } };
                const numHours = netLoad.length;
                const hourlyMarginalPrice = Array(numHours).fill(0);
                const thermalGeneration = { naturalGas: Array(numHours).fill(0), coal: Array(numHours).fill(0) };

                const totalNGCapacity = (currentCountryInstalledCapacity.naturalGas || 0) + (inputs.capacity.naturalGas || 0);
                const ccgtCapacity = totalNGCapacity * 0.7;
                const ctCapacity = totalNGCapacity * 0.3;

                const hoursPerMonth = 24;

                for (let i = 0; i < numHours; i++) {
                    let remainingLoad = netLoad[i];
                    let hourlyPrice = 0;

                    if (remainingLoad <= 0.01) {
                        hourlyMarginalPrice[i] = 0;
                        continue;
                    }

                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    const days = DAYS_IN_MONTH[monthIndex];

                    if (ccgtCapacity > 0) {
                        const ccgtToDispatch = Math.min(remainingLoad, ccgtCapacity);
                        if (ccgtToDispatch > 0) {
                            thermalGeneration.naturalGas[i] += ccgtToDispatch;
                            remainingLoad -= ccgtToDispatch;
                            const costStart = COST_DATA.variable_om.naturalGasCCGT.start;
                            const costEnd = COST_DATA.variable_om.naturalGasCCGT.end;
                            const priceAtDispatch = costStart + (costEnd - costStart) * (ccgtToDispatch / ccgtCapacity);
                            hourlyPrice = Math.max(hourlyPrice, priceAtDispatch);
                            const avgCost = (costStart + priceAtDispatch) / 2;
                            gasGenDetails.ccgt.cost += ccgtToDispatch * 1000 * avgCost * days;
                        }
                    }

                    if (remainingLoad > 0.01 && ctCapacity > 0) {
                        const ctToDispatch = Math.min(remainingLoad, ctCapacity);
                        if (ctToDispatch > 0) {
                            thermalGeneration.naturalGas[i] += ctToDispatch;
                            remainingLoad -= ctToDispatch;
                            const costStart = COST_DATA.variable_om.naturalGasCT.start;
                            const costEnd = COST_DATA.variable_om.naturalGasCT.end;
                            const priceAtDispatch = costStart + (costEnd - costStart) * (ctToDispatch / ctCapacity);
                            hourlyPrice = Math.max(hourlyPrice, priceAtDispatch);
                            const avgCost = (costStart + priceAtDispatch) / 2;
                            gasGenDetails.ct.cost += ctToDispatch * 1000 * avgCost * days;
                        }
                    }

                    if (remainingLoad > 0.01 && currentPotential.coal[i] > 0) {
                        const coalToDispatch = Math.min(remainingLoad, currentPotential.coal[i]);
                        thermalGeneration.coal[i] += coalToDispatch;
                        remainingLoad -= coalToDispatch;
                        hourlyPrice = Math.max(hourlyPrice, COST_DATA.variable_om.coal);
                    }
                    hourlyMarginalPrice[i] = hourlyPrice;
                }
                return { gasGenDetails, hourlyMarginalPrice, thermalGeneration };
            }

            function dispatchStorageEconomically(initialNetLoad, inputs, baselineStorageGWh, currentPotential) {
                const storageTypes = ['battery4hr', 'battery8hr', 'longduration'];
                const storageCapacityGWh = {};
                const storagePowerGW = {};
                let totalStorageEnergyGWh = 0;

                storageTypes.forEach(type => {
                    if (enabledTechnologies[type]) {
                        const capacity = (baselineStorageGWh[type] || 0) + inputs.capacity[type];
                        storageCapacityGWh[type] = capacity;
                        totalStorageEnergyGWh += capacity;
                        const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                        storagePowerGW[type] = capacity / duration;
                    } else {
                        storageCapacityGWh[type] = 0;
                        storagePowerGW[type] = 0;
                    }
                });

                const numHours = initialNetLoad.length;

                if (totalStorageEnergyGWh === 0) {
                    return { charge: Array(numHours).fill(0), discharge: Array(numHours).fill(0) };
                }

                let netLoad = [...initialNetLoad];
                let hourlyCharge = Array(numHours).fill(0);
                let hourlyDischarge = Array(numHours).fill(0);
                let totalChargedGWh = 0;

                const storageEfficiency = 0.85;
                const DISPATCH_INCREMENT = 0.1;
                const PROFIT_THRESHOLD = 20;

                for (let dayStart = 0; dayStart < numHours; dayStart += 24) {

                    let dayPotential = {};
                    for (let k in currentPotential) {
                        if (Array.isArray(currentPotential[k])) dayPotential[k] = currentPotential[k].slice(dayStart, dayStart + 24);
                    }

                    let dayNetLoad = netLoad.slice(dayStart, dayStart + 24);
                    let dayCharge = Array(24).fill(0);
                    let dayDischarge = Array(24).fill(0);

                    let dayTotalCharged = 0;

                    while (true) {
                        const { hourlyMarginalPrice } = calculateThermalDispatchAndPrice(dayNetLoad, inputs, dayPotential);

                        let maxPrice = -Infinity, minPrice = Infinity;
                        let maxPriceHour = -1, minPriceHour = -1;

                        // Find max and min prices
                        for (let i = 0; i < 24; i++) {
                            if (hourlyMarginalPrice[i] > maxPrice) { maxPrice = hourlyMarginalPrice[i]; }
                            if (hourlyMarginalPrice[i] < minPrice) { minPrice = hourlyMarginalPrice[i]; }
                        }

                        // Find all hours with maximum price, then pick the one with least existing discharge
                        // This spreads discharging across multiple high-price hours
                        const maxPriceHours = [];
                        for (let i = 0; i < 24; i++) {
                            if (Math.abs(hourlyMarginalPrice[i] - maxPrice) < 0.01) {
                                maxPriceHours.push(i);
                            }
                        }

                        if (maxPriceHours.length > 0) {
                            maxPriceHour = maxPriceHours[0];
                            let minExistingDischarge = dayDischarge[maxPriceHours[0]];
                            for (let j = 1; j < maxPriceHours.length; j++) {
                                const hour = maxPriceHours[j];
                                if (dayDischarge[hour] < minExistingDischarge) {
                                    minExistingDischarge = dayDischarge[hour];
                                    maxPriceHour = hour;
                                }
                            }
                        }

                        // Find all hours with minimum price, then pick the one with least existing charge
                        // This spreads charging across multiple low-price hours instead of concentrating it
                        const minPriceHours = [];
                        for (let i = 0; i < 24; i++) {
                            if (Math.abs(hourlyMarginalPrice[i] - minPrice) < 0.01) {
                                minPriceHours.push(i);
                            }
                        }

                        if (minPriceHours.length > 0) {
                            // Pick the hour with the least existing charge to spread charging out
                            minPriceHour = minPriceHours[0];
                            let minExistingCharge = dayCharge[minPriceHours[0]];
                            for (let j = 1; j < minPriceHours.length; j++) {
                                const hour = minPriceHours[j];
                                if (dayCharge[hour] < minExistingCharge) {
                                    minExistingCharge = dayCharge[hour];
                                    minPriceHour = hour;
                                }
                            }
                        }

                        if ((maxPrice * storageEfficiency) - minPrice <= PROFIT_THRESHOLD || maxPriceHour === -1 || minPriceHour === -1) break;

                        let availableCharge = 0, availableDischarge = 0;
                        storageTypes.forEach(t => { availableCharge += storagePowerGW[t]; availableDischarge += storagePowerGW[t]; });

                        const chargeHeadroom = availableCharge - dayCharge[minPriceHour];
                        const dischargeHeadroom = availableDischarge - dayDischarge[maxPriceHour];
                        const energyHeadroom = totalStorageEnergyGWh - dayTotalCharged;

                        const dispatchAmount = Math.min(DISPATCH_INCREMENT, chargeHeadroom, dischargeHeadroom, energyHeadroom);
                        if (dispatchAmount < 0.01) break;

                        const chargeAmount = dispatchAmount / storageEfficiency;
                        dayCharge[minPriceHour] += chargeAmount;
                        dayDischarge[maxPriceHour] += dispatchAmount;
                        dayTotalCharged += chargeAmount;

                        dayNetLoad[minPriceHour] += chargeAmount;
                        dayNetLoad[maxPriceHour] -= dispatchAmount;
                    }

                    for (let i = 0; i < 24; i++) {
                        hourlyCharge[dayStart + i] = dayCharge[i];
                        hourlyDischarge[dayStart + i] = dayDischarge[i];
                        netLoad[dayStart + i] = dayNetLoad[i];
                    }
                }

                return { charge: hourlyCharge, discharge: hourlyDischarge };
            }


            function runSimulation() {
                // Collect inputs
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                const selectedCountry = countrySelect.value;
                // If profiles aren't ready, use empty arrays (prevents crash on first load)
                const baseProfiles = {
                    solar: countryProfiles[selectedCountry]?.solar || countryProfiles['default'].solar,
                    wind: countryProfiles[selectedCountry]?.wind || countryProfiles['default'].wind,
                    offshoreWind: countryProfiles[selectedCountry]?.offshoreWind || countryProfiles['default'].offshoreWind
                };

                // Construct 12-month profiles
                let fullSolarProfile = [];
                let fullWindProfile = [];
                let fullOffshoreWindProfile = [];
                const fullDemand = [];

                // Check if we should use user-defined profiles instead of rebuilding from base
                if (currentCFProfileName === "User Defined" &&
                    currentSolarCFProfile.length === 288 &&
                    currentWindCFProfile.length === 288 &&
                    currentOffshoreWindCFProfile.length === 288) {
                    // Use the saved user-defined profiles directly
                    fullSolarProfile = [...currentSolarCFProfile];
                    fullWindProfile = [...currentWindCFProfile];
                    fullOffshoreWindProfile = [...currentOffshoreWindCFProfile];
                } else {
                    // Build profiles from base with seasonal multipliers
                    // Map months to seasons (0=Jan, 11=Dec)
                    const userSeasonMap = [
                        'winter', 'winter', // Jan, Feb
                        'spring', 'spring', 'spring', // Mar, Apr, May
                        'summer', 'summer', 'summer', 'summer', // Jun, Jul, Aug, Sep
                        'fall', 'fall', // Oct, Nov
                        'winter' // Dec
                    ];

                    for (let m = 0; m < 12; m++) {
                        const season = userSeasonMap[m];
                        const seasonalMultipliers = SEASONAL_MULTIPLIERS[season] || { solar: 1.0, wind: 1.0, offshoreWind: 1.0 };

                        // Apply seasonal multipliers to base profiles to create monthly profiles
                        const sSolar = baseProfiles.solar.map(cf => Math.min(1, cf * seasonalMultipliers.solar));
                        const sWind = baseProfiles.wind.map(cf => Math.min(1, cf * seasonalMultipliers.wind));
                        const sOffshoreWind = baseProfiles.offshoreWind.map(cf => Math.min(1, cf * seasonalMultipliers.offshoreWind));

                        fullSolarProfile.push(...sSolar);
                        fullWindProfile.push(...sWind);
                        fullOffshoreWindProfile.push(...sOffshoreWind);
                    }
                }

                // Determine if we are using High or Typical demand based on current selection
                const isHighDemand = currentDemandProfileName.toLowerCase().includes('high');

                // Map months to seasons for demand (0=Jan, 11=Dec)
                const userSeasonMap = [
                    'winter', 'winter', // Jan, Feb
                    'spring', 'spring', 'spring', // Mar, Apr, May
                    'summer', 'summer', 'summer', 'summer', // Jun, Jul, Aug, Sep
                    'fall', 'fall', // Oct, Nov
                    'winter' // Dec
                ];

                let activePotentialGeneration = {};
                if (typeof BASELINE_POTENTIAL_GENERATION !== 'undefined') {
                    for (const tech in BASELINE_POTENTIAL_GENERATION) {
                        activePotentialGeneration[tech] = [];
                    }
                }

                for (let m = 0; m < 12; m++) {
                    const season = userSeasonMap[m];

                    // Demand Generation - use the appropriate seasonal profile
                    // For typical: 'winter-typical', 'spring-typical', etc.
                    // For high: 'winter-high', 'spring-high', etc.
                    const demandType = isHighDemand ? 'high' : 'typical';
                    const demandKey = `${season}-${demandType}`;
                    const sDemand = SEASONAL_DEMAND_PROFILES[demandKey] || SEASONAL_DEMAND_PROFILES[`${season}-high`] || Array(24).fill(30);
                    fullDemand.push(...sDemand);

                    // Duplicate potential generation for 12 months
                    if (typeof BASELINE_POTENTIAL_GENERATION !== 'undefined') {
                        for (const tech in BASELINE_POTENTIAL_GENERATION) {
                            activePotentialGeneration[tech].push(...(BASELINE_POTENTIAL_GENERATION[tech] || Array(24).fill(0)));
                        }
                    }
                }

                currentDemand = fullDemand; // Update global currentDemand

                // If using user-defined CFs, recalculate activePotentialGeneration for VRE sources
                if (currentCFProfileName === "User Defined" && typeof BASELINE_POTENTIAL_GENERATION !== 'undefined') {
                    // Recalculate potential generation for solar, wind, and offshoreWind based on edited CFs
                    const capacity = {
                        solar: parseFloat(sliders.solar.value),
                        wind: parseFloat(sliders.wind.value),
                        offshoreWind: parseFloat(sliders.offshoreWind.value)
                    };

                    if (activePotentialGeneration.solar && capacity.solar > 0) {
                        activePotentialGeneration.solar = fullSolarProfile.map(cf => cf * capacity.solar);
                    }
                    if (activePotentialGeneration.wind && capacity.wind > 0) {
                        activePotentialGeneration.wind = fullWindProfile.map(cf => cf * capacity.wind);
                    }
                    if (activePotentialGeneration.offshoreWind && capacity.offshoreWind > 0) {
                        activePotentialGeneration.offshoreWind = fullOffshoreWindProfile.map(cf => cf * capacity.offshoreWind);
                    }
                }

                // DEBUG: Log array lengths to identify the issue
                console.log('DEBUG runSimulation:', {
                    fullDemandLength: fullDemand.length,
                    fullSolarProfileLength: fullSolarProfile.length,
                    fullWindProfileLength: fullWindProfile.length,
                    fullOffshoreWindProfileLength: fullOffshoreWindProfile.length,
                    activePotentialGenerationSolar: activePotentialGeneration.solar?.length,
                    activePotentialGenerationWind: activePotentialGeneration.wind?.length,
                    currentDemandLength: currentDemand.length,
                    firstFewDemandValues: fullDemand.slice(0, 5),
                    lastFewDemandValues: fullDemand.slice(-5)
                });

                const inputsForSim = {
                    capacity: {
                        solar: currentValues.solar,
                        wind: currentValues.wind,
                        offshoreWind: currentValues.offshoreWind,
                        geothermal: currentValues.geothermal,
                        nuclear: currentValues.nuclear,
                        biomass: currentValues.biomass,
                        rng: currentValues.rng,
                        hydrogen: currentValues.hydrogen,
                        battery4hr: currentValues.battery4hr,
                        battery8hr: currentValues.battery8hr,
                        longduration: currentValues.longduration,
                        dac: currentValues.dac,
                        hydro: 0,
                        naturalGas: 0,
                        coal: 0,
                        demandflex: currentValues.demandflex
                    },
                    incentives: {
                        solar: currentValues.solarIncentive,
                        wind: currentValues.windIncentive,
                        offshoreWind: currentValues.offshoreWindIncentive,
                        geothermal: currentValues.geothermalIncentive,
                        nuclear: currentValues.nuclearIncentive,
                        biomass: currentValues.biomassIncentive,
                        rng: currentValues.rngIncentive,
                        hydrogen: currentValues.hydrogenIncentive,
                        storage: currentValues.storageIncentive,
                        dac: currentValues.dacIncentive,
                        carbonTax: currentValues.carbonTax,
                        exportPrice: currentValues.exportPrice
                    }
                };

                const result = getSimulationResult(inputsForSim, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, activePotentialGeneration, currentBaselineStorage, currentHydroCF, selectedCountry);
                const resultWithoutStorage = getSimulationResult(inputsForSim, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, activePotentialGeneration, currentBaselineStorage, currentHydroCF, selectedCountry, true);

                const totalAnnualSystemCost = result.systemCost;
                const annualConsumerCost = calculateAnnualConsumerCost(result.hourlyMarginalPrice, result.demand);

                const totalAnnualSystemCostBaseline = customBaselineSystemCost;
                const systemCostPercentageChange = totalAnnualSystemCostBaseline > 0 ? ((totalAnnualSystemCost - totalAnnualSystemCostBaseline) / totalAnnualSystemCostBaseline) * 100 : 0;

                const billPercentageChange = customBaselineConsumerCost > 0 ? ((annualConsumerCost - customBaselineConsumerCost) / customBaselineConsumerCost) * 100 : 0;

                // Calculate total annual CO2 by multiplying each hour by days in that month
                let totalAnnualCO2 = 0;
                const hoursPerMonth = 24;
                for (let i = 0; i < result.emissions.length; i++) {
                    const monthIndex = Math.floor(i / hoursPerMonth) % 12;
                    totalAnnualCO2 += result.emissions[i] * DAYS_IN_MONTH[monthIndex];
                }

                // Calculate CO2 avoided and abatement cost
                const co2Avoided = customBaselineTotalAnnualCO2 - totalAnnualCO2;
                const abatementCost = co2Avoided > 0 ? (totalAnnualSystemCost - totalAnnualSystemCostBaseline) / (co2Avoided / 1000) : 0;

                updateCharts(result.generation, result.emissions, result.demand, totalAnnualCO2, fullSolarProfile, fullWindProfile, fullOffshoreWindProfile, result.hourlyMarginalPrice, resultWithoutStorage.hourlyMarginalPrice);

                updateGridMixSlider(currentCountryInstalledCapacity, defaultCapacityMix);
                updateGenerationMixSlider(result.generation, defaultGenerationMix, result.curtailmentBySource);

                billImpactEl.textContent = `${billPercentageChange > 0 ? '+' : ''}${billPercentageChange.toFixed(0)}%`;
                systemCostImpactEl.textContent = `${systemCostPercentageChange > 0 ? '+' : ''}${systemCostPercentageChange.toFixed(0)}%`;

                [billImpactEl, systemCostImpactEl].forEach((el, index) => {
                    const change = index === 0 ? billPercentageChange : systemCostPercentageChange;
                    if (change > 0) {
                        el.className = 'text-5xl font-bold text-red-600 mt-2';
                    } else if (change < 0) {
                        el.className = 'text-5xl font-bold text-green-600 mt-2';
                    } else {
                        el.className = 'text-5xl font-bold text-blue-600 mt-2';
                    }
                });

                // Display CO2 Avoided
                const co2AvoidedPercent = customBaselineTotalAnnualCO2 > 0 ? (co2Avoided / customBaselineTotalAnnualCO2) * 100 : 0;

                if (Math.abs(co2Avoided) < 1) { // 1 ton tolerance
                    co2AvoidedEl.textContent = `CO2 avoided: 0 tons (0%)`;
                    co2AvoidedEl.className = 'text-md font-medium text-gray-700';
                } else {
                    let text = `CO2 avoided: ${(co2Avoided / 1000000).toFixed(1)}M tons (${co2AvoidedPercent.toFixed(0)}%)`;
                    if (co2Avoided > 0) {
                        text += ` at $${abatementCost.toFixed(0)}/ton`;
                    }
                    co2AvoidedEl.textContent = text;
                    co2AvoidedEl.className = co2Avoided > 0 ? 'text-md font-medium text-green-600' : 'text-md font-medium text-red-600';
                }
            }

            function calculateEmissions(generation, dacRate) {
                const co2 = [];
                const numHours = generation.naturalGas.length;
                for (let i = 0; i < numHours; i++) {
                    let hourlyEmission = 0;
                    if (EMISSION_FACTORS) {
                        hourlyEmission += (generation.naturalGas[i] || 0) * EMISSION_FACTORS.naturalGas;
                        hourlyEmission += (generation.coal[i] || 0) * EMISSION_FACTORS.coal;
                        hourlyEmission += (generation.biomass[i] || 0) * EMISSION_FACTORS.biomass;
                    } else {
                        // Fallback
                        hourlyEmission += (generation.naturalGas[i] || 0) * 1000 * 0.45;
                        hourlyEmission += (generation.coal[i] || 0) * 1000 * 1.0;
                    }
                    hourlyEmission -= dacRate;
                    co2.push(Math.max(0, hourlyEmission));
                }
                return co2;
            }

            function updateCharts(generation, emissions, demand, totalAnnualCO2, solarProfile, windProfile, offshoreWindProfile, hourlyMarginalPrice, priceWithoutStorage) {
                const chartData = generationChart.data.datasets;

                const techMap = {
                    nuclear: 0, geothermal: 1, biomass: 2, rng: 3, hydrogen: 4, hydro: 5,
                    wind: 6, offshoreWind: 7, solar: 8,
                    naturalGas: 9, coal: 10, storage: 11,
                    solarToStorage: 12, windToStorage: 13, offshoreWindToStorage: 14, curtailment: 15
                };

                for (const tech in techMap) {
                    if (generation[tech]) {
                        chartData[techMap[tech]].data = generation[tech];
                    }
                }
                chartData[16].data = demand;

                generationChart.update('none');

                // Update marginal price chart
                marginalPriceChart.data.datasets[0].data = hourlyMarginalPrice;
                marginalPriceChart.data.datasets[1].data = priceWithoutStorage;
                marginalPriceChart.update('none');

                // Update CO2 chart (Monthly Bar Chart)
                const monthlyEmissions = Array(12).fill(0);
                // emissions is length 288 (hourly rates t/hr)
                for (let i = 0; i < emissions.length; i++) {
                    const monthIndex = Math.floor(i / 24) % 12;
                    monthlyEmissions[monthIndex] += emissions[i] * DAYS_IN_MONTH[monthIndex];
                }

                co2Chart.data.datasets[0].data = monthlyEmissions;
                if (co2Chart.options.plugins.annotation && co2Chart.options.plugins.annotation.annotations.totalCO2) {
                    co2Chart.options.plugins.annotation.annotations.totalCO2.content = `Total Annual CO2: ${(totalAnnualCO2 / 1000000).toFixed(2)} Million Tons`;
                }
                co2Chart.update('none');

                capacityFactorChart.data.datasets[0].data = solarProfile;
                capacityFactorChart.data.datasets[1].data = windProfile;
                capacityFactorChart.data.datasets[2].data = offshoreWindProfile;
                capacityFactorChart.update('none');
            }

            function updateGridMixSlider(installedCapacity, defaultMix) {
                const capacities = {};
                let totalCapacity = 0;

                for (const tech in COST_DATA.capacity_factor) {
                    const baselineCapacity = installedCapacity[tech] || 0;
                    let newCapacity = 0;
                    if (sliders[tech]) {
                        newCapacity = parseFloat(sliders[tech].value);
                    }
                    capacities[tech] = baselineCapacity + newCapacity;
                    totalCapacity += capacities[tech];
                }

                if (totalCapacity > 0) {
                    for (const tech in capacities) {
                        if (COST_DATA.capacity_factor[tech]) { // Only for generators
                            const percentage = (capacities[tech] / totalCapacity) * 100;
                            const fillEl = document.getElementById(`mix-fill-${tech}`);
                            const valueEl = document.getElementById(`mix-value-${tech}`);
                            const outlineEl = document.getElementById(`mix-default-outline-${tech}`);

                            if (fillEl && valueEl) {
                                fillEl.style.width = `${percentage}%`;
                                valueEl.textContent = `${percentage.toFixed(1)}%`;
                            }
                            if (outlineEl && defaultMix[tech] !== undefined) {
                                outlineEl.style.width = `${defaultMix[tech]}%`;
                            }
                        }
                    }
                }

                // Update storage display
                ['battery4hr', 'battery8hr', 'longduration'].forEach(type => {
                    const baselineGWh = currentBaselineStorage[type] || 0;
                    const newGWh = parseFloat(sliders[type].value);
                    const totalGWh = baselineGWh + newGWh;
                    const duration = type === 'longduration' ? 24 : parseInt(type.match(/\d+/)[0]);
                    const totalGW = totalGWh / duration;
                    const displayEl = document.getElementById(`storage-capacity-${type}`);
                    if (displayEl) {
                        displayEl.textContent = `${totalGW.toFixed(2)} GW / ${totalGWh.toFixed(2)} GWh`;
                    }
                });
            }

            function createGridMixSliders() {
                const techOrder = ['coal', 'naturalGas', 'solar', 'hydro', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                techOrder.forEach(tech => {
                    let name = tech.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    if (tech === 'wind') name = 'Onshore Wind';
                    if (tech === 'offshoreWind') name = 'Offshore Wind';
                    if (tech === 'rng') name = 'RNG (Biogas)';
                    if (tech === 'hydrogen') name = 'Hydrogen';

                    const color = COLORS[tech] || '#ccc';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-6 gap-2 items-center mix-slider-row';
                    wrapper.dataset.tech = tech;

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = "flex items-center justify-center";
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${tech}`;
                    checkbox.checked = true;
                    checkbox.className = "form-checkbox h-5 w-5 text-blue-600 rounded";
                    checkbox.addEventListener('change', () => {
                        enabledTechnologies[tech] = checkbox.checked;
                        runSimulation();
                        saveState();
                    });
                    checkboxContainer.appendChild(checkbox);
                    wrapper.appendChild(checkboxContainer);

                    const label = document.createElement('label');
                    label.textContent = name;
                    label.className = 'col-span-1 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'col-span-3';
                    const track = document.createElement('div');
                    track.className = 'mix-slider-track';
                    const fill = document.createElement('div');
                    fill.id = `mix-fill-${tech}`;
                    fill.className = 'mix-slider-fill';
                    fill.style.backgroundColor = color;
                    const outline = document.createElement('div');
                    outline.id = `mix-default-outline-${tech}`;
                    outline.className = 'mix-slider-default-outline';
                    track.appendChild(fill);
                    track.appendChild(outline);
                    sliderContainer.appendChild(track);
                    wrapper.appendChild(sliderContainer);

                    const value = document.createElement('span');
                    value.id = `mix-value-${tech}`;
                    value.className = 'col-span-1 text-sm font-semibold text-right';
                    value.textContent = '0.0%';
                    wrapper.appendChild(value);

                    gridMixSlidersContainer.appendChild(wrapper);
                });

                // Create storage section
                const storageHeader = document.createElement('h3');
                storageHeader.className = 'text-lg font-lora font-semibold mt-6 mb-2 text-gray-800';
                storageHeader.textContent = 'Installed Storage Capacity';
                storageCapacityDisplayContainer.appendChild(storageHeader);

                const storageTypes = [
                    { id: 'battery4hr', name: '4-hr Battery' },
                    { id: 'battery8hr', name: '8-hr Battery' },
                    { id: 'longduration', name: '24-hr Storage' }
                ];

                storageTypes.forEach(type => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-6 gap-2 items-center';

                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = "flex items-center justify-center";
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${type.id}`;
                    checkbox.checked = true;
                    checkbox.className = "form-checkbox h-5 w-5 text-blue-600 rounded";
                    checkbox.addEventListener('change', () => {
                        enabledTechnologies[type.id] = checkbox.checked;
                        runSimulation();
                        saveState();
                    });
                    checkboxContainer.appendChild(checkbox);
                    wrapper.appendChild(checkboxContainer);

                    const label = document.createElement('label');
                    label.textContent = type.name;
                    label.className = 'col-span-2 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const value = document.createElement('span');
                    value.id = `storage-capacity-${type.id}`;
                    value.className = 'col-span-3 text-sm font-semibold text-right';
                    value.textContent = '0.00 GW / 0.00 GWh';
                    wrapper.appendChild(value);

                    storageCapacityDisplayContainer.appendChild(wrapper);
                });
            }

            // --- GENERATION MIX SLIDER ---
            function updateGenerationMixSlider(generation, defaultMix, curtailmentBySource) {
                yearlyGenerationTotalsGWh = {}; // Clear previous totals
                let totalGeneration = 0;

                const gridTechs = ['coal', 'naturalGas', 'hydro', 'geothermal', 'biomass', 'rng', 'hydrogen', 'nuclear', 'solar', 'wind', 'offshoreWind', 'storage'];
                gridTechs.forEach(tech => {
                    // Calculate yearly total by multiplying each hour by days in that month
                    let techTotal = 0;
                    (generation[tech] || []).forEach((value, i) => {
                        const monthIndex = Math.floor(i / 24) % 12;
                        techTotal += value * DAYS_IN_MONTH[monthIndex];
                    });
                    yearlyGenerationTotalsGWh[tech] = techTotal;
                    totalGeneration += techTotal;
                });

                if (totalGeneration > 0) {
                    gridTechs.forEach(tech => {
                        const percentage = (yearlyGenerationTotalsGWh[tech] / totalGeneration) * 100;
                        const fillEl = document.getElementById(`gen-mix-fill-${tech}`);
                        const valueEl = document.getElementById(`gen-mix-value-${tech}`);
                        const outlineEl = document.getElementById(`gen-mix-default-outline-${tech}`);

                        if (fillEl && valueEl) {
                            fillEl.style.width = `${percentage}%`;
                            valueEl.textContent = `${percentage.toFixed(1)}%`;
                        }
                        if (outlineEl && defaultMix[tech] !== undefined) {
                            outlineEl.style.width = `${defaultMix[tech]}%`;
                        }
                    });
                } else {
                    gridTechs.forEach(tech => {
                        const fillEl = document.getElementById(`gen-mix-fill-${tech}`);
                        const valueEl = document.getElementById(`gen-mix-value-${tech}`);
                        if (fillEl && valueEl) {
                            fillEl.style.width = '0%';
                            valueEl.textContent = '0.0%';
                        }
                    });
                }

                const curtailmentTrack = document.getElementById('gen-mix-track-curtailment');
                const curtailmentValue = document.getElementById('gen-mix-value-curtailment');
                curtailmentTrack.innerHTML = '';

                // Calculate yearly curtailment by multiplying each hour by days in that month
                let totalCurtailed = 0;
                (generation.curtailment || []).forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    totalCurtailed += value * DAYS_IN_MONTH[monthIndex];
                });
                yearlyGenerationTotalsGWh['curtailment'] = totalCurtailed;

                // Calculate yearly storage charging
                let solarToStorageTotal = 0, windToStorageTotal = 0, offshoreWindToStorageTotal = 0;
                (generation.solarToStorage || []).forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    solarToStorageTotal += value * DAYS_IN_MONTH[monthIndex];
                });
                (generation.windToStorage || []).forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    windToStorageTotal += value * DAYS_IN_MONTH[monthIndex];
                });
                (generation.offshoreWindToStorage || []).forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    offshoreWindToStorageTotal += value * DAYS_IN_MONTH[monthIndex];
                });

                let totalPotentialGeneration = totalGeneration + totalCurtailed + solarToStorageTotal + windToStorageTotal + offshoreWindToStorageTotal;

                if (totalPotentialGeneration > 0) {
                    const overallCurtailmentPercent = (totalCurtailed / totalPotentialGeneration) * 100;
                    curtailmentValue.textContent = `${overallCurtailmentPercent.toFixed(1)}%`;

                    if (totalCurtailed > 0) {
                        // Calculate yearly curtailment by source
                        let solarCurtail = 0, windCurtail = 0, offshoreWindCurtail = 0;
                        (curtailmentBySource.solar || []).forEach((value, i) => {
                            const monthIndex = Math.floor(i / 24) % 12;
                            solarCurtail += value * DAYS_IN_MONTH[monthIndex];
                        });
                        (curtailmentBySource.wind || []).forEach((value, i) => {
                            const monthIndex = Math.floor(i / 24) % 12;
                            windCurtail += value * DAYS_IN_MONTH[monthIndex];
                        });
                        (curtailmentBySource.offshoreWind || []).forEach((value, i) => {
                            const monthIndex = Math.floor(i / 24) % 12;
                            offshoreWindCurtail += value * DAYS_IN_MONTH[monthIndex];
                        });

                        const techWithCurtailment = [{ tech: 'solar', val: solarCurtail }, { tech: 'wind', val: windCurtail }, { tech: 'offshoreWind', val: offshoreWindCurtail }];

                        techWithCurtailment.forEach(item => {
                            if (item.val > 0) {
                                const contributionPercent = (item.val / totalCurtailed);
                                const segmentWidth = 100 * contributionPercent;

                                const segment = document.createElement('div');
                                segment.className = 'h-full';
                                segment.style.backgroundColor = COLORS[item.tech];
                                segment.style.width = `${segmentWidth}%`;
                                segment.style.float = 'left';
                                curtailmentTrack.appendChild(segment);
                            }
                        });
                        curtailmentTrack.parentElement.style.width = `${overallCurtailmentPercent}%`;
                    } else {
                        curtailmentTrack.parentElement.style.width = `0%`;
                    }
                } else {
                    curtailmentValue.textContent = '0.0%';
                    curtailmentTrack.parentElement.style.width = `0%`;
                }
            }

            function createGenerationMixSliders() {
                const techOrder = ['coal', 'naturalGas', 'solar', 'hydro', 'wind', 'offshoreWind', 'nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen', 'storage'];
                techOrder.forEach(tech => {
                    let name = tech.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    if (tech === 'wind') name = 'Onshore Wind';
                    if (tech === 'offshoreWind') name = 'Offshore Wind';
                    if (tech === 'rng') name = 'RNG (Biogas)';
                    if (tech === 'hydrogen') name = 'Hydrogen';
                    const color = COLORS[tech] || '#ccc';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'grid grid-cols-5 gap-2 items-center mix-slider-row';
                    wrapper.dataset.tech = tech;

                    const label = document.createElement('label');
                    label.textContent = name;
                    label.className = 'col-span-1 text-sm font-medium text-gray-700';
                    wrapper.appendChild(label);

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'col-span-3';
                    const track = document.createElement('div');
                    track.className = 'mix-slider-track';
                    const fill = document.createElement('div');
                    fill.id = `gen-mix-fill-${tech}`;
                    fill.className = 'mix-slider-fill';
                    fill.style.backgroundColor = color;
                    const outline = document.createElement('div');
                    outline.id = `gen-mix-default-outline-${tech}`;
                    outline.className = 'mix-slider-default-outline';
                    track.appendChild(fill);
                    track.appendChild(outline);
                    sliderContainer.appendChild(track);
                    wrapper.appendChild(sliderContainer);

                    const value = document.createElement('span');
                    value.id = `gen-mix-value-${tech}`;
                    value.className = 'col-span-1 text-sm font-semibold text-right';
                    value.textContent = '0.0%';
                    wrapper.appendChild(value);

                    generationMixSlidersContainer.appendChild(wrapper);
                });

                const wrapper = document.createElement('div');
                wrapper.className = 'grid grid-cols-5 gap-2 items-center mix-slider-row';
                wrapper.dataset.tech = 'curtailment';
                const label = document.createElement('label');
                label.textContent = 'Curtailment';
                label.className = 'col-span-1 text-sm font-medium text-gray-700';
                wrapper.appendChild(label);
                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'col-span-3';
                const outerTrack = document.createElement('div');
                outerTrack.className = 'mix-slider-track';
                const innerTrack = document.createElement('div');
                innerTrack.id = 'gen-mix-track-curtailment';
                innerTrack.className = 'h-full w-full';
                outerTrack.appendChild(innerTrack);
                sliderContainer.appendChild(outerTrack);
                wrapper.appendChild(sliderContainer);
                const value = document.createElement('span');
                value.id = `gen-mix-value-curtailment`;
                value.className = 'col-span-1 text-sm font-semibold text-right';
                value.textContent = '0.0%';
                wrapper.appendChild(value);
                generationMixSlidersContainer.appendChild(wrapper);
            }

            // --- HELPER: Calculate minimum demand based on inflexible baseload ---
            function calculateMinimumDemand() {
                const INFLEXIBLE_SOURCES = ['nuclear', 'geothermal', 'biomass', 'rng', 'hydrogen'];
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                let minDemand = 0;
                INFLEXIBLE_SOURCES.forEach(tech => {
                    const baselineCapacity = currentCountryInstalledCapacity[tech] || 0;
                    const newCapacity = currentValues[tech] || 0;
                    const totalCapacity = baselineCapacity + newCapacity;
                    const cf = COST_DATA.capacity_factor[tech] || 0;
                    minDemand += totalCapacity * cf;
                });
                return minDemand;
            }

            // --- DEMAND EDIT MODE ---
            function setDemandEditMode(enabled) {
                isDemandEditMode = enabled;
                const demandDatasetIndex = generationChart.data.datasets.findIndex(ds => ds.label === 'Demand');

                if (enabled) {
                    if (editDemandBtn) editDemandBtn.classList.add('hidden');
                    if (confirmDemandBtn) confirmDemandBtn.classList.remove('hidden');
                    if (revertDemandBtn) revertDemandBtn.classList.remove('hidden');
                    if (demandPresetsDiv) demandPresetsDiv.classList.remove('hidden');

                    document.querySelectorAll('#demand-presets button').forEach(btn => {
                        btn.classList.remove('preset-active');
                        if (btn.id === `preset-demand-${currentDemandProfileName.toLowerCase().replace(' ', '-')}`) {
                            btn.classList.add('preset-active');
                        }
                    });

                    generationChart.data.datasets.forEach((dataset, index) => {
                        if (index !== demandDatasetIndex) {
                            dataset.hidden = true;
                        } else {
                            dataset.borderWidth = 4;
                            dataset.pointRadius = 6;
                            dataset.pointHoverRadius = 8;
                            dataset.pointBackgroundColor = 'rgba(17, 24, 39, 1)';
                            dataset.pointBorderColor = 'white';
                            dataset.pointBorderWidth = 2;
                        }
                    });

                    generationChart.options.plugins.dragData = {
                        round: 1,
                        showTooltip: true,
                        onDrag: function (e, datasetIndex, index, value) {
                            // Enforce constraints DURING dragging for real-time feedback
                            const minDemand = calculateMinimumDemand();

                            if (value < minDemand) {
                                return minDemand;
                            }
                            if (value < 0) {
                                return 0;
                            }
                            return value;
                        },
                        onDragEnd: function (e, datasetIndex, index, value) {
                            const chart = e.chart;
                            let updatedValue = value;

                            // Calculate minimum demand based on inflexible baseload
                            const minDemand = calculateMinimumDemand();

                            // Enforce minimum demand constraint
                            if (updatedValue < minDemand) {
                                updatedValue = minDemand;
                            }

                            // Enforce non-negative constraint
                            if (updatedValue < 0) {
                                updatedValue = 0;
                            }

                            chart.data.datasets[datasetIndex].data[index] = updatedValue;
                            generationChart.update('none');
                        }
                    };
                    generationChart.options.plugins.dragData.enabled = true;
                    generationChart.options.scales.y.stacked = false;
                    generationChart.update();

                } else {
                    if (editDemandBtn) editDemandBtn.classList.remove('hidden');
                    if (confirmDemandBtn) confirmDemandBtn.classList.add('hidden');
                    if (revertDemandBtn) revertDemandBtn.classList.add('hidden');
                    if (demandPresetsDiv) demandPresetsDiv.classList.add('hidden');

                    generationChart.data.datasets.forEach((dataset, index) => {
                        dataset.hidden = false;
                        if (index === demandDatasetIndex) {
                            dataset.borderWidth = 3;
                            dataset.pointRadius = 0;
                            dataset.pointHoverRadius = 0;
                        }
                    });

                    if (generationChart.options.plugins.dragData) {
                        generationChart.options.plugins.dragData.enabled = false;
                        generationChart.options.plugins.dragData.onDragEnd = null;
                    }
                    generationChart.options.scales.y.stacked = true;
                    generationChart.update();
                }
            }

            // --- CF EDIT MODE ---
            function setCFEditMode(enabled) {
                isCFEditMode = enabled;

                if (enabled) {
                    if (editCFBtn) editCFBtn.classList.add('hidden');
                    if (confirmCFBtn) confirmCFBtn.classList.remove('hidden');
                    if (revertCFBtn) revertCFBtn.classList.remove('hidden');
                    capacityFactorChart.data.datasets.forEach(dataset => {
                        dataset.pointRadius = 6;
                        dataset.pointHoverRadius = 8;
                        dataset.pointBorderColor = 'white';
                        dataset.pointBorderWidth = 2;
                        dataset.dragData = true;
                    });

                } else {
                    if (editCFBtn) editCFBtn.classList.remove('hidden');
                    if (confirmCFBtn) confirmCFBtn.classList.add('hidden');
                    if (revertCFBtn) revertCFBtn.classList.add('hidden');

                    capacityFactorChart.data.datasets.forEach(dataset => {
                        dataset.pointRadius = 0;
                        dataset.dragData = false;
                    });
                }
                capacityFactorChart.update();
            }

            // --- NEW: Function to set the baseline from the current state ---
            // Returns the simulation result to avoid running the simulation twice
            function setNewBaselineFromCurrentState() {
                const currentValues = {};
                for (const key in sliders) {
                    currentValues[key] = parseFloat(sliders[key].value);
                }

                let activePotentialGeneration = JSON.parse(JSON.stringify(BASELINE_POTENTIAL_GENERATION));
                for (const tech in enabledTechnologies) {
                    if (!enabledTechnologies[tech]) {
                        activePotentialGeneration[tech] = Array(24).fill(0);
                    }
                }

                const newBaselineResult = getSimulationResult(
                    {
                        capacity: {
                            solar: currentValues.solar, wind: currentValues.wind, offshoreWind: currentValues.offshoreWind,
                            geothermal: currentValues.geothermal, nuclear: currentValues.nuclear,
                            biomass: currentValues.biomass, rng: currentValues.rng, hydrogen: currentValues.hydrogen,
                            battery4hr: currentValues.battery4hr, battery8hr: currentValues.battery8hr,
                            longduration: currentValues.longduration, dac: currentValues.dac,
                            demandflex: currentValues.demandflex,
                        },
                        incentives: {
                            solar: currentValues.solarIncentive, wind: currentValues.windIncentive, offshoreWind: currentValues.offshoreWindIncentive,
                            geothermal: currentValues.geothermalIncentive, nuclear: currentValues.nuclearIncentive,
                            biomass: currentValues.biomassIncentive, rng: currentValues.rngIncentive, hydrogen: currentValues.hydrogenIncentive,
                            storage: currentValues.storageIncentive, dac: currentValues.dacIncentive,
                            carbonTax: currentValues.carbonTax,
                            exportPrice: currentValues.exportPrice,
                        }
                    },
                    currentSolarCFProfile,
                    currentWindCFProfile,
                    currentOffshoreWindCFProfile,
                    activePotentialGeneration,
                    currentBaselineStorage,
                    currentHydroCF,
                    countrySelect.value
                );

                customBaselineSystemCost = newBaselineResult.systemCost;
                customBaselineConsumerCost = calculateAnnualConsumerCost(newBaselineResult.hourlyMarginalPrice, newBaselineResult.demand);
                // Calculate yearly CO2 by multiplying each hour by days in that month
                let co2Total = 0;
                newBaselineResult.emissions.forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    co2Total += value * DAYS_IN_MONTH[monthIndex];
                });
                customBaselineTotalAnnualCO2 = co2Total;

                // Return the simulation result so we can display it without re-running
                return newBaselineResult;
            }

            // --- EVENT LISTENERS ---
            function updateUndoRedoButtons() {
                undoButton.disabled = historyIndex <= 0;
                redoButton.disabled = historyIndex >= stateHistory.length - 1;
            }

            function saveState() {
                const currentState = {};
                for (const key in sliders) {
                    currentState[key] = sliders[key].value;
                }
                currentState.enabledTech = { ...enabledTechnologies };
                currentState.demandProfile = [...currentDemand];
                currentState.solarCFProfile = [...currentSolarCFProfile];
                currentState.windCFProfile = [...currentWindCFProfile];
                currentState.offshoreWindCFProfile = [...currentOffshoreWindCFProfile];
                currentState.demandProfileName = currentDemandProfileName;
                currentState.cfProfileName = currentCFProfileName;
                currentState.hydroCF = currentHydroCF;

                stateHistory = stateHistory.slice(0, historyIndex + 1);
                stateHistory.push(currentState);
                historyIndex++;
                updateUndoRedoButtons();
            }

            function syncInputs(sourceElement, targetElement) {
                targetElement.value = sourceElement.value;
            }

            function setupInputSyncing() {
                for (const key in sliders) {
                    const slider = sliders[key];
                    const input = inputs[key];

                    // All sliders behave the same way - just run simulation
                    // Baseline only updates when "Make Default" is clicked
                    slider.addEventListener('input', () => {
                        syncInputs(slider, input);
                        runSimulation();
                    });

                    input.addEventListener('input', () => {
                        let value = parseFloat(input.value);
                        const min = parseFloat(slider.min);
                        const max = parseFloat(slider.max);
                        if (isNaN(value)) value = min;
                        if (value > max) value = max;
                        if (value < min) value = min;
                        input.value = value;
                        syncInputs(input, slider);
                        runSimulation();
                    });

                    slider.addEventListener('change', saveState);
                    input.addEventListener('change', saveState);
                }
            }


            function applySeason(profileName) {
                currentSystemDefaultProfileName = profileName;
                const nameParts = profileName.split('-');
                const baseSeason = nameParts[0];
                const profileDisplayName = nameParts.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');

                currentDemandProfileName = profileDisplayName;
                if (currentDemandProfileText) currentDemandProfileText.textContent = currentDemandProfileName;

                const cfProfileDisplayName = baseSeason.charAt(0).toUpperCase() + baseSeason.slice(1);
                const seasonalMultipliers = SEASONAL_MULTIPLIERS[baseSeason];
                const baseSolarProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).solar;
                const baseWindProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).wind;
                const baseOffshoreWindProfile = (countryProfiles[countrySelect.value] || countryProfiles.default).offshoreWind;
                currentSolarCFProfile = baseSolarProfile.map(cf => Math.min(1, cf * seasonalMultipliers.solar));
                currentWindCFProfile = baseWindProfile.map(cf => Math.min(1, cf * seasonalMultipliers.wind));
                currentOffshoreWindCFProfile = baseOffshoreWindProfile.map(cf => Math.min(1, cf * seasonalMultipliers.offshoreWind));
                currentHydroCF = SEASONAL_HYDRO_CF[baseSeason];
                currentCFProfileName = cfProfileDisplayName;

                updateBaselineForCountry(countrySelect.value, profileName);

                setDemandEditMode(false);
                setCFEditMode(false);
                saveState();
            }



            if (editDemandBtn) {
                editDemandBtn.addEventListener('click', () => {
                    originalDemandBeforeEdit = [...currentDemand];
                    setDemandEditMode(true);
                });
            }

            if (revertDemandBtn) {
                revertDemandBtn.addEventListener('click', () => {
                    generationChart.data.datasets.find(ds => ds.label === 'Demand').data = [...originalDemandBeforeEdit];
                    generationChart.update('none');
                });
            }

            if (confirmDemandBtn) {
                confirmDemandBtn.addEventListener('click', () => {
                    currentDemand = [...generationChart.data.datasets.find(ds => ds.label === 'Demand').data];
                    currentDemandProfileName = "User Defined";
                    currentDemandProfileText.textContent = currentDemandProfileName;
                    setDemandEditMode(false);
                    runSimulation();
                    saveState();
                });
            }

            const demandProfiles = [
                'spring-typical', 'spring-high', 'summer-typical', 'summer-high',
                'fall-typical', 'fall-high', 'winter-typical', 'winter-high'
            ];
            demandProfiles.forEach(profile => {
                const btn = document.getElementById(`preset-demand-${profile}`);
                if (btn) btn.addEventListener('click', () => applySeason(profile));
            });

            ['spring', 'summer', 'fall', 'winter'].forEach(season => {
                const btn = document.getElementById(`preset-cf-${season}`);
                if (btn) btn.addEventListener('click', () => {
                    applySeason(`${season}-typical`);
                });
            });

            if (editCFBtn) {
                editCFBtn.addEventListener('click', () => {
                    originalSolarCFBeforeEdit = [...capacityFactorChart.data.datasets[0].data];
                    originalWindCFBeforeEdit = [...capacityFactorChart.data.datasets[1].data];
                    originalOffshoreWindCFBeforeEdit = [...capacityFactorChart.data.datasets[2].data];
                    setCFEditMode(true);
                });
            }

            if (revertCFBtn) {
                revertCFBtn.addEventListener('click', () => {
                    capacityFactorChart.data.datasets[0].data = [...originalSolarCFBeforeEdit];
                    capacityFactorChart.data.datasets[1].data = [...originalWindCFBeforeEdit];
                    capacityFactorChart.data.datasets[2].data = [...originalOffshoreWindCFBeforeEdit];
                    capacityFactorChart.update('none');
                });
            }

            if (confirmCFBtn) {
                confirmCFBtn.addEventListener('click', () => {
                    currentSolarCFProfile = [...capacityFactorChart.data.datasets[0].data];
                    currentWindCFProfile = [...capacityFactorChart.data.datasets[1].data];
                    currentOffshoreWindCFProfile = [...capacityFactorChart.data.datasets[2].data];
                    currentCFProfileName = "User Defined";

                    setCFEditMode(false);
                    runSimulation();
                    saveState();
                });
            }



            resetToZeroButton.addEventListener('click', () => {
                Object.keys(sliders).forEach(key => {
                    if (key === 'exportPrice') {
                        sliders[key].value = 20;
                        inputs[key].value = 20;
                    } else {
                        sliders[key].value = 0;
                        inputs[key].value = 0;
                    }
                });
                runSimulation();
                saveState();
            });

            makeDefaultButton.addEventListener('click', () => {
                userDefaultState = {};
                for (const key in sliders) {
                    userDefaultState[key] = sliders[key].value;
                }
                userDefaultState.enabledTech = { ...enabledTechnologies };
                userDefaultState.demandProfile = [...currentDemand];
                userDefaultState.solarCFProfile = [...currentSolarCFProfile];
                userDefaultState.windCFProfile = [...currentWindCFProfile];
                userDefaultState.offshoreWindCFProfile = [...currentOffshoreWindCFProfile];
                userDefaultState.demandProfileName = currentDemandProfileName;
                userDefaultState.cfProfileName = currentCFProfileName;
                userDefaultState.hydroCF = currentHydroCF;

                // Set the new baseline (runs simulation once)
                setNewBaselineFromCurrentState();

                userDefaultState.baselineCost = customBaselineSystemCost;
                userDefaultState.baselineCO2 = customBaselineTotalAnnualCO2;

                // Run normal simulation to update display
                // This may show 1-2% difference due to iterative optimization, which is acceptable
                runSimulation();

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl text-center">
                        <p class="text-lg font-semibold text-gray-800">Current settings saved as user default.</p>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.remove(), 2500);
            });

            resetToDefaultButton.addEventListener('click', () => {
                const isUserDefaultAvailable = Object.keys(userDefaultState).length > 0;

                if (isUserDefaultAvailable) {
                    restoreState(userDefaultState);
                    saveState();
                } else {
                    applySeason(currentSystemDefaultProfileName);
                }
            });

            function restoreState(state) {
                currentDemand = [...state.demandProfile];
                currentSolarCFProfile = [...state.solarCFProfile];
                currentWindCFProfile = [...state.windCFProfile];
                currentOffshoreWindCFProfile = [...state.offshoreWindCFProfile];
                currentDemandProfileName = state.demandProfileName;
                currentCFProfileName = state.cfProfileName;
                currentHydroCF = state.hydroCF;
                currentDemandProfileText.textContent = currentDemandProfileName;

                for (const key in state) {
                    if (sliders[key] && inputs[key]) {
                        sliders[key].value = state[key];
                        inputs[key].value = state[key];
                    }
                }
                if (state.enabledTech) {
                    for (const tech in state.enabledTech) {
                        const checkbox = document.getElementById(`toggle-${tech}`);
                        if (checkbox) {
                            checkbox.checked = state.enabledTech[tech];
                            enabledTechnologies[tech] = state.enabledTech[tech];
                        }
                    }
                }
                runSimulation();
                updateUndoRedoButtons();
            }

            undoButton.addEventListener('click', () => {
                if (historyIndex > 0) {
                    historyIndex--;
                    restoreState(stateHistory[historyIndex]);
                }
            });

            redoButton.addEventListener('click', () => {
                if (historyIndex < stateHistory.length - 1) {
                    historyIndex++;
                    restoreState(stateHistory[historyIndex]);
                }
            });

            // --- INITIALIZATION & DYNAMIC CONTENT ---

            function populateCountryDropdown() {
                countrySelect.innerHTML = '';
                const caOption = document.createElement('option');
                caOption.value = "California";
                caOption.textContent = "California";
                countrySelect.appendChild(caOption);

                for (const country in countryGridMixData) {
                    if (country !== "California") {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    }
                }
                countrySelect.value = "California";
            }

            function updateBaselineForCountry(countryName, profileName) {
                let newCarbonTax = 0;
                let countryData = countryGridMixData[countryName];

                if (!countryData) {
                    console.error(`No data for country: ${countryName}`);
                    return;
                }

                newCarbonTax = carbonTaxes[countryName] || 0;

                const nameParts = profileName.split('-');
                const baseSeason = nameParts[0];
                const profileType = nameParts[1];

                if (currentDemandProfileName !== 'User Defined') {
                    // For California, use JSON profiles directly (same calculation as Grid Dispatch Test)
                    if (countryName === 'California' && CALIFORNIA_PROFILES[profileName]) {
                        const profile = CALIFORNIA_PROFILES[profileName];
                        const peakMW = profile.peakMW;
                        const hourlyPercentages = profile.hourlyPercentages;

                        // Match tester's calculation: (pct / 100) * peakMW, then convert to GW
                        currentDemand = hourlyPercentages.map(pct => (pct / 100) * (peakMW / 1000));
                    } else {
                        // For other countries, use scaling approach
                        const TYPICAL_DAY_SCALING_FACTORS = {
                            spring: 0.79, summer: 0.82, fall: 0.77, winter: 0.73
                        };

                        const hourlyPercentages = SEASONAL_DEMAND_PROFILES[profileName] || SEASONAL_DEMAND_PROFILES[`${baseSeason}-high`];
                        const scalingFactor = profileType === 'typical' ? TYPICAL_DAY_SCALING_FACTORS[baseSeason] || 1.0 : 1.0;
                        const peakLoadMW = countryData.peakLoadsMW[baseSeason] || countryData.peakLoadsMW.summer;
                        const peakPercentage = Math.max(...hourlyPercentages);
                        currentDemand = hourlyPercentages.map(pct => (pct / peakPercentage) * (peakLoadMW / 1000) * scalingFactor);
                    }
                }

                currentCountryInstalledCapacity = {};
                for (const tech in COST_DATA.capacity_factor) {
                    const techCapacityGW = (countryData.totalCapacityMW / 1000) * ((countryData.mix[tech] || 0) / 100);
                    currentCountryInstalledCapacity[tech] = techCapacityGW;
                }

                currentBaselineStorage = countryData.storageGWh || {};

                const potentialGeneration = {};
                for (const tech in currentCountryInstalledCapacity) {
                    potentialGeneration[tech] = Array(24).fill(0);
                    const cf = COST_DATA.capacity_factor[tech];
                    let capacity = currentCountryInstalledCapacity[tech];

                    if (tech === 'solar') {
                        for (let i = 0; i < 24; i++) potentialGeneration.solar[i] = capacity * currentSolarCFProfile[i];
                    } else if (tech === 'wind') {
                        for (let i = 0; i < 24; i++) potentialGeneration.wind[i] = capacity * currentWindCFProfile[i];
                    } else if (tech === 'offshoreWind') {
                        for (let i = 0; i < 24; i++) potentialGeneration.offshoreWind[i] = capacity * currentOffshoreWindCFProfile[i];
                    } else if (tech === 'hydro') {
                        for (let i = 0; i < 24; i++) potentialGeneration.hydro[i] = capacity;
                    } else if (tech === 'naturalGas' || tech === 'coal') {
                        for (let i = 0; i < 24; i++) potentialGeneration[tech][i] = capacity * 1.0;
                    } else {
                        for (let i = 0; i < 24; i++) potentialGeneration[tech][i] = capacity * cf;
                    }
                }
                BASELINE_POTENTIAL_GENERATION = potentialGeneration;

                Object.keys(sliders).forEach(key => {
                    sliders[key].value = 0;
                    inputs[key].value = 0;
                });

                sliders.carbonTax.value = newCarbonTax;
                inputs.carbonTax.value = newCarbonTax;

                const newExportPrice = countryData.defaultExportPrice ?? 20;
                sliders.exportPrice.value = newExportPrice;
                inputs.exportPrice.value = newExportPrice;

                const allTechs = [...Object.keys(COST_DATA.capacity_factor), 'battery4hr', 'battery8hr', 'longduration'];
                allTechs.forEach(tech => {
                    const checkbox = document.getElementById(`toggle-${tech}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        enabledTechnologies[tech] = true;
                    }
                });

                // Construct 12-month profiles for baseline calculation (matching runSimulation logic)
                const baseProfiles = {
                    solar: (countryProfiles[countryName] || countryProfiles.default).solar,
                    wind: (countryProfiles[countryName] || countryProfiles.default).wind,
                    offshoreWind: (countryProfiles[countryName] || countryProfiles.default).offshoreWind
                };

                const fullSolarProfile = [];
                const fullWindProfile = [];
                const fullOffshoreWindProfile = [];
                const fullDemand = [];
                let fullPotentialGeneration = {};
                for (const tech in BASELINE_POTENTIAL_GENERATION) {
                    fullPotentialGeneration[tech] = [];
                }

                const userSeasonMap = [
                    'winter', 'winter', 'spring', 'spring', 'spring',
                    'summer', 'summer', 'summer', 'summer', 'fall', 'fall', 'winter'
                ];

                const isHighDemand = profileName.toLowerCase().includes('high');

                for (let m = 0; m < 12; m++) {
                    const season = userSeasonMap[m];
                    const seasonalMultipliers = SEASONAL_MULTIPLIERS[season] || { solar: 1.0, wind: 1.0, offshoreWind: 1.0 };

                    const sSolar = baseProfiles.solar.map(cf => Math.min(1, cf * seasonalMultipliers.solar));
                    const sWind = baseProfiles.wind.map(cf => Math.min(1, cf * seasonalMultipliers.wind));
                    const sOffshoreWind = baseProfiles.offshoreWind.map(cf => Math.min(1, cf * seasonalMultipliers.offshoreWind));

                    fullSolarProfile.push(...sSolar);
                    fullWindProfile.push(...sWind);
                    fullOffshoreWindProfile.push(...sOffshoreWind);

                    const demandType = isHighDemand ? 'high' : 'typical';
                    const demandKey = `${season}-${demandType}`;
                    const sDemand = SEASONAL_DEMAND_PROFILES[demandKey] || SEASONAL_DEMAND_PROFILES[`${season}-high`] || Array(24).fill(30);
                    fullDemand.push(...sDemand);

                    // Duplicate potential generation for all 12 months
                    for (const tech in BASELINE_POTENTIAL_GENERATION) {
                        fullPotentialGeneration[tech].push(...(BASELINE_POTENTIAL_GENERATION[tech] || Array(24).fill(0)));
                    }
                }

                currentDemand = fullDemand; // Update global currentDemand

                const baselineResult = getSimulationResult(
                    {
                        capacity: { solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, nuclear: 0, biomass: 0, rng: 0, hydrogen: 0, battery4hr: 0, battery8hr: 0, longduration: 0, dac: 0, demandflex: 0 },
                        incentives: { solar: 0, wind: 0, offshoreWind: 0, geothermal: 0, nuclear: 0, biomass: 0, rng: 0, hydrogen: 0, storage: 0, dac: 0, carbonTax: newCarbonTax, exportPrice: newExportPrice }
                    },
                    fullSolarProfile,
                    fullWindProfile,
                    fullOffshoreWindProfile,
                    fullPotentialGeneration,
                    currentBaselineStorage,
                    currentHydroCF,
                    countryName
                );
                customBaselineSystemCost = baselineResult.systemCost;
                customBaselineConsumerCost = calculateAnnualConsumerCost(baselineResult.hourlyMarginalPrice, baselineResult.demand); // NEW
                // Calculate yearly CO2 by multiplying each hour by days in that month
                let co2Total = 0;
                baselineResult.emissions.forEach((value, i) => {
                    const monthIndex = Math.floor(i / 24) % 12;
                    co2Total += value * DAYS_IN_MONTH[monthIndex];
                });
                customBaselineTotalAnnualCO2 = co2Total;

                systemDefaultState = {};
                for (const key in sliders) {
                    systemDefaultState[key] = sliders[key].value;
                }
                systemDefaultState.enabledTech = { ...enabledTechnologies };
                userDefaultState = {};

                let totalDefaultCapacity = 0;
                for (const tech in currentCountryInstalledCapacity) {
                    defaultCapacityMix[tech] = currentCountryInstalledCapacity[tech];
                    totalDefaultCapacity += currentCountryInstalledCapacity[tech];
                }

                if (totalDefaultCapacity > 0) {
                    for (const tech in defaultCapacityMix) {
                        defaultCapacityMix[tech] = (defaultCapacityMix[tech] / totalDefaultCapacity) * 100;
                    }
                }

                let totalDefaultGeneration = 0;
                for (const tech in baselineResult.generation) {
                    if (tech !== 'curtailment' && !tech.includes('ToStorage')) {
                        // Calculate yearly generation by multiplying each hour by days in that month
                        let gen = 0;
                        baselineResult.generation[tech].forEach((value, i) => {
                            const monthIndex = Math.floor(i / 24) % 12;
                            gen += value * DAYS_IN_MONTH[monthIndex];
                        });
                        defaultGenerationMix[tech] = gen;
                        totalDefaultGeneration += gen;
                    }
                }
                if (totalDefaultGeneration > 0) {
                    for (const tech in defaultGenerationMix) {
                        defaultGenerationMix[tech] = (defaultGenerationMix[tech] / totalDefaultGeneration) * 100;
                    }
                }
                runSimulation();
            }

            countrySelect.addEventListener('change', (e) => {
                applySeason(currentSystemDefaultProfileName);
            });

            document.addEventListener('mousemove', (e) => {
                hoverTooltip.style.left = e.pageX + 15 + 'px';
                hoverTooltip.style.top = e.pageY + 15 + 'px';
            });

            gridMixSlidersContainer.addEventListener('mouseover', (e) => {
                const row = e.target.closest('.mix-slider-row');
                if (!row) return;
                const tech = row.dataset.tech;
                if (!tech) return;

                const baselineCapacity = currentCountryInstalledCapacity[tech] || 0;
                const newCapacity = (sliders[tech] ? parseFloat(sliders[tech].value) : 0) || 0;
                const totalCapacity = baselineCapacity + newCapacity;

                hoverTooltip.innerHTML = `Total Capacity: ${totalCapacity.toFixed(2)} GW`;
                hoverTooltip.classList.remove('hidden');
            });
            gridMixSlidersContainer.addEventListener('mouseout', () => {
                hoverTooltip.classList.add('hidden');
            });

            generationMixSlidersContainer.addEventListener('mouseover', (e) => {
                const row = e.target.closest('.mix-slider-row');
                if (!row) return;
                const tech = row.dataset.tech;
                if (!tech || yearlyGenerationTotalsGWh[tech] === undefined) return;

                const totalGWh = yearlyGenerationTotalsGWh[tech];
                const label = tech === 'curtailment' ? 'Total Yearly Curtailment' : 'Total Yearly Generation';
                hoverTooltip.innerHTML = `${label}: ${totalGWh.toFixed(2)} GWh`;
                hoverTooltip.classList.remove('hidden');
            });
            generationMixSlidersContainer.addEventListener('mouseout', () => {
                hoverTooltip.classList.add('hidden');
            });


            // --- INPUT SYNCING ---
            // This function connects sliders and input boxes to runSimulation
            function setupInputSyncing() {
                console.log('DEBUG: setupInputSyncing called');
                console.log('DEBUG: sliders object has keys:', Object.keys(sliders));

                // Debounce function to limit how often simulation runs during rapid slider movements
                let debounceTimeout = null;
                const debouncedRunSimulation = () => {
                    if (debounceTimeout) clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        console.log('DEBUG: Running simulation after debounce');
                        runSimulation();
                    }, 150); // 150ms debounce - adjust as needed for responsiveness
                };

                // Connect each slider and input pair
                let connectedCount = 0;
                for (const key in sliders) {
                    if (sliders[key] && inputs[key]) {
                        connectedCount++;
                        // Slider -> Input sync + run simulation
                        sliders[key].addEventListener('input', (e) => {
                            inputs[key].value = e.target.value;
                            debouncedRunSimulation();
                        });

                        // Input -> Slider sync + run simulation  
                        inputs[key].addEventListener('input', (e) => {
                            // Handle empty or invalid input - treat as 0
                            const value = parseFloat(e.target.value);
                            if (isNaN(value) || e.target.value === '') {
                                sliders[key].value = 0;
                            } else {
                                sliders[key].value = value;
                            }
                            debouncedRunSimulation();
                        });

                        // On blur (focus lost), save state for undo/redo
                        sliders[key].addEventListener('change', () => {
                            saveState();
                        });
                        inputs[key].addEventListener('change', () => {
                            saveState();
                        });
                    } else {
                        console.warn(`DEBUG: Missing element for key "${key}": slider=${!!sliders[key]}, input=${!!inputs[key]}`);
                    }
                }
                console.log(`DEBUG: Connected ${connectedCount} slider/input pairs`);
            }

            // --- TUTORIAL LOGIC ---
            const tutorialSteps = [
                {
                    title: 'Welcome to the Grid Simulator!',
                    text: 'This interactive tool lets you explore pathways to a zero-carbon electricity grid. Let\'s take a quick tour of the main features.',
                    position: 'center'
                },
                {
                    element: '#tutorial-step-2',
                    title: 'Live Simulation Charts',
                    text: 'These charts show the real-time results of your decisions. See how the generation mix and CO2 emissions change as you adjust the levers.',
                    position: 'right',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#tutorial-step-3',
                    title: 'Your Control Panel',
                    text: 'This is where you make things happen! Use these sliders to deploy new technologies, set government incentives, and choose a starting grid mix.',
                    position: 'left',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#tutorial-step-4',
                    title: 'Manage Existing Resources',
                    text: 'Use these checkboxes to turn off an existing resource type and watch the impact it has on emissions and costs.',
                    position: 'right',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#make-default-button',
                    title: 'Save Your Scenario',
                    text: 'Once you find a set of policies you like, you can save them as your new default. The cost metrics will then be calculated relative to this new baseline.',
                    position: 'top',
                    highlightClass: 'rounded-full'
                },
                {
                    element: '#tutorial-step-5',
                    title: 'Key Outcome Metrics',
                    text: 'Your goal is to get CO2 emissions to zero while keeping costs low. These cards show the impact on electricity bills and the cost of avoiding CO2.',
                    position: 'bottom',
                    highlightClass: 'rounded-lg'
                },
                {
                    element: '#edit-demand-btn',
                    title: 'Customize Demand',
                    text: 'Click the edit icon to create your own custom daily demand profile, or select a seasonal preset.',
                    position: 'left',
                    highlightClass: 'rounded-full'
                },
                {
                    element: '#edit-cf-btn',
                    title: 'Customize Weather',
                    text: 'Click this edit icon to change the hourly performance of solar and wind to simulate different weather conditions.',
                    position: 'top',
                    highlightClass: 'rounded-full'
                }
            ];

            let currentStep = 0;
            const overlay = document.getElementById('tutorial-overlay');
            const popover = document.getElementById('tutorial-popover');
            const titleEl = document.getElementById('tutorial-title');
            const textEl = document.getElementById('tutorial-text');
            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');
            const skipBtn = document.getElementById('tutorial-skip');
            let highlightedElement = null;

            function startTutorial() {
                if (localStorage.getItem('gridSimulatorTutorialSeen')) {
                    return;
                }
                document.body.classList.add('tutorial-active');
                currentStep = 0;
                showTutorialStep(currentStep);
            }

            function endTutorial() {
                document.body.classList.remove('tutorial-active');
                overlay.style.display = 'none';
                popover.style.display = 'none';
                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight-active', 'rounded-full', 'rounded-lg');
                }
                localStorage.setItem('gridSimulatorTutorialSeen', 'true');
            }

            function positionPopover(targetElement, popoverEl, position) {
                popoverEl.style.visibility = 'hidden';
                popoverEl.style.display = 'block';

                const popoverRect = popoverEl.getBoundingClientRect();
                const margin = 15;

                if (position === 'center' || !targetElement) {
                    popoverEl.style.left = '50%';
                    popoverEl.style.top = '50%';
                    popoverEl.style.transform = 'translate(-50%, -50%)';
                    popoverEl.style.visibility = 'visible';
                    return;
                }

                const targetRect = targetElement.getBoundingClientRect();
                let top, left;

                switch (position) {
                    case 'top':
                        top = targetRect.top - popoverRect.height - margin;
                        left = targetRect.left + (targetRect.width / 2) - (popoverRect.width / 2);
                        break;
                    case 'bottom':
                        top = targetRect.bottom + margin;
                        left = targetRect.left + (targetRect.width / 2) - (popoverRect.width / 2);
                        break;
                    case 'left':
                        top = targetRect.left - popoverRect.width - margin;
                        left = targetRect.top + (targetRect.height / 2) - (popoverRect.height / 2);
                        break;
                    case 'right':
                    default:
                        top = targetRect.top + (targetRect.height / 2) - (popoverRect.height / 2);
                        left = targetRect.right + margin;
                        break;
                }

                if (top < margin) top = margin;
                if (left < margin) left = margin;
                if (left + popoverRect.width > window.innerWidth - margin) {
                    left = window.innerWidth - popoverRect.width - margin;
                }
                if (top + popoverRect.height > window.innerHeight - margin) {
                    top = window.innerHeight - popoverRect.height - margin;
                }

                popoverEl.style.top = `${top}px`;
                popoverEl.style.left = `${left}px`;
                popoverEl.style.transform = 'none';
                popoverEl.style.visibility = 'visible';
            }

            function showTutorialStep(stepIndex) {
                if (stepIndex < 0 || stepIndex >= tutorialSteps.length) {
                    endTutorial();
                    return;
                }

                const step = tutorialSteps[stepIndex];

                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight-active', 'rounded-full', 'rounded-lg');
                    highlightedElement = null;
                }

                titleEl.textContent = step.title;
                textEl.textContent = step.text;

                let targetElement;
                if (step.element) {
                    targetElement = document.querySelector(step.element);
                }

                if (targetElement) {
                    overlay.style.display = 'none';
                    highlightedElement = targetElement;
                    highlightedElement.classList.add('tutorial-highlight-active');
                    if (step.highlightClass) {
                        highlightedElement.classList.add(step.highlightClass);
                    }

                    highlightedElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                    setTimeout(() => {
                        positionPopover(highlightedElement, popover, step.position);
                    }, 400);
                } else {
                    overlay.style.display = 'block';
                    positionPopover(null, popover, 'center');
                }

                prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-block';
                nextBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Finish' : 'Next';
            }

            nextBtn.addEventListener('click', () => {
                currentStep++;
                showTutorialStep(currentStep);
            });

            prevBtn.addEventListener('click', () => {
                currentStep--;
                showTutorialStep(currentStep);
            });

            skipBtn.addEventListener('click', endTutorial);

            startTutorialBtn.addEventListener('click', () => {
                localStorage.removeItem('gridSimulatorTutorialSeen');
                startTutorial();
            });


            // --- MAIN INITIALIZATION FUNCTION ---
            async function initialize() {
                // Load California seasonal profiles from JSON
                try {
                    const response = await fetch('../grid-operator/seasonal_profiles.json');
                    const profilesData = await response.json();
                    CALIFORNIA_PROFILES = profilesData.california.profiles;
                    console.log('Loaded California profiles from JSON:', Object.keys(CALIFORNIA_PROFILES));
                } catch (error) {
                    console.error('Error loading California profiles from JSON:', error);
                    console.log('Falling back to scaling method for California');
                }

                try {
                    await signInAnonymously(auth);
                    console.log("Firebase authentication successful.");
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    visitorCountEl.textContent = "Auth Failed";
                    return;
                }

                const counterRef = doc(db, `artifacts/${appId}/public/data/counters/visitor_counter`);
                try {
                    const newCount = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        if (!counterDoc.exists()) {
                            transaction.set(counterRef, { count: 1 });
                            return 1;
                        }
                        const newCount = counterDoc.data().count + 1;
                        transaction.update(counterRef, { count: newCount });
                        return newCount;
                    });
                    visitorCountEl.textContent = newCount.toLocaleString();
                } catch (e) {
                    console.error("Firestore transaction failed: ", e);
                    visitorCountEl.textContent = "DB Error";
                }

                createGridMixSliders();
                createGenerationMixSliders();
                populateCountryDropdown();
                applySeason('spring-typical');
                setupInputSyncing();

                setTimeout(startTutorial, 500);
            }

            await initialize();
        });
    </script>

    <!-- Magnifying glass for capacity factor editing (positioned at body level for correct fixed positioning) -->
    <div id="cf-magnifier" class="hidden" style="position: fixed; pointer-events: none; z-index: 9999; width: 200px; height: 200px; border: 3px solid #4B5563; border-radius: 50%; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); background: white;">
        <canvas id="cf-magnifier-canvas" width="200" height="200"></canvas>
    </div>
</body>

>>>>>>> a27dc23 (Temp Stash for Rebase)
</html>
